<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Specialist Dashboard - Online Blood Sugar Monitor</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .logout-btn {
      background: #cc0000;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      color: white;
    }
    .logout-btn:hover { background: #ff3333; }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 15px;
    }
    h1, h2, h3, h4, p {
      margin: 0 0 15px 0;
    }
    .dashboard-section {
      margin-top: 30px;
    }

    .patient-search {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .patient-search input,
    .patient-search button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .patient-search button {
      background: #004080;
      color: white;
      border: none;
      cursor: pointer;
    }
    .patient-search button:hover {
      background: #0066cc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #004080;
      color: white;
    }
    tr:hover {
      background: #f1f1f1;
      cursor: pointer;
    }

    #statusMsg {
      margin-top: 10px;
      color: #666;
      font-size: 0.95rem;
    }

    footer {
      background: #004080;
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="specialist.html">Specialist Login</a></li>
        <li><a href="specialist_dashboard.html" class="active">Dashboard</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li style="margin-left:auto;">
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <h1>Welcome, <span id="specialistNameDisplay">Specialist</span></h1>
    <p>View your patientsâ€™ latest updates and access their detailed health records.</p>

    <div class="dashboard-section">
      <h2>Patient List</h2>
      <div class="patient-search">
        <input type="text" id="search-name" placeholder="Search by Name">
        <input type="text" id="search-number" placeholder="Search by Patient ID">
        <input type="date" id="start-date">
        <input type="date" id="end-date">
        <button id="search-btn">Search</button>
        <button id="reset-btn">Reset</button>
      </div>

      <table id="patient-table">
        <thead>
          <tr>
            <th>Patient Number</th>
            <th>Name</th>
            <th>Last Checked</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p id="statusMsg"></p>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
  </footer>

  <script>
  const API_BASE = 'http://127.0.0.1:5000';

  // ============================
  // AUTH / BASIC INFO
  // ============================
  const loggedInSpecialist = localStorage.getItem('specialistUsername');
  if (!loggedInSpecialist) {
    // Not logged in, send back to login page
    window.location.href = 'specialist.html';
  }

  const specialistName =
    localStorage.getItem('specialistFullName') || 'Specialist';
  const specialistNameDisplay = document.getElementById('specialistNameDisplay');
  if (specialistNameDisplay) {
    specialistNameDisplay.textContent = specialistName;
  }

  // This ID is stored in specialist.html login script
  const specialistId = localStorage.getItem('specialistId') || '3';

  const tableBody = document.querySelector('#patient-table tbody');
  let patientsCache = [];

  function renderTable(data) {
    if (!tableBody) return;

    tableBody.innerHTML = '';
    if (!data || data.length === 0) {
      tableBody.innerHTML =
        '<tr><td colspan="3">No patients assigned in database.</td></tr>';
      return;
    }

    data.forEach(p => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${p.number}</td>
        <td>${p.name}</td>
        <td>${p.lastChecked}</td>
      `;

      // When you click a patient row, go to patient detail page
      row.addEventListener('click', () => {
        localStorage.setItem('viewingPatientNumber', p.number);
        localStorage.setItem('viewingPatientName', p.name);
        localStorage.setItem('viewingPatientUserId', p.userId);
        localStorage.setItem('viewingPatientId', p.patientId);
        window.location.href = 'specialist_patient_view.html';
      });

      tableBody.appendChild(row);
    });
  }

  // ============================
  // LOAD PATIENTS FROM BACKEND
  // ============================
  async function loadPatientsFromServer() {
    if (!tableBody) return;

    try {
      const res = await fetch(
        `${API_BASE}/api/specialist/${specialistId}/patients`
      );
      if (!res.ok) {
        throw new Error(`Server responded ${res.status}`);
      }

      const data = await res.json();
      // data.patients is an array of rows from the DB:
      // patient_id, user_id, first_name, last_name, last_date_time, ...
      const mapped = (data.patients || []).map(p => ({
        patientId: p.patient_id,
        userId: p.user_id,
        number: p.patient_id, // Using patient_id as "Patient Number"
        name: `${p.first_name} ${p.last_name}`,
        lastChecked: p.last_date_time
          ? String(p.last_date_time).split('T')[0]
          : 'Not available'
      }));

      patientsCache = mapped;
      renderTable(mapped);
      localStorage.setItem('patients', JSON.stringify(mapped));
    } catch (err) {
      console.error('Error loading patients from server:', err);
      tableBody.innerHTML =
        '<tr><td colspan="3">Error loading patients from server.</td></tr>';
    }
  }

  // Load on page start
  loadPatientsFromServer();

  // ============================
  // SEARCH / FILTER (local only)
  // ============================
  const searchNameInput = document.getElementById('search-name');
  const searchNumberInput = document.getElementById('search-number');
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const searchBtn = document.getElementById('search-btn');
  const resetBtn = document.getElementById('reset-btn');

  if (searchBtn) {
    searchBtn.addEventListener('click', () => {
      const nameVal = (searchNameInput?.value || '').toLowerCase();
      const numberVal = (searchNumberInput?.value || '').toLowerCase();
      const startDate = startDateInput?.value || '';
      const endDate = endDateInput?.value || '';

      const filtered = patientsCache.filter(p => {
        const matchName = p.name.toLowerCase().includes(nameVal);
        const matchNumber = String(p.number).toLowerCase().includes(numberVal);
        const matchDate =
          (!startDate || p.lastChecked >= startDate) &&
          (!endDate || p.lastChecked <= endDate);
        return matchName && matchNumber && matchDate;
      });

      renderTable(filtered);
    });
  }

  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (searchNameInput) searchNameInput.value = '';
      if (searchNumberInput) searchNumberInput.value = '';
      if (startDateInput) startDateInput.value = '';
      if (endDateInput) endDateInput.value = '';
      renderTable(patientsCache);
    });
  }

  // ============================
  // LOGOUT
  // ============================
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('specialistUsername');
      localStorage.removeItem('specialistFullName');
      localStorage.removeItem('specialistSpecialty');
      localStorage.removeItem('specialistId');
      window.location.href = 'specialist.html';
    });
  }
</script>

</body>
</html>
