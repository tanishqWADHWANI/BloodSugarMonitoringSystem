<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Staff — Email Patients</title>
  <link rel="stylesheet" href="css/style.css">
    <!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Staff — Email Patients</title>
      <link rel="stylesheet" href="css/style.css">
      <script src="js/api.js"></script>
      <script src="js/demo_users.js"></script>
    <style>
      .email-container { max-width:900px; margin:28px auto; padding:18px; }
      .card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
      label{display:block;margin-top:12px;font-weight:600}
      select,input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
      .actions{display:flex;gap:10px;margin-top:12px}
      .btn-primary{background:#004080;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
      .btn-ghost{background:transparent;border:1px solid #ccc;padding:10px 14px;border-radius:6px;cursor:pointer}
    </style>
  </head>
  <body>
    <main class="email-container">
      <div class="card">
        <h1>Email Patients</h1>
        <p style="color:#444">Choose a patient to message. Unsent messages will be queued locally.</p>

        <form id="emailForm">
          <label for="toSelect">To (patient)</label>
          <select id="toSelect" required></select>

          <label for="subject">Subject</label>
          <input id="subject" type="text" placeholder="Subject" required />

          <label for="message">Message</label>
          <textarea id="message" rows="8" placeholder="Write your message to the patient..." required></textarea>

          <div class="actions">
            <button class="btn secondary" id="sendBtn" type="submit">Send</button>
            <button class="btn-ghost" id="cancelBtn" type="button">Cancel</button>
          </div>
        </form>

        <div id="statusMsg" style="margin-top:12px;color:#333"></div>

        <p style="margin-top:18px"><a href="staff_dashboard.html">Back to Dashboard</a></p>
      </div>
    </main>

    <script>
      (function(){
        // Ensure demo patient exists
        try{
          const key='patients'; const raw = localStorage.getItem(key); const arr = raw?JSON.parse(raw):null; const exists = Array.isArray(arr) && arr.some(p=> (p.number==='001' || p.id==='001' || p.patientId==='001'));
          if(!exists){ const demo={ number:'001', name:'John Doe', age:35, gender:'Male', phone:'555-1234', medical_history:'Diabetes, Hypertension', lastChecked:'Blood Sugar: 140 mg/dL', id:'001', patientId:'001' }; const out = Array.isArray(arr)? [demo, ...arr] : [demo]; localStorage.setItem(key, JSON.stringify(out)); }
        }catch(e){}

        let patients = [];
        try { patients = JSON.parse(localStorage.getItem('patients') || '[]'); } catch(e){ patients = []; }
        if (!Array.isArray(patients) || patients.length === 0) {
          patients = [ { id:201, full_name:'Jane Doe', email:'jane@demo' }, { id:202, full_name:'Bob Ray', email:'bob@demo' } ];
        }
        const select = document.getElementById('toSelect');
        patients.forEach(p => { const opt=document.createElement('option'); opt.value = p.email || p.id; opt.textContent = p.full_name || p.name || opt.value; select.appendChild(opt); });
      })();

      document.getElementById('emailForm').addEventListener('submit', async function(ev){
        ev.preventDefault();
        const to = document.getElementById('toSelect').value;
        const subject = document.getElementById('subject').value.trim();
        const message = document.getElementById('message').value.trim();
        const status = document.getElementById('statusMsg'); status.textContent='';

        const payload = { to, subject, message, source: 'staff', subtype: 'patient' };
        try {
          await (window.bsm_api && window.bsm_api.sendEmail ? window.bsm_api.sendEmail(payload) : Promise.reject(new Error('no-api')));
          status.style.color='green'; status.textContent='Email sent successfully.';
        } catch (err) {
          try { const raw = localStorage.getItem('pending_emails') || '[]'; const arr = JSON.parse(raw); arr.push(payload); localStorage.setItem('pending_emails', JSON.stringify(arr)); status.style.color='orange'; status.textContent='Server unreachable — email queued locally.'; } catch(e){ status.style.color='red'; status.textContent='Failed to send or queue email.'; }
        }
      });

      document.getElementById('cancelBtn').addEventListener('click', ()=> window.location.href='staff_dashboard.html');
    </script>
  </body>
  </html>
          const raw = localStorage.getItem('pending_emails') || '[]';
          const arr = JSON.parse(raw);
          arr.push(payload);
          localStorage.setItem('pending_emails', JSON.stringify(arr));
          status.style.color = 'orange';
          status.textContent = 'Server unreachable — email queued locally.';
        } catch (e) {
          status.style.color = 'red';
          status.textContent = 'Failed to send or queue email.';
        }
      }
    });

    document.getElementById('cancelBtn').addEventListener('click', function () { window.location.href = 'staff_dashboard.html'; });
  </script>
</body>
</html>