<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Details - Online Blood Sugar Monitor</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .logout-btn {
      background:#cc0000;
      border:none;
      border-radius:5px;
      padding:8px 12px;
      cursor:pointer;
      color:white;
    }
    .logout-btn:hover { background:#ff3333; }

    .container { max-width:1100px; margin:20px auto; padding:0 15px; }
    h1,h2,h3,h4,p { margin-bottom:10px; }

    .section-card {
      background:white;
      border-radius:8px;
      box-shadow:0 3px 8px rgba(0,0,0,0.1);
      padding:20px;
      margin-bottom:25px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
    }
    th, td {
      border:1px solid #ccc;
      padding:8px;
      text-align:left;
    }
    th {
      background:#004080;
      color:white;
    }

    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px,1fr));
      gap:10px;
    }
    .info-item {
      background:#f9f9f9;
      border:1px solid #ddd;
      border-radius:6px;
      padding:10px;
    }

    /* Comments */
    #comment-text {
      width:100%;
      padding:10px;
      border-radius:5px;
      border:1px solid #ccc;
      resize:vertical;
      min-height:80px;
    }
    #save-comment {
      margin-top:10px;
      padding:8px 15px;
      background:#004080;
      color:white;
      border:none;
      border-radius:5px;
      cursor:pointer;
    }
    #save-comment:hover { background:#0066cc; }
    #comment-list {
      list-style:none;
      padding:0;
      margin-top:10px;
    }
    #comment-list li {
      background:#f2f4f8;
      border-left:4px solid #004080;
      margin-bottom:8px;
      padding:8px;
      border-radius:4px;
    }

    footer {
      background:#004080;
      color:white;
      text-align:center;
      padding:10px;
      margin-top:40px;
    }
    .back-btn {
      background:#999;
      color:white;
      padding:8px 12px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      margin-bottom:15px;
    }
    .back-btn:hover { background:#777; }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="specialist_dashboard.html" class="active">Dashboard</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li style="margin-left:auto;">
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <button class="back-btn" onclick="window.location.href='specialist_dashboard.html'">
      &larr; Back to Dashboard
    </button>

    <h1>Patient: <span id="patientName"></span></h1>
    <p>Patient ID: <span id="patientNumber"></span></p>

    <!-- PERSONAL INFO -->
    <section class="section-card">
      <h2>Personal Information</h2>
      <div class="info-grid" id="personal-info">
        <!-- filled by JS -->
      </div>
    </section>

    <!-- HEALTH DATA -->
    <section class="section-card">
      <h2>Health Data History</h2>
      <table id="health-data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Blood Pressure</th>
            <th>Heart Rate</th>
            <th>Medications</th>
            <th>Food Time</th>
            <th>Food Taken</th>
            <th>Activity / Notes</th>
          </tr>
        </thead>
        <tbody>
          <!-- filled by JS -->
        </tbody>
      </table>
      <p id="health-msg" style="margin-top:10px; color:#666;"></p>
    </section>

    <!-- COMMENTS -->
    <section class="section-card">
      <h2>Specialist Comments</h2>
      <textarea id="comment-text" placeholder="Add a comment about this patient's readings..."></textarea>
      <button id="save-comment">Save Comment</button>

      <h3 style="margin-top:20px;">Previous Comments</h3>
      <ul id="comment-list"></ul>
      <p id="comment-msg" style="margin-top:10px; color:#666;"></p>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
  </footer>

  <script>
    (function () {
      // Same base as specialist.html
      const API_BASE = 'http://127.0.0.1:5000/api';

      const patientNumber = localStorage.getItem('viewingPatientNumber');
      const patientName = localStorage.getItem('viewingPatientName');
      const token = localStorage.getItem('specialistToken') || null;
      const specialistFullName = localStorage.getItem('specialistFullName') || 'Specialist';

      // Require specialist login
      if (!localStorage.getItem('specialistUsername')) {
        alert('Please log in as specialist first.');
        window.location.href = 'specialist.html';
        return;
      }

      // Require a selected patient
      if (!patientNumber || !patientName) {
        alert('No patient selected. Redirecting...');
        window.location.href = 'specialist_dashboard.html';
        return;
      }

      // Fill basic header
      document.getElementById('patientNumber').textContent = patientNumber;
      document.getElementById('patientName').textContent = patientName;

      const personalInfoEl = document.getElementById('personal-info');
      const healthTbody = document.querySelector('#health-data-table tbody');
      const healthMsgEl = document.getElementById('health-msg');
      const commentList = document.getElementById('comment-list');
      const commentMsg = document.getElementById('comment-msg');
      const commentText = document.getElementById('comment-text');
      const saveCommentBtn = document.getElementById('save-comment');

      function buildAuthHeaders() {
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        return headers;
      }

      // ============================
      // LOAD PERSONAL INFO
      // ============================
      async function loadPersonalInfo() {
        try {
          const res = await fetch(`${API_BASE}/specialist/patients/${encodeURIComponent(patientNumber)}`, {
            headers: buildAuthHeaders()
          });

          if (!res.ok) {
            throw new Error('Failed to load personal info');
          }

          const data = await res.json();
          const p = data.patient || data || {};
          const age = p.age || 'Not provided';
          const gender = p.gender || 'Not provided';
          const email = p.email || 'Not provided';
          const phone = p.phone || 'Not provided';
          const address = p.address || 'Not provided';

          personalInfoEl.innerHTML = `
            <div class="info-item"><strong>Age:</strong> ${age}</div>
            <div class="info-item"><strong>Gender:</strong> ${gender}</div>
            <div class="info-item"><strong>Email:</strong> ${email}</div>
            <div class="info-item"><strong>Phone:</strong> ${phone}</div>
            <div class="info-item"><strong>Address:</strong> ${address}</div>
          `;
        } catch (err) {
          console.error(err);
          personalInfoEl.innerHTML = `
            <div class="info-item">
              Unable to load personal information from server.
            </div>
          `;
        }
      }

      // ============================
      // LOAD HEALTH DATA
      // ============================
      async function loadHealthData() {
        healthMsgEl.textContent = 'Loading health data from server...';
        healthTbody.innerHTML = '';

        try {
          const res = await fetch(
            `${API_BASE}/specialist/patients/${encodeURIComponent(patientNumber)}/readings`,
            { headers: buildAuthHeaders() }
          );

          if (!res.ok) {
            throw new Error('Failed to load health data');
          }

          const data = await res.json();
          const readings = data.readings || data || [];

          if (!Array.isArray(readings) || readings.length === 0) {
            healthTbody.innerHTML = `
              <tr><td colspan="8">No health data recorded yet.</td></tr>
            `;
            healthMsgEl.textContent = '';
            return;
          }

          healthTbody.innerHTML = readings.map(entry => `
            <tr>
              <td>${entry.date || '-'}</td>
              <td>${entry.time || '-'}</td>
              <td>${entry.blood_pressure || entry.bloodPressure || '-'}</td>
              <td>${entry.heart_rate || entry.heartRate || '-'}</td>
              <td>${entry.medications || '-'}</td>
              <td>${entry.food_time || entry.foodTime || '-'}</td>
              <td>${entry.food_taken || entry.foodTaken || '-'}</td>
              <td>${entry.activity || entry.notes || '-'}</td>
            </tr>
          `).join('');
          healthMsgEl.textContent = '';
        } catch (err) {
          console.error(err);
          healthTbody.innerHTML = `
            <tr><td colspan="8">Error loading health data from server.</td></tr>
          `;
          healthMsgEl.textContent = 'Could not load health data. Please try again later.';
        }
      }

      // ============================
      // LOAD COMMENTS
      // ============================
      async function loadComments() {
        commentMsg.textContent = 'Loading comments...';
        commentList.innerHTML = '';

        try {
          const res = await fetch(
            `${API_BASE}/specialist/patients/${encodeURIComponent(patientNumber)}/comments`,
            { headers: buildAuthHeaders() }
          );

          if (!res.ok) {
            throw new Error('Failed to load comments');
          }

          const data = await res.json();
          const comments = data.comments || data || [];

          if (!Array.isArray(comments) || comments.length === 0) {
            commentList.innerHTML = '<li>No comments yet.</li>';
            commentMsg.textContent = '';
            return;
          }

          commentList.innerHTML = comments.map(c => {
            const author = c.author || c.specialist_name || specialistFullName;
            const ts = c.timestamp || c.created_at || '';
            const text = c.text || c.comment || '';
            return `<li><strong>${author}</strong>${ts ? ' (' + ts + ')' : ''}: ${text}</li>`;
          }).join('');
          commentMsg.textContent = '';
        } catch (err) {
          console.error(err);
          commentList.innerHTML = '<li>Error loading comments from server.</li>';
          commentMsg.textContent = 'Could not load comments. Please try again later.';
        }
      }

      // ============================
      // SAVE COMMENT
      // ============================
      saveCommentBtn.addEventListener('click', async () => {
        const text = (commentText.value || '').trim();
        if (!text) return;

        commentMsg.textContent = 'Saving comment...';

        try {
          const res = await fetch(
            `${API_BASE}/specialist/patients/${encodeURIComponent(patientNumber)}/comments`,
            {
              method: 'POST',
              headers: buildAuthHeaders(),
              body: JSON.stringify({ text: text })
            }
          );

          if (!res.ok) {
            throw new Error('Failed to save comment');
          }

          commentText.value = '';
          await loadComments();
          commentMsg.textContent = 'Comment saved.';
        } catch (err) {
          console.error(err);
          commentMsg.textContent = 'Error saving comment. Please try again.';
        }
      });

      // ============================
      // LOGOUT
      // ============================
      document.getElementById('logoutBtn').addEventListener('click', e => {
        e.preventDefault();
        localStorage.removeItem('specialistId');
        localStorage.removeItem('specialistUsername');
        localStorage.removeItem('specialistFullName');
        localStorage.removeItem('specialistSpecialty');
        localStorage.removeItem('specialistToken');
        localStorage.removeItem('viewingPatientNumber');
        localStorage.removeItem('viewingPatientName');
        alert('You have been logged out.');
        window.location.href = 'specialist.html';
      });

      // Initial loads
      loadPersonalInfo();
      loadHealthData();
      loadComments();
    })();
  </script>
</body>
</html>
