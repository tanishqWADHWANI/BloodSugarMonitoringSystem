<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient History - Blood Sugar Monitor</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api.js"></script>
  <script src="js/demo_users.js"></script>

  <style>
   
    main {
      background: white;
      margin: 20px auto;
      padding: 20px;
      max-width: 1000px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #004080;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    .controls label {
      font-weight: bold;
    }

    .controls select,
    .controls input {
      padding: 5px;
    }

    .chart-container {
      position: relative;
      height: 400px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #004080;
      color: white;
    }

    .abnormal {
      color: #dc3545;
      font-weight: bold;
    }

    .abnormal-row {
      background-color: #ffe6e6 !important;
      border-left: 4px solid #dc3545;
    }

    .abnormal-row:hover {
      background-color: #ffd4d4 !important;
    }

    .footer {
      text-align: center;
      padding: 10px;
      color: #555;
      background: #f0f0f0;
    }
    
    #logout-btn, #logoutBtn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
    } 

    #logout-btn:hover, #logoutBtn:hover {
      background: #c82333;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="patient_dashboard.html">Dashboard</a></li>
        <li><a href="patient_history.html" class="active">History</a></li>
        <li style="margin-left:auto;"><button id="logoutBtn">Logout</button></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>Patient History</h1>
    <p>View and analyze your past health readings below. You can select a date range, or filter by daily, weekly, monthly, or yearly trends.</p>
    
    <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin-bottom:20px;border-radius:6px;">
      <strong>üìå Note:</strong> This page automatically loads your health history. If you don't see data, make sure you have entries saved in your dashboard.
      <button onclick="location.href='patient_dashboard.html'" style="margin-left:10px;padding:8px 16px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;">Go to Dashboard</button>
    </div>

    <!-- Controls -->
    <div class="controls">
      <label for="viewSelect">View:</label>
      <select id="viewSelect">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>

      <label for="monthSelect">Month:</label>
      <select id="monthSelect">
        <option value="">All Months</option>
      </select>

      <label for="startDate">From:</label>
      <input type="date" id="startDate">

      <label for="endDate">To:</label>
      <input type="date" id="endDate">

      <button id="applyFilter">Apply</button>
      <button id="resetFilter">Reset</button>
    </div>

    <!-- Chart -->
    <div class="chart-container">
      <canvas id="bloodSugarChart"></canvas>
    </div>

    <!-- Table -->
    <table id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Blood Sugar (mg/dL)</th>
          <th>Blood Pressure</th>
          <th>Heart Rate</th>
          <th>Medications</th>
          <th>Food Time</th>
          <th>Food Taken</th>
          <th>Activity / Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <div class="footer">
    &copy; 2025 Online Blood Sugar Monitoring Clinic
  </div>

 <script>
  // --- utilities ---
  // Get the active user ID from localStorage or URL parameter
  function activeUserId() {
    // First check URL parameter
    const p = new URLSearchParams(window.location.search);
    const q = p.get('user_id');
    if (q) return q;
    
    // Then check localStorage for logged in patient
    const userId = localStorage.getItem('userId');
    if (userId) return userId;
    
    const patientId = localStorage.getItem('patientId');
    if (patientId) return patientId;
    
    // Fallback to prompt only if nothing found
    return window.prompt('Enter Patient User ID to view history:');
  }

   function mapToRows(readingArray) {
    const arr = Array.isArray(readingArray) ? readingArray : [];

    return arr.map(r => {
      // Backend stores timestamp in "date_time" column, plus some fallbacks
      const ts = r.date_time || r.timestamp || r.time || r.created_at;
      let date = '', time = '';

      if (ts) {
        const d = new Date(ts);
        if (!Number.isNaN(d.getTime())) {
          // Normalise to YYYY-MM-DD and HH:MM
          date = d.toISOString().slice(0, 10);
          time = d.toTimeString().slice(0, 5);
        }
      }

      // If backend already gave separate date/time fields, use them as fallback
      if (!date && r.date) date = r.date;
      if (!time && r.time) time = r.time;

      // Blood sugar value is stored as "value" in DB, but we support other keys too
      const blood = r.value
                 ?? r.bloodSugar
                 ?? r.blood_sugar
                 ?? r.reading
                 ?? '-';

      return {
        date,
        time,
        bloodSugar: blood,
        bloodPressure: r.bloodPressure || '-',
        heartRate: r.heartRate || '-',
        medications: r.medications || '-',
        foodTime: r.food_time || r.foodTime || '-',
        foodTaken: r.food_intake || r.foodTaken || '-',
        activity: r.activity || r.symptoms_notes || r.additional_note || '-'
      };
    }).filter(e => e.date); // ensure each row has a date for grouping/filters
  }
  // --- grouping for the chart only (table shows raw rows) ---
  function startOfWeekISO(d) {
    const copy = new Date(d);
    const day = copy.getDay();            // 0=Sun..6=Sat
    const diff = (day === 0 ? -6 : 1) - day; // shift to Monday as week start
    copy.setDate(copy.getDate() + diff);
    copy.setHours(0,0,0,0);
    return copy;
  }

  function groupForChart(rows, view) {
    if (!rows.length || view === 'daily') {
      // daily: each row is a point; if multiple per day, show the last one
      const byDay = {};
      rows.forEach(r => {
        if (!byDay[r.date]) byDay[r.date] = [];
        byDay[r.date].push(Number(r.bloodSugar));
      });
      const labels = Object.keys(byDay).sort();
      const data = labels.map(k => {
        const vals = byDay[k].filter(Number.isFinite);
        if (!vals.length) return null;
        // average per day
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      });
      return { labels, data };
    }

    // weekly / monthly / yearly
    const buckets = {};
    rows.forEach(r => {
      const d = new Date(r.date);
      if (isNaN(d)) return;
      let key;
      if (view === 'weekly') {
        key = startOfWeekISO(d).toISOString().slice(0,10); // week start date
      } else if (view === 'monthly') {
        key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      } else if (view === 'yearly') {
        key = `${d.getFullYear()}`;
      } else {
        key = r.date; // fallback
      }
      if (!buckets[key]) buckets[key] = [];
      const v = Number(r.bloodSugar);
      if (Number.isFinite(v)) buckets[key].push(v);
    });

    const labels = Object.keys(buckets).sort();
    const data = labels.map(k => {
      const vals = buckets[k];
      return vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length) : null;
    });
    return { labels, data };
  }

  // Helper function to check if values are abnormal
  function isAbnormalBloodSugar(value) {
    const num = parseFloat(value);
    return !isNaN(num) && (num < 70 || num > 130);
  }

  function isAbnormalBloodPressure(value) {
    if (value === '-' || !value) return false;
    const parts = String(value).split('/');
    if (parts.length !== 2) return false;
    const systolic = parseFloat(parts[0]);
    const diastolic = parseFloat(parts[1]);
    return (!isNaN(systolic) && (systolic < 90 || systolic > 130)) ||
           (!isNaN(diastolic) && (diastolic < 60 || diastolic > 85));
  }

  function isAbnormalHeartRate(value) {
    const num = parseFloat(value);
    return !isNaN(num) && (num < 60 || num > 80);
  }

  function renderTable(rows) {
    const tbody = document.querySelector('#historyTable tbody');
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center">No readings.</td></tr>`;
      return;
    }
    // sort ascending by date then time
    const sorted = [...rows].sort((a,b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : (a.time > b.time ? 1 : -1)));
    tbody.innerHTML = sorted.map(e => {
      const bsAbnormal = isAbnormalBloodSugar(e.bloodSugar);
      const bpAbnormal = isAbnormalBloodPressure(e.bloodPressure);
      const hrAbnormal = isAbnormalHeartRate(e.heartRate);
      const hasAbnormal = bsAbnormal || bpAbnormal || hrAbnormal;
      
      const rowClass = hasAbnormal ? ' class="abnormal-row"' : '';
      const warningIcon = hasAbnormal ? '‚ö†Ô∏è ' : '';
      const bsClass = bsAbnormal ? ' class="abnormal"' : '';
      const bpClass = bpAbnormal ? ' class="abnormal"' : '';
      const hrClass = hrAbnormal ? ' class="abnormal"' : '';
      
      return `
      <tr${rowClass}>
        <td>${warningIcon}${e.date||'-'}</td><td>${e.time||'-'}</td>
        <td${bsClass}>${e.bloodSugar}</td><td${bpClass}>${e.bloodPressure}</td>
        <td${hrClass}>${e.heartRate}</td><td>${e.medications}</td>
        <td>${e.foodTime}</td><td>${e.foodTaken}</td>
        <td>${e.activity}</td>
      </tr>`).join('');
  }

  // chart instance holder
  let bloodSugarChartInstance = null;

  function renderChart(rows, view) {
    const ctx = document.getElementById('bloodSugarChart').getContext('2d');

    // If we already have a chart instance, destroy it before creating a new one
    if (bloodSugarChartInstance) {
      bloodSugarChartInstance.destroy();
    }

    const { labels, data } = groupForChart(rows, view);

    // Create and save the new instance
    bloodSugarChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Average Blood Sugar (mg/dL)',
          data,
          borderWidth: 2,
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Period' } },
          y: { title: { display: true, text: 'mg/dL' } }
        }
      }
    });
  }

  function populateMonthSelect(rows) {
    const sel = document.getElementById('monthSelect');
    const months = [...new Set(rows.map(r => r.date).filter(Boolean).map(d => d.slice(0,7)))].sort();
    months.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      sel.appendChild(opt);
    });
  }

  function applyFiltersTo(rows) {
    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;
    const month = document.getElementById('monthSelect').value;
    const view  = document.getElementById('viewSelect').value;

    let f = [...rows];
    if (start) { const S = new Date(start); f = f.filter(r => r.date && new Date(r.date) >= S); }
    if (end)   { const E = new Date(end);   f = f.filter(r => r.date && new Date(r.date) <= E); }
    if (month) f = f.filter(r => r.date && r.date.startsWith(month));

    renderTable(f);
    renderChart(f, view);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const userId = activeUserId();
      if (!userId) {
        alert('Could not determine user ID. Please log in again.');
        window.location.href = 'patient.html';
        return;
      }

      console.log('Loading history for user ID:', userId);
      console.log('Database connected: Flask server should be running on http://127.0.0.1:5000');
      
      let rows = [];
      
      // ALWAYS load from API/database - no localStorage fallback
      try {
        console.log(`Fetching readings from: /api/readings/${userId}?days=30`);
        const apiReadings = await getReadings(userId);  // from js/api.js
        console.log('API Response:', apiReadings);
        rows = mapToRows(apiReadings);
        console.log('‚úì Loaded ' + rows.length + ' entries from database');
        
        if (rows.length === 0) {
          console.warn('‚ö†Ô∏è Database returned 0 entries for user_id:', userId);
          console.warn('This means Alice has no data in the bloodsugarreadings table.');
          console.warn('Solution: Visit the Dashboard - it will auto-create 8 demo entries on first visit.');
        }
      } catch (apiError) {
        console.error('‚ùå Failed to connect to database:', apiError);
        console.error('Please ensure:');
        console.error('1. Flask server is running: cd backend && python app.py');
        console.error('2. MySQL/XAMPP is running');
        console.error('3. Database blood_sugar_db exists');
        
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:#dc3545;">
          <strong>‚ùå Database Connection Failed</strong><br><br>
          Error: ${apiError.message}<br><br>
          <strong>To fix this:</strong><br>
          1. Ensure Flask server is running: <code>cd backend && python app.py</code><br>
          2. Ensure MySQL/XAMPP is running<br>
          3. Check browser console (F12) for detailed error messages
        </td></tr>`;
        return;
      }

      if (rows.length === 0) {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;">
          <strong>No health history found in database.</strong><br><br>
          <p>This is normal for new accounts. Your demo data will be created automatically.</p>
          <p><strong>Next step:</strong> Go to your <a href="patient_dashboard.html" style="color:#004080;text-decoration:underline;font-weight:bold;">Dashboard</a> 
          - it will automatically create 8 sample health entries with abnormal readings for testing.</p>
          <p style="margin-top:15px;font-size:0.9em;color:#666;">After visiting the dashboard, refresh this page to see your health history.</p>
        </td></tr>`;
        return;
      }

      populateMonthSelect(rows);

      document.getElementById('applyFilter').addEventListener('click', () => applyFiltersTo(rows));
      document.getElementById('resetFilter').addEventListener('click', () => {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('monthSelect').value = '';
        document.getElementById('viewSelect').value = 'daily';
        applyFiltersTo(rows);
      });

      // Also update instantly when the view dropdown changes
      document.getElementById('viewSelect').addEventListener('change', () => applyFiltersTo(rows));

      applyFiltersTo(rows); // initial render
    } catch (err) {
      console.error(err);
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:red">Failed to load readings: ${err.message}</td></tr>`;
    }
    
    //logout behavior
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('loggedInPatient');
        window.location.href = 'index.html';
      });
    }
  });
</script>
</body>
</html>
