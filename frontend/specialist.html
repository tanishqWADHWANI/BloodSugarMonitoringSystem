<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Specialist Portal</title>

  <link rel="stylesheet" href="css/style.css" />
  <script src="js/api.js"></script>
  <script src="js/demo_users.js"></script>

  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .section-box {
      background-color: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .login-section {
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
      margin-bottom: 20px;
    }

    .login-section h2 {
      font-size: 2rem;
      color: #004080;
      margin-bottom: 20px;
    }

    .login-section label {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
      display: inline-block;
    }

    .login-section input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .login-section input[type="submit"] {
      background-color: #004080;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .login-section input[type="submit"]:hover {
      background-color: #003366;
    }

    .note {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #333;
    }

    .specialists-section h1 {
      font-size: 2rem;
      color: #004080;
      margin-bottom: 10px;
      text-align: center;
    }

    .specialists-section p {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .specialists {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
      padding: 20px 0;
    }

    .specialist-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 250px;
      text-align: center;
      padding: 20px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .specialist-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .specialist-card img {
      border-radius: 50%;
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin-bottom: 15px;
    }

    .specialist-card h3 {
      margin: 10px 0 5px 0;
      color: #004080;
    }

    .specialist-card p {
      font-size: 0.9rem;
      color: #333;
      margin-bottom: 5px;
    }

    .reviews {
      text-align: center;
      padding: 50px 20px;
      background-color: #f5f9fc;
      margin-top: 40px;
      border-radius: 10px;
    }

    .reviews h2 {
      font-size: 2rem;
      margin-bottom: 30px;
      color: #004080;
    }

    .review-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .review-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .review-card p {
      font-size: 0.95rem;
      color: #333;
    }

    .review-author {
      font-weight: bold;
      margin-top: 10px;
      color: #004080;
    }
  </style>
</head>

<body>
  <!-- HEADER / NAV -->
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="patient.html">Patient</a></li>
        <li><a href="specialist.html" class="active">Specialist</a></li>
        <li><a href="clinic.html">Clinic</a></li>
        <li><a href="contact.html">Contact Us</a></li>
      </ul>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="container">
    <!-- SPECIALIST LOGIN -->
    <section class="section-box login-section">
      <h2>Specialist Login</h2>

      <form id="specialistLoginForm" method="post" action="javascript:void(0);">
        <label for="specLoginId">Username or Email</label>
        <input
          type="text"
          id="specLoginId"
          name="specLoginId"
          placeholder="e.g., jsmith or jsmith@clinic.com"
          required
        >

        <label for="specLoginPassword">Password</label>
        <input
          type="password"
          id="specLoginPassword"
          name="specLoginPassword"
          placeholder="Enter your password"
          required
        >

        <input type="submit" value="Sign In">
      </form>

      <div id="specLoginMsg" style="color:red; margin-top:10px;"></div>
      <div id="apiDiagnostics" style="margin-top:10px;font-size:0.9rem;color:#333"></div>

      <p class="note">
        Demo specialists:<br>
        <strong>jsmith / smith123</strong> ·
        <strong>ajones / jones123</strong> ·
        <strong>clee / lee123</strong>
      </p>
    </section>

    <!-- SPECIALIST INFO / CARDS -->
    <section class="section-box specialists-section">
      <h1>Meet Our Specialists</h1>
      <p>Our team of expert doctors provides personalized guidance to help you manage your diabetes effectively.</p>

      <div class="specialists">
        <div class="specialist-card">
          <img src="pics/smith.jpg" alt="Dr. John Smith">
          <h3>Dr. John Smith</h3>
          <p>Endocrinologist</p>
          <p>10+ years experience helping patients manage diabetes with personalized care plans.</p>
        </div>

        <div class="specialist-card">
          <img src="pics/jones.jpg" alt="Dr. Alex Jones">
          <h3>Dr. Alex Jones</h3>
          <p>Diabetes Specialist</p>
          <p>Expert in lifestyle modification, glucose monitoring, and diet planning.</p>
        </div>

        <div class="specialist-card">
          <img src="pics/lee.jpg" alt="Dr. Christina Lee">
          <h3>Dr. Christina Lee</h3>
          <p>Nutritionist &amp; Endocrinologist</p>
          <p>Helps patients balance diet, exercise, and medication for optimal glucose control.</p>
        </div>
      </div>
    </section>

    <!-- REVIEWS -->
    <section class="section-box reviews">
      <h2>What Patients Say About Our Specialists</h2>
      <div class="review-cards">
        <div class="review-card">
          <p>"Dr. Smith guided me through every step of my diabetes management. I feel more confident and in control."</p>
          <p class="review-author">— Emily R.</p>
        </div>
        <div class="review-card">
          <p>"Dr. Jones' advice on diet and lifestyle has made a huge difference in my daily routine."</p>
          <p class="review-author">— David M.</p>
        </div>
        <div class="review-card">
          <p>"Dr. Lee is approachable and provides detailed explanations for every question I have."</p>
          <p class="review-author">— Sophia L.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-bottom">
      <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
    </div>
  </footer>
<script>
// Config
// Default API base: HTTP-only on port 5000. We allow overriding via
// `window.BSM_API_FALLBACK` or `localStorage.BSM_API_BASE` (useful for forwarded URLs).
// This project is configured to use HTTP for local development and testing.
const DEFAULT_API_BASE = `http://${window.location.hostname}:5000/api`;
// Load persisted override (if user pasted a forwarded URL)
try {
  const stored = localStorage.getItem('BSM_API_BASE');
  if (stored) window.BSM_API_FALLBACK = stored;
} catch (e) {
  console.warn('Could not read BSM_API_BASE from localStorage', e);
}

function apiBase() {
  // Return explicit override if present, otherwise use HTTP-only default.
  if (window.BSM_API_FALLBACK) return window.BSM_API_FALLBACK;
  try {
    const override = localStorage.getItem('BSM_API_BASE');
    if (override && override.length) return override;
  } catch (e) {
    // ignore
  }
  return DEFAULT_API_BASE;
}

// Specialist login handler — intercept form POST and call backend API
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('specialistLoginForm');
  const msg = document.getElementById('specLoginMsg');

    if (form) {
    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();
      msg.style.color = 'black';
      msg.textContent = 'Signing in...';

      const username = (document.getElementById('specLoginId').value || '').trim();
      const password = (document.getElementById('specLoginPassword').value || '').trim();

      if (!username || !password) {
        msg.style.color = 'red';
        msg.textContent = 'Username (or working_id/email) and password are required';
        return;
      }

      try {
        // Use hybrid specialist login helper (tries server, falls back to local demo)
        const resp = await window.bsm_api.specialistLogin(username, password);

        // Normalize token and user storage
        const token = resp && (resp.token || resp.access_token || (resp.user && resp.user.token));
        if (token) {
          try { localStorage.setItem('bsm_token', token); } catch (e) {}
        }

        if (resp && resp.user) {
          const u = resp.user;
          if (u.username) try { localStorage.setItem('specialistUsername', u.username); } catch(e) {}
          // Prefer provided fullName, fallback to first/last name if present
          if (u.fullName) {
            try { localStorage.setItem('specialistFullName', u.fullName); } catch(e) {}
          } else if (u.first_name || u.last_name) {
            const fn = ((u.first_name||'') + ' ' + (u.last_name||'')).trim();
            try { localStorage.setItem('specialistFullName', fn); } catch(e) {}
          }
          if (u.id !== undefined) try { localStorage.setItem('specialistId', String(u.id)); } catch(e) {}
        } else {
          // Ensure minimal demo keys when server response is not detailed
          const key = (username.split('@')[0] || username).toLowerCase();
          try { localStorage.setItem('specialistUsername', key); } catch(e) {}
          // Try to resolve a friendly full name from cached specialists (demo seeder)
          try {
            let specs = JSON.parse(localStorage.getItem('specialists') || '[]');
            if (specs && !Array.isArray(specs) && typeof specs === 'object') specs = Object.values(specs || {});
            if (Array.isArray(specs)) {
              const found = specs.find(s => (s.username && s.username.toLowerCase() === key) || (s.email && s.email.toLowerCase().startsWith(key)) || (s.full_name && s.full_name.toLowerCase().includes(key)) );
              if (found && (found.full_name || found.name)) {
                try { localStorage.setItem('specialistFullName', found.full_name || found.name); } catch(e) {}
              } else {
                try { localStorage.setItem('specialistFullName', key.charAt(0).toUpperCase() + key.slice(1)); } catch(e) {}
              }
            } else {
              try { localStorage.setItem('specialistFullName', key.charAt(0).toUpperCase() + key.slice(1)); } catch(e) {}
            }
          } catch (e) {
            try { localStorage.setItem('specialistFullName', key.charAt(0).toUpperCase() + key.slice(1)); } catch(e) {}
          }
          try { localStorage.setItem('specialistId', '0'); } catch(e) {}
        }

        msg.style.color = 'green';
        msg.textContent = 'Signed in. Redirecting...';
        setTimeout(() => { window.location.href = 'specialist_dashboard.html'; }, 300);
      } catch (err) {
        console.error('Specialist login failed', err);
        msg.style.color = 'red';
        msg.textContent = 'Login failed: ' + (err && err.message ? err.message : err);
      }
    });
  }
});

// Auto-login support for demo/testing: use `?autologin=jsmith` to auto-submit demo creds.
// Demo mapping (kept on client only for convenience in demo environment)
const DEMO_CREDS = {
  'jsmith': { username: 'jsmith', password: 'smith123' },
  'ajones': { username: 'ajones', password: 'jones123' },
  'clee': { username: 'clee', password: 'lee123' }
};

function tryAutoLogin() {
  try {
    const params = new URLSearchParams(window.location.search);
    const key = params.get('autologin');
    if (!key) return;
    const cred = DEMO_CREDS[key];
    if (!cred) return;

    // Fill form for visibility
    document.getElementById('specLoginId').value = cred.username;
    document.getElementById('specLoginPassword').value = cred.password;

    // Submit programmatically
    document.getElementById('specialistLoginForm').dispatchEvent(new Event('submit', { cancelable: true }));
  } catch (e) {
    console.error('Auto-login failed', e);
  }
}

// Attempt auto-login after DOMContent loaded
document.addEventListener('DOMContentLoaded', tryAutoLogin);

// Simplified diagnostics: show reachable / unreachable and a demo fallback message
async function runApiDiagnostics() {
  const diag = document.getElementById('apiDiagnostics');
  diag.textContent = 'Checking API...';
  const healthUrl = `${apiBase().replace('/api','')}/health`;
  try {
    const res = await fetch(healthUrl, { method: 'GET' });
    if (res.ok) {
      diag.innerHTML = `<span style="color:green">Backend reachable (${res.status}).</span>`;
      const banner = document.getElementById('serverModeBanner'); if (banner) banner.style.display = 'none';
    } else {
      diag.innerHTML = `<span style="color:orange">Backend responded ${res.status}. Using demo fallback.</span>`;
      const banner = document.getElementById('serverModeBanner'); if (banner) banner.style.display = 'block';
    }
  } catch (e) {
   // diag.innerHTML = `<span style="color:red">Backend unreachable — using demo fallback.</span>`;
    const banner = document.getElementById('serverModeBanner'); if (banner) banner.style.display = 'block';
  }
}

// Poll server mode periodically so the UI updates when backend mode changes
setInterval(() => {
  try {
    // reuse diagnostics call to refresh banner and DB indicator; don't await
    runApiDiagnostics();
  } catch (e) {
    console.warn('Periodic diagnostics failed', e);
  }
}, 30000); // every 30s

// Run diagnostics on load so users can see CORS/connection info immediately
document.addEventListener('DOMContentLoaded', runApiDiagnostics);

// Handle manual API override save button (delegated because input may be created dynamically)
document.addEventListener('click', function (ev) {
  if (ev.target && ev.target.id === 'bsmApiSave') {
    const input = document.getElementById('bsmApiOverride');
    if (!input) return;
    let val = input.value.trim();
    if (!val) return;
    // Normalize: if user pasted host without protocol, assume https for remote previews
    if (!/^https?:\/\//i.test(val)) {
      val = 'https://' + val;
    }
    // Ensure we store API base including /api
    if (!/\/api\/?$/.test(val)) val = val.replace(/\/$/, '') + '/api';
    window.BSM_API_FALLBACK = val;
    try { localStorage.setItem('BSM_API_BASE', val); } catch (e) { console.warn(e); }
    // Re-run diagnostics so UI updates and the new base is used
    runApiDiagnostics();
  }
  // Button: Reload page over HTTP when mixed-content detected
  if (ev.target && ev.target.id === 'bsmTryHttp') {
    try {
      const url = new URL(window.location.href);
      if (url.protocol === 'https:') {
        url.protocol = 'http:';
        // open in same tab to preserve context
        window.location.href = url.toString();
      }
    } catch (e) {
      console.warn('Could not reload over HTTP', e);
    }
  }

  // Button: focus the manual API override input so user can paste forwarded URL
  if (ev.target && ev.target.id === 'bsmFocusOverride') {
    const input = document.getElementById('bsmApiOverride');
    if (input) {
      input.focus();
    } else {
      // create input area if not present
      const diag = document.getElementById('apiDiagnostics');
      diag.insertAdjacentHTML('beforeend', `<div style="margin-top:12px;padding:10px;border:1px dashed #ccc;border-radius:6px;background:#fff"><input id="bsmApiOverride" placeholder="https://<forwarded-host> or http://127.0.0.1:5000" style="width:70%;padding:6px;margin-right:6px" /><button id="bsmApiSave">Use this API</button></div>`);
      setTimeout(()=>document.getElementById('bsmApiOverride').focus(),50);
    }
  }

  // Button: copy suggested forwarded URL to clipboard
  if (ev.target && ev.target.id === 'bsmCopySuggested') {
    const suggested = window.location.origin.replace(/^https:/, 'https:');
    // Guess a forwarded preview host pattern: user may need to adjust
    const text = suggested;
    try {
      navigator.clipboard.writeText(text).then(()=>{
        const help = document.getElementById('bsmMixedHelp');
        if (help) help.textContent = 'Suggested URL copied to clipboard. Paste into the override input and press "Use this API".';
      });
    } catch(e){
      const help = document.getElementById('bsmMixedHelp');
      if (help) help.textContent = 'Copy to clipboard failed; please manually copy: ' + text;
    }
  }

  // Button: open local HTTP served frontend (attempts 127.0.0.1:5500)
  if (ev.target && ev.target.id === 'bsmOpenLocal') {
    const localUrl = 'http://127.0.0.1:5500/specialist.html';
    // Quick reachability check: try fetch the document root, then open if ok
    fetch('http://127.0.0.1:5500/', { method: 'HEAD' }).then(r => {
      if (r.ok || r.status === 200 || r.status === 304) {
        window.open(localUrl, '_blank');
      } else {
        const help = document.getElementById('bsmMixedHelp');
        if (help) help.textContent = `Local server responded ${r.status}. Open ${localUrl} in new tab anyway.`;
        window.open(localUrl, '_blank');
      }
    }).catch(e => {
      const help = document.getElementById('bsmMixedHelp');
      if (help) help.textContent = `Local server not reachable at http://127.0.0.1:5500. Start one with: python3 -m http.server 5500 (run from the repo's frontend/ directory).`;
      // still attempt to open the URL — browser may show helpful error
      window.open(localUrl, '_blank');
    });
  }

  // Scheme selector buttons: Auto / Force HTTPS / Force HTTP
  if (ev.target && (ev.target.id === 'bsmSchemeAuto' || ev.target.id === 'bsmSchemeHttps' || ev.target.id === 'bsmSchemeHttp')) {
    try {
      let val = 'auto';
      if (ev.target.id === 'bsmSchemeHttps') val = 'https';
      if (ev.target.id === 'bsmSchemeHttp') val = 'http';
      localStorage.setItem('BSM_API_SCHEME', val);
      // Give quick feedback in the diagnostics box
      const help = document.getElementById('bsmMixedHelp');
      if (help) help.textContent = `Scheme preference saved: ${val}. Re-running diagnostics...`;
      // Re-run diagnostics to pick up the new preference
      setTimeout(()=>{ try { runApiDiagnostics(); } catch(e){} }, 200);
    } catch (e) {
      console.warn('Could not set BSM_API_SCHEME', e);
    }
  }
});

// Fetch and render readings for a user (userId = 1)
async function loadUserReadings(userId = 1, days = 30) {
  try {
    const res = await fetch(`${apiBase()}/readings/${userId}?days=${days}`);
    if (!res.ok) {
      const err = await res.json().catch(()=>({message:res.statusText}));
      throw new Error(err.error || err.message || 'Failed to fetch readings');
    }
    const payload = await res.json();
    const readings = payload.readings || [];

    // Example: render into a container `.readings-list` (create this element in HTML)
    let container = document.querySelector('.readings-list');
    if (!container) {
      container = document.createElement('div');
      container.className = 'readings-list';
      document.querySelector('main.container').appendChild(container);
    }
    container.innerHTML = '';

    if (readings.length === 0) {
      container.textContent = 'No readings found.';
      return;
    }

    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';

    readings.forEach(r => {
      const li = document.createElement('li');
      li.style.padding = '12px 8px';
      li.style.borderBottom = '1px solid #eee';

      const dt = new Date(r.date_time);
      const dtStr = isNaN(dt) ? r.date_time : dt.toLocaleString();

      li.innerHTML = `
        <strong>${r.value} ${r.unit || 'mg/dL'}</strong>
        <div style="font-size:0.9rem;color:#666">${dtStr} · status: ${r.status || 'normal'}</div>
        <div style="font-size:0.9rem;color:#333;margin-top:6px">${r.food_intake || r.event || ''}</div>
      `;
      ul.appendChild(li);
    });

    container.appendChild(ul);

  } catch (err) {
    console.error('loadUserReadings error', err);
  }
}

// call on page load
document.addEventListener('DOMContentLoaded', function () {
  loadUserReadings(1, 30);
});
</script>


</body>
</html>
