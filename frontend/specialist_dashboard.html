<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Specialist Dashboard - Online Blood Sugar Monitor</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
   
    .logout-btn {
      background: #dc3545; 
      border: none; 
      border-radius: 6px; 
      padding: 10px 20px; 
      cursor: pointer;
      color: white;
      font-weight: 500;
      font-size: 0.95rem;
    }
    .logout-btn:hover { background: #c82333; }

    .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
    h1, h2, h3, h4, p { margin: 0 0 15px 0; }
    .dashboard-section { margin-top: 30px; }

    .patient-search { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .patient-search input, .patient-search button {
      padding: 8px; border-radius: 5px; border: 1px solid #ccc;
    }
    .patient-search button {
      background: #004080; color: white; border: none; cursor: pointer;
    }
    .patient-search button:hover { background: #0066cc; }

    table {
      width: 100%; border-collapse: collapse; background: white; border-radius: 10px;
      overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #004080; color: white; }
    tr:hover { background: #f1f1f1; cursor: pointer; }

    footer { background: #004080; color: white; text-align: center; padding: 10px; margin-top: 40px; }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="specialist.html" class="active">Specialist</a></li>
		<li><a href="specialist_dashboard.html" class="active">Dashboard</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li style="margin-left:auto;">
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <h1>Welcome, <span id="specialistNameDisplay">Specialist</span></h1>
    <p>View your patients’ latest updates and access their detailed health records.</p>

    <div class="dashboard-section">
      <h2>Patient List</h2>
      <div class="patient-search">
        <input type="text" id="search-name" placeholder="Search by Name">
        <input type="text" id="search-number" placeholder="Search by Patient ID">
        <input type="date" id="start-date">
        <input type="date" id="end-date">
        <button id="search-btn">Search</button>
        <button id="reset-btn">Reset</button>
      </div>

      <table id="patient-table">
        <thead>
          <tr>
            <th>Patient Number</th>
            <th>Name</th>
            <th>Last Checked</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
  </footer>

  <script>
  const API_BASE = 'http://127.0.0.1:5000';

  // AUTH / BASIC INFO
  const loggedInSpecialist = localStorage.getItem('specialistUsername');
  if (!loggedInSpecialist) {
    // Not logged in, send back to login page
    window.location.href = 'specialist.html';
  }

  // Resolve specialist display info
  const storedUsername = (localStorage.getItem('specialistUsername') || '').toString().trim();
  let storedFull = (localStorage.getItem('specialistFullName') || '').toString().trim();
  const specialistDisplayMap = { 
    'jsmith': 'Dr. John Smith', 
    'ajones': 'Dr. Alex Jones', 
    'clee': 'Dr. Christina Lee' 
  };
  
  // Map usernames to actual user_ids in the database
  const usernameToUserIdMap = {
    'jsmith': 101,  // Dr. John Smith's user_id
    'ajones': 102,  // Dr. Alex Jones's user_id
    'clee': 103     // Dr. Christina Lee's user_id
  };
  
  let specialistName = 'Specialist';
  let specialistUserId = localStorage.getItem('specialistUserId') || '';
  let specialistId = localStorage.getItem('specialistId') || '';
  
  if (storedUsername) {
    const usernameLower = storedUsername.toLowerCase();
    if (specialistDisplayMap[usernameLower]) {
      specialistName = specialistDisplayMap[usernameLower];
      
      // Set the user_id for API calls
      if (usernameToUserIdMap[usernameLower]) {
        specialistUserId = String(usernameToUserIdMap[usernameLower]);
        localStorage.setItem('specialistUserId', specialistUserId);
      }
      
      // Keep old specialistId for compatibility
      const demoMap = { 'jsmith': 1, 'ajones': 2, 'clee': 3 };
      if (!specialistId && demoMap[usernameLower]) {
        specialistId = String(demoMap[usernameLower]);
        localStorage.setItem('specialistId', specialistId);
      }
    } else if (storedFull) {
      specialistName = storedFull;
    }
  } else if (storedFull) {
    specialistName = storedFull;
  }
  
  console.log('Specialist Info:', { 
    username: storedUsername, 
    name: specialistName, 
    userId: specialistUserId,
    oldId: specialistId 
  });
  
  const specialistNameDisplay = document.getElementById('specialistNameDisplay');
  if (specialistNameDisplay) {
    specialistNameDisplay.textContent = specialistName;
  }

  const tableBody = document.querySelector('#patient-table tbody');
  let patientsCache = [];

  function renderTable(data) {
    if (!tableBody) return;
    tableBody.innerHTML = '';
    if (!data || data.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">No patients assigned to you.</td></tr>';
      return;
    }
    data.forEach(p => {
      const row = document.createElement('tr');
      row.innerHTML = `\
        <td>${p.number || p.patient_id || ''}</td>\
        <td>${p.name || p.first_name + ' ' + p.last_name || ''}</td>\
        <td>${p.lastChecked || p.last_date_time || 'Not available'}</td>`;
      row.addEventListener('click', () => {
        try { localStorage.setItem('viewingPatientNumber', p.number || p.patient_id || ''); } catch(e){}
        try { localStorage.setItem('viewingPatientName', p.name || (p.first_name + ' ' + p.last_name) || ''); } catch(e){}
        try { localStorage.setItem('viewingPatientUserId', p.userId || p.user_id || ''); } catch(e){}
        try { localStorage.setItem('viewingPatientId', p.patientId || p.patient_id || p.id || ''); } catch(e){}
        window.location.href = 'specialist_patient_view.html';
      });
      tableBody.appendChild(row);
    });
  }

  // Load patients from server (filtered by specialist)
  async function loadPatientsFromServer() {
    // Use specialistUserId if available, otherwise fall back to specialistId
    const idToUse = specialistUserId || specialistId;
    
    if (!idToUse) {
      console.error('Missing specialist ID. Cannot load patients.');
      tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px; color: red;">Error: Specialist ID not found. Please log in again.</td></tr>';
      return;
    }

    try {
      console.log('Loading patients for specialist user_id:', idToUse);
      const res = await fetch(`${API_BASE}/api/specialist/${idToUse}/patients?t=${Date.now()}`, {
        headers: {
          'Accept': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('bsm_token') || ''}`,
          'Cache-Control': 'no-cache'
        }
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      console.log('API returned data:', data);
      
      const mapped = (data.patients || []).map(p => ({
        patientId: p.patient_id,
        userId: p.user_id,
        number: p.patient_id,
        name: `${p.first_name || ''} ${p.last_name || ''}`.trim(),
        lastChecked: p.last_date_time ? String(p.last_date_time).split('T')[0] : 'Not available'
      }));
      
      patientsCache = mapped;
      renderTable(mapped);
      console.log(`✅ Loaded ${mapped.length} patients for specialist user_id ${idToUse}:`, mapped);
    } catch(err) {
      console.warn('Server patient load failed:', err);
      // Fallback to localStorage if server fails
      loadPatientsFromLocalStorage();
    }
  }

  // Fallback to localStorage
  function loadPatientsFromLocalStorage() {
    try {
      let patients = JSON.parse(localStorage.getItem('patients') || '[]');
      if (!Array.isArray(patients) && typeof patients === 'object') {
        patients = Object.values(patients);
      }
      
      // Filter by assignments if available
      const assigns = JSON.parse(localStorage.getItem('assignments') || '[]');
      const idToUse = specialistUserId || specialistId;
      if (Array.isArray(assigns) && assigns.length > 0 && idToUse) {
        const myPatientIds = assigns
          .filter(a => String(a.specialistId) === String(idToUse))
          .map(a => String(a.patientId).toLowerCase());
        
        if (myPatientIds.length > 0) {
          patients = patients.filter(p => {
            const ids = [p.patientId, p.patient_id, p.number, p.userId, p.user_id, p.id]
              .map(x => String(x || '').toLowerCase());
            return ids.some(id => id && myPatientIds.includes(id));
          });
        }
      }
      
      const mapped = patients.map(p => ({
        patientId: p.patientId || p.patient_id || p.id,
        userId: p.userId || p.user_id,
        number: p.number || p.patient_id || p.id || '-',
        name: p.name || p.fullName || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'Unknown',
        lastChecked: p.lastChecked || p.last_date_time || 'Not available'
      }));
      
      patientsCache = mapped;
      renderTable(mapped);
    } catch(e) {
      console.error('Failed to load patients from localStorage:', e);
      tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">No patients found.</td></tr>';
    }
  }

  // Load on page start
  loadPatientsFromServer();

  // Search and Reset
  document.getElementById('search-btn').addEventListener('click', () => {
    const nameVal = document.getElementById('search-name').value.toLowerCase();
    const numberVal = document.getElementById('search-number').value.toLowerCase();
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    const filtered = patientsCache.filter(p => {
      const matchName = (p.name || '').toLowerCase().includes(nameVal);
      const matchNumber = String(p.number || '').toLowerCase().includes(numberVal);
      const matchDate = (!startDate || p.lastChecked >= startDate) && (!endDate || p.lastChecked <= endDate);
      return matchName && matchNumber && matchDate;
    });
    renderTable(filtered);
  });

  document.getElementById('reset-btn').addEventListener('click', () => {
    document.getElementById('search-name').value = '';
    document.getElementById('search-number').value = '';
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    renderTable(patientsCache);
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', e => {
    e.preventDefault();
    localStorage.removeItem('specialistUsername');
    localStorage.removeItem('specialistFullName');
    localStorage.removeItem('specialistSpecialty');
    localStorage.removeItem('specialistId');
    localStorage.removeItem('bsm_token');
    window.location.href = 'specialist.html';
  });
  </script>
</body>
</html>
