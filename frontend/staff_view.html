<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>View Patient Info</title>
<link rel="stylesheet" href="css/style.css">
<script src="js/demo_users.js"></script>
<style>
  
  h1 { color: #004080; margin-bottom: 20px; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .card h2 { margin-top: 0; color: #004080; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px; border-bottom: 1px solid #ccc; text-align: left; }
  th { background: #004080; color: white; }
  .btn { display: inline-block; margin: 10px 10px 0 0; padding: 10px 15px; background: #004080; color: white; border-radius: 8px; text-decoration: none; }
  .btn:hover { background: #0066cc; }
</style>
</head>
<body>

<header>
  <nav>
    <ul>
      <li><a href="staff_dashboard.html">Dashboard</a></li>
      <li><a href="patient_records.html">Patient Records</a></li>
      <li style="margin-left:auto;"><button id="logoutBtn" class="btn">Logout</button></li>
    </ul>
  </nav>
</header>

<main class="container">
  <h1>Patient Information</h1>

  <div class="card">
    <h2>Patient Details</h2>
    <table>
      <tr>
        <th>Patient Number</th>
        <td id="pNumber">001</td>
      </tr>
      <tr>
        <th>Full Name</th>
        <td id="pName">John Doe</td>
      </tr>
      <tr>
        <th>Age</th>
        <td id="pAge">45</td>
      </tr>
      <tr>
        <th>Gender</th>
        <td id="pGender">Male</td>
      </tr>
      <tr>
        <th>Contact</th>
        <td id="pContact">+1 234 567 890</td>
      </tr>
      <tr>
        <th>Assigned Specialist</th>
        <td id="pSpecialist">Dr. Christina Lee</td>
      </tr>
      <tr>
        <th>Medical History</th>
        <td id="pHistory">Type 2 Diabetes, Hypertension</td>
      </tr>
      <tr>
        <th>Last Test Results</th>
        <td id="pLastResults">Blood Sugar: 130 mg/dL, BP: 140/90 mmHg</td>
      </tr>
    </table>

    <div style="margin-top:20px;">
      <a class="btn" href="update_medical.html">Update Medical Info</a>
      <a class="btn" href="upload_test.html">Upload Test Results</a>
    </div>
  </div>
</main>

<footer>
<p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
</footer>
<script>
  (function () {
    // ============================
    // CONFIG
    // ============================
    const API_BASE = 'http://127.0.0.1:5000/api';

    // ============================
    // BASIC ACCESS CHECK
    // ============================
    const loggedStaff = localStorage.getItem('loggedInStaff');
    if (!loggedStaff) {
      alert('Please log in as staff first.');
      window.location.href = 'staff.html';
      return;
    }

    const patientNumber = localStorage.getItem('viewingPatientNumber');
    const patientName   = localStorage.getItem('viewingPatientName');

    const statusMsg     = document.getElementById('statusMsg');
    const pNumberEl     = document.getElementById('pNumber');
    const pNameEl       = document.getElementById('pName');
    const pAgeEl        = document.getElementById('pAge');
    const pGenderEl     = document.getElementById('pGender');
    const pContactEl    = document.getElementById('pContact');
    const pHistoryEl    = document.getElementById('pHistory');
    const pLastResultsEl= document.getElementById('pLastResults');
    const pSpecialistEl = document.getElementById('pSpecialist');
    const logoutBtn     = document.getElementById('logoutBtn');

    if (!patientNumber) {
      alert('No patient selected. Redirecting back to dashboard.');
      window.location.href = 'staff_dashboard.html';
      return;
    }

    pNumberEl.textContent = patientNumber;
    pNameEl.textContent   = patientName || '';

    function buildAuthHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('staffToken');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      return headers;
    }

    // ============================
    // LOAD PATIENT FROM BACKEND
    // ============================
    async function loadPatientDetails() {
      statusMsg.textContent = 'Loading patient details from server...';

      try {
        const res = await fetch(
          `${API_BASE}/staff/patients/${encodeURIComponent(patientNumber)}`,
          { headers: buildAuthHeaders() }
        );

        if (!res.ok) {
          throw new Error('Failed to load patient details');
        }

        const data = await res.json();
        const p = data.patient || data || {};

        const fullName      = p.full_name || p.name || patientName || 'Unknown';
        const age           = (p.age != null) ? p.age : 'Not provided';
        const gender        = p.gender || 'Not provided';
        const contact       = p.phone || p.contact || 'Not provided';
        const medicalHistory= p.medical_history || p.history || 'Not recorded';
        const lastResults   = p.last_results || p.last_test_results || '';

        pNameEl.textContent        = fullName;
        pAgeEl.textContent         = age;
        pGenderEl.textContent      = gender;
        pContactEl.textContent     = contact;
        pHistoryEl.textContent     = medicalHistory || 'Not recorded';
        pLastResultsEl.textContent = lastResults || 'No recent results recorded.';

        // Specialist handling info
        let specialistName = (p.assigned_specialist && (p.assigned_specialist.full_name || p.assigned_specialist.name)) || p.specialist_name || p.specialist || null;
        // If specialist id is present, try to resolve from localStorage.specialists
        try {
          if (!specialistName && p.assigned_specialist && p.assigned_specialist.id) {
            const specs = JSON.parse(localStorage.getItem('specialists') || '[]');
            const found = Array.isArray(specs) && specs.find(s => String(s.id) === String(p.assigned_specialist.id) || String(s.user_id) === String(p.assigned_specialist.id));
            if (found) specialistName = found.full_name || found.name || found.username;
          }
        } catch (e) { /* ignore */ }

        if (pSpecialistEl) pSpecialistEl.textContent = specialistName || 'Not assigned';

        statusMsg.textContent = '';
      } catch (err) {
        console.error(err);
        statusMsg.textContent =
          'Unable to load patient details from server. Showing basic info only.';
      }
    }

    // OPTIONAL SUMMARY (safe if it fails)
    async function loadPatientSummary() {
      try {
        const res = await fetch(
          `${API_BASE}/staff/patients/${encodeURIComponent(patientNumber)}/summary`,
          { headers: buildAuthHeaders() }
        );
        if (!res.ok) return;

        const data = await res.json();
        const history = data.medical_history || data.history || null;
        const results = data.last_results || data.last_test_results || null;

        if (history)  pHistoryEl.textContent     = history;
        if (results)  pLastResultsEl.textContent = results;
      } catch (err) {
        console.warn('Summary endpoint not available or failed.', err);
      }
    }

    // LOGOUT
    logoutBtn.addEventListener('click', e => {
      e.preventDefault();
      localStorage.removeItem('loggedInStaff');
      localStorage.removeItem('staffUsername');
      localStorage.removeItem('staffFullName');
      localStorage.removeItem('staffId');
      localStorage.removeItem('staffRole');
      localStorage.removeItem('staffToken');
      localStorage.removeItem('viewingPatientNumber');
      localStorage.removeItem('viewingPatientName');
      alert('You have been logged out.');
      window.location.href = 'staff.html';
    });

    // INIT
    loadPatientDetails();
    loadPatientSummary();
  })();
</script>

</body>
</html>
