<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient History - Blood Sugar Monitor</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api.js"></script>
  <script src="js/demo_users.js"></script>

  <style>
   
    main {
      background: white;
      margin: 20px auto;
      padding: 20px;
      max-width: 1000px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #004080;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    .controls label {
      font-weight: bold;
    }

    .controls select,
    .controls input {
      padding: 5px;
    }

    .chart-container {
      position: relative;
      height: 400px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #004080;
      color: white;
    }

    .abnormal {
      color: #dc3545;
      font-weight: bold;
    }

    .abnormal-row {
      background-color: #ffe6e6 !important;
      border-left: 4px solid #dc3545;
    }

    .abnormal-row:hover {
      background-color: #ffd4d4 !important;
    }

    .footer {
      text-align: center;
      padding: 10px;
      color: #555;
      background: #f0f0f0;
    }
    
    #logout-btn, #logoutBtn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
    } 

    #logout-btn:hover, #logoutBtn:hover {
      background: #c82333;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="patient_dashboard.html">Dashboard</a></li>
        <li><a href="patient_history.html" class="active">History</a></li>
        <li style="margin-left:auto;"><button id="logoutBtn">Logout</button></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>üìã My Complete Health History</h1>
    <p>View, edit, and manage all your recorded health entries. All your recorded entries are displayed here. Review patterns, edit recent entries, or remove incorrect data. Your specialist can see these entries to better understand your health trends.</p>
    
    <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin-bottom:20px;border-radius:6px;">
      <strong>üìå Note:</strong> This page displays your complete health history from the database. To add new entries, visit your dashboard.
      <button onclick="location.href='patient_dashboard.html'" style="margin-left:10px;padding:8px 16px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;">Go to Dashboard</button>
    </div>

    <!-- Health History Table -->
    <section style="background: white; padding: 30px; margin-bottom: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <div style="overflow-x: auto; margin-top: 20px;">
        <table id="entriesTable" style="width: 100%; border-collapse: collapse; background: white;">
          <thead>
            <tr style="background: linear-gradient(135deg, #004080, #0059b3); color: white;">
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">üìÖ Date</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">‚è∞ Time</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">ü©∏ Blood Sugar</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">üíì BP</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">‚ù§Ô∏è HR</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">üíä Medications</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">üçΩÔ∏è Meal Time</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">ü•ó Food</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">üìù Notes</th>
              <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd;">‚öôÔ∏è Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="footer">
    &copy; 2025 Online Blood Sugar Monitoring Clinic
  </div>

  <style>
    /* Table styles */
    #entriesTable tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s;
    }

    #entriesTable tbody tr:hover {
      background: #f8f9fa;
    }

    #entriesTable tbody td {
      padding: 12px 15px;
      color: #333;
      font-size: 0.9rem;
    }

    #entriesTable tbody tr.abnormal-row {
      background: #fff5f5;
    }

    #entriesTable tbody td.abnormal {
      color: #dc3545;
      font-weight: 600;
    }

    .edit-btn, .del-btn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .edit-btn {
      background: #17a2b8;
      color: white;
    }

    .edit-btn:hover {
      background: #138496;
    }

    .del-btn {
      background: #dc3545;
      color: white;
    }

    .del-btn:hover {
      background: #c82333;
    }
  </style>

 <script>
  const currentPatient = (localStorage.getItem('loggedInPatient') || 'patient').toLowerCase();
  const LS_KEY = 'health_' + currentPatient;

  const tbody = document.querySelector('#entriesTable tbody');

  // Load entries from localStorage
  function loadEntries() {
    try {
      const parsed = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  // Save entries to localStorage
  function saveEntries(entries) {
    localStorage.setItem(LS_KEY, JSON.stringify(entries));
  }

  // Helper functions to check abnormal values
  function isAbnormalBloodSugar(value) {
    const num = parseFloat(value);
    return !isNaN(num) && (num < 70 || num > 130);
  }

  function isAbnormalBloodPressure(value) {
    if (value === '-' || !value) return false;
    const parts = String(value).split('/');
    if (parts.length !== 2) return false;
    const systolic = parseFloat(parts[0]);
    const diastolic = parseFloat(parts[1]);
    return (!isNaN(systolic) && (systolic < 90 || systolic > 130)) ||
           (!isNaN(diastolic) && (diastolic < 60 || diastolic > 85));
  }

  function isAbnormalHeartRate(value) {
    const num = parseFloat(value);
    return !isNaN(num) && (num < 60 || num > 80);
  }

  // Render table (async to load from database)
  async function renderTable() {
    let rows = [];
    
    // Load from database
    const userId = localStorage.getItem('userId') || localStorage.getItem('patientId');
    if (userId) {
      try {
        const response = await fetch(`http://127.0.0.1:5000/api/readings/${userId}?days=365`);
        if (response.ok) {
          const data = await response.json();
          const dbReadings = data.readings || [];
          if (dbReadings.length > 0) {
            // Convert database format to table format and keep reading_id
            rows = dbReadings.map(r => ({
              reading_id: r.reading_id,  // Keep ID for delete operations
              date: r.date_time ? new Date(r.date_time).toISOString().split('T')[0] : '-',
              time: r.date_time ? new Date(r.date_time).toTimeString().slice(0,5) : '-',
              bloodSugar: r.value || '-',
              bloodPressure: r.bloodPressure || '-',
              heartRate: r.heart_rate || '-',
              medications: r.medications || '-',
              foodTime: r.food_time || r.food_intake || '-',
              foodTaken: r.food_intake || '-',
              activity: r.activity || r.symptoms_notes || '-'
            }));
            console.log('‚úì Loaded', rows.length, 'entries from database');
          }
        }
      } catch (e) {
        console.error('Could not load from database:', e);
      }
    }
    
    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;">
        <strong>No health history found.</strong><br><br>
        <p>Start tracking your health by adding entries in your <a href="patient_dashboard.html" style="color:#004080;text-decoration:underline;font-weight:bold;">Dashboard</a>.</p>
      </td></tr>`;
      return;
    }

    // Sort descending by date (newest first)
    rows.sort((a, b) => {
      if (a.date !== b.date) return b.date.localeCompare(a.date);
      return b.time.localeCompare(a.time);
    });

    tbody.innerHTML = rows.map((r, i) => {
      const bsAbnormal = isAbnormalBloodSugar(r.bloodSugar);
      const bpAbnormal = isAbnormalBloodPressure(r.bloodPressure);
      const hrAbnormal = isAbnormalHeartRate(r.heartRate);
      const hasAbnormal = bsAbnormal || bpAbnormal || hrAbnormal;
      
      const rowClass = hasAbnormal ? ' class="abnormal-row"' : '';
      const warningIcon = hasAbnormal ? '‚ö†Ô∏è ' : '';
      const bsClass = bsAbnormal ? ' class="abnormal"' : '';
      const bpClass = bpAbnormal ? ' class="abnormal"' : '';
      const hrClass = hrAbnormal ? ' class="abnormal"' : '';
      
      return `
      <tr${rowClass}>
        <td>${warningIcon}${r.date}</td>
        <td>${r.time}</td>
        <td${bsClass}>${r.bloodSugar}</td>
        <td${bpClass}>${r.bloodPressure || '-'}</td>
        <td${hrClass}>${r.heartRate || '-'}</td>
        <td>${r.medications || '-'}</td>
        <td>${r.foodTime || '-'}</td>
        <td>${r.foodTaken || '-'}</td>
        <td>${r.activity || '-'}</td>
        <td>
          <button type="button" class="edit-btn" data-readingid="${r.reading_id}">Edit</button>
          <button type="button" class="del-btn" data-readingid="${r.reading_id}">Delete</button>
        </td>
      </tr>
    `}).join('');
  }

  // Edit / Delete handlers
  tbody.addEventListener('click', async e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const readingId = btn.dataset.readingid;

    if (btn.classList.contains('del-btn')) {
      if (confirm('Delete this entry? This action cannot be undone.')) {
        try {
          // Delete from database using API
          await deleteReading(readingId);
          console.log('‚úì Entry deleted from database');
          alert('Entry deleted successfully.');
          // Refresh the table
          await renderTable();
        } catch (error) {
          console.error('Failed to delete entry:', error);
          alert('Failed to delete entry. Please try again.');
        }
      }
      return;
    }

    if (btn.classList.contains('edit-btn')) {
      alert('To edit this entry, please go to your Dashboard and add a corrected version. You can then delete this old entry.');
    }
  });

  // Initialize page - load and display all health history
  document.addEventListener('DOMContentLoaded', async () => {
    await renderTable();
    
    //logout behavior
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('loggedInPatient');
        localStorage.removeItem('userId');
        localStorage.removeItem('patientId');
        window.location.href = 'index.html';
      });
    }
  });
</script>
</body>
</html>
