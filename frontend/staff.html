<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Login</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Removed js/api.js to avoid old loginUser() conflicts -->
  <script src="js/api.js"></script>
  <script src="js/demo_users.js"></script>
</head>

<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="clinic.html">Clinic</a></li>
        <li><a href="staff.html" class="active">Staff</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <!-- ===========================
         Staff Login Form
    ============================ -->
    <section class="login-section card">
      <h1>Staff Login</h1>
      <p class="subtext">
        Log in with your staff credentials to access the clinic staff dashboard.
      </p>

      <!-- You can show demo account info right on the page -->
      <div class="info-box">
        <p><strong>Demo staff account:</strong></p>
        <ul>
          <li>Email: <code>staff2@test.com</code></li>
          <li>Password: <code>staff123</code></li>
        </ul>
      </div>

      <form id="staffLoginForm" novalidate>
        <div class="form-group">
          <label for="staffEmail">Email</label>
          <input
            type="text"
            id="staffEmail"
            name="staffEmail"
            required
            placeholder="Enter your staff email"
          />
        </div>

        <div class="form-group">
          <label for="staffPassword">Password</label>
          <input
            type="password"
            id="staffPassword"
            name="staffPassword"
            required
            placeholder="Enter your password"
          />
        </div>

        <p id="loginMsg" class="error-message"></p>

        <div class="button-row">
          <button type="submit">Login</button>
          <button type="button" id="demoStaffLogin">Demo Staff Login</button>
        </div>
      </form>
    </section>

    <!-- ===========================
         Staff Panel Info
    ============================ -->
    <section class="card">
      <h2>Staff Panel</h2>
      <p class="subtext">
        After login, you will be redirected to your staff dashboard.
      </p>
      <ul>
        <li>After logging in, you’ll be redirected to <code>staff_dashboard.html</code>.</li>
        <li>View and update patient records as permitted.</li>
        <li>Manage daily tasks, schedules, and clinic operations.</li>
        <li>Access reports and notifications relevant to your role.</li>
      </ul>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
  </footer>

<script>
// -----------------------------------------------------------
// FIXED API BASE: paste your Codespaces 5000 URL here
// -----------------------------------------------------------
const API_BASE = "https://5000-penjen30-bloodsugarmonitoringsystem-xxxxx.app.github.dev";
// ^^^^^^^^^^^^^^ REPLACE THIS WITH YOUR ACTUAL 5000 URL FROM PORTS TAB

// -----------------------------------------------------------
// Staff Login Handler (local, patient-style fallback)
// Uses the same simple localStorage-based login approach as `patient.html`.
// -----------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('staffLoginForm');
  const emailInput = document.getElementById('staffEmail');
  const passInput = document.getElementById('staffPassword');
  const msgBox = document.getElementById('loginMsg');
  const demoBtn = document.getElementById('demoStaffLogin');

  if (!form) return;

  function cap(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

  if (demoBtn) {
    demoBtn.addEventListener('click', () => {
      emailInput.value = 'staff2@test.com';
      passInput.value = 'staff123';
      if (msgBox) msgBox.textContent = '';
    });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (msgBox) msgBox.textContent = '';

    const email = (emailInput.value || '').trim();
    const pass = (passInput.value || '').trim();
    if (!email || !pass) {
      if (msgBox) msgBox.textContent = 'Enter email and password.';
      return;
    }

    try {
      // Try hybrid login (server first, fallback to demo)
      const resp = await window.bsm_api.loginUser(email, pass);

      // Persist token if provided
      const token = resp && (resp.token || resp.access_token);
      if (token) {
        try { localStorage.setItem('bsm_token', token); } catch(e) {}
      }

      // If backend response indicates non-demo, map to staff session
      if (resp && resp.user && (resp.user.role === 'staff' || resp.user.role === 'Staff' || resp.user.is_staff)) {
        const u = resp.user;
        const key = (u.email || u.username || email).split('@')[0];
        try { localStorage.setItem('loggedInStaff', key); } catch(e) {}
        try { localStorage.setItem('staffFullName', (u.firstName || u.first_name || key.charAt(0).toUpperCase()+key.slice(1))); } catch(e) {}
        try { localStorage.setItem('staffToken', token || ('local-demo-' + key)); } catch(e) {}
      } else if (resp && resp._localDemo) {
        // Hybrid fallback already stored patient keys; override for staff-specific keys
        const key = (email.split('@')[0] || 'staff').toLowerCase();
        try { localStorage.setItem('loggedInStaff', key); } catch(e) {}
        try { localStorage.setItem('staffFullName', cap(key)); } catch(e) {}
        try { localStorage.setItem('staffToken', 'local-demo-' + key); } catch(e) {}
      } else {
        // Unclear response: fall back to local demo staff session
        const key = (email.split('@')[0] || 'staff').toLowerCase();
        try { localStorage.setItem('loggedInStaff', key); } catch(e) {}
        try { localStorage.setItem('staffFullName', cap(key)); } catch(e) {}
        try { localStorage.setItem('staffToken', 'local-demo-' + key); } catch(e) {}
      }

      if (msgBox) msgBox.textContent = 'Signing in…';
      setTimeout(() => {
        window.location.href = 'staff_dashboard.html';
      }, 200);
    } catch (err) {
      console.error('Staff login failed', err);
      if (msgBox) msgBox.textContent = 'Login failed: ' + (err && err.message ? err.message : err);
    }
  });
});
</script>

</body>

</html>
