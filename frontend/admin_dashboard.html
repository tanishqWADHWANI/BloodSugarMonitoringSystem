<!--
  Blood Sugar Monitoring System - Admin Dashboard
  =================================================
  This is the main administrative interface for system administrators to manage users and view reports.
  
  Features Overview:
  - User Management (CRUD operations for all user types)
  - Patient-Specialist Assignment Management
  - System Reports (monthly/annual analytics)
  - User Statistics and Metrics
  - Bulk Operations
  - Demo Account Information
  
  Key Components:
  1. Navigation Bar - Home, Clinic, Logout
  2. Dashboard Header - Administrator title and subtitle
  3. User Management Section:
     - Create new users (patients, specialists, staff)
     - User form with role selection, name, email, password, phone
     - User list table (searchable, sortable)
     - Edit/Delete user actions
     - User statistics display
  
  4. Assignment Management:
     - Assign patients to specialists
     - View current assignments
     - Unassign functionality
     - Assignment history
  
  5. Reports Section:
     - Monthly report generation
     - Annual report generation
     - Report filters (date range, user type)
     - Export functionality
     - Visual charts and statistics
  
  6. System Statistics:
     - Total users by role
     - Active patients count
     - Specialist utilization
     - Recent activity log
  
  User Management Features:
  - Role-based user creation (patient, specialist, staff, admin)
  - Form validation (email format, required fields)
  - Password strength requirements
  - Unique email enforcement
  - Bulk user import (future enhancement)
  
  Assignment Features:
  - Dropdown patient selector
  - Dropdown specialist selector
  - One-to-many assignment (one specialist, multiple patients)
  - Assignment validation (prevent duplicates)
  - Visual assignment table
  
  Reports Features:
  - Monthly Summary:
    * New users registered
    * Total readings logged
    * Active patients count
    * Critical alerts generated
  - Annual Summary:
    * Yearly trends
    * User growth metrics
    * System usage statistics
  
  Security:
  - Admin role verification required
  - Token-based authentication
  - Automatic redirect to admin.html if unauthenticated
  - Admin token stored with "_admin" suffix
  - All operations require admin privileges
  
  Data Management:
  - Real-time API integration via api.js
  - LocalStorage for authentication state
  - Automatic data refresh after operations
  - Error handling with user-friendly messages
  
  Charts (Chart.js):
  - User growth line chart
  - User distribution pie chart
  - Monthly activity bar chart
  - Responsive canvas sizing
  
  Demo Accounts (displayed on page):
  - Admin: admin@example.com / admin123
  - Specialist: bob@bobsmith.com / password456
  - Patient: alice@johnson.com / password123
  - Staff: staff@example.com / staff123
  
  Related Files:
  - admin.html (login page)
  - user_management.html (dedicated user management interface)
  - patient_assignments.html (dedicated assignment management)
  - reports_management.html (dedicated reports interface)
  - js/api.js (API client library)
  - js/demo_users.js (demo account credentials)
  - css/style.css, css/dasshboard.css (stylesheets)
  
  External Dependencies:
  - Chart.js v3.x (data visualization)
  
  Page Size: 1755 lines (comprehensive admin interface)
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />  <!-- Main stylesheet -->
    <link rel="stylesheet" href="css/dasshboard.css" />  <!-- Dashboard-specific styles -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <!-- Chart.js for data visualization -->
    <script src="js/api.js"></script>  <!-- API client functions -->
    <script src="js/demo_users.js"></script>  <!-- Demo account credentials -->
</head>

<body>
    <!-- Top navigation bar -->
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>  <!-- Homepage link -->
                
                <li><a href="clinic.html">Clinic</a></li>  <!-- Clinic info page -->
                <li><button id="logoutBtn" class="logout-btn" style="background: #dc3545; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; color: white; font-weight: 500; font-size: 0.95rem;">Logout</button></li>  <!-- Logout button -->
            </ul>
        </nav>
    </header>

    <main class="container">
        <!-- Dashboard header with title and description -->
        <section class="dashboard-header">
            <h1 style="color: #004080; font-size: 2rem; margin-bottom: 10px;">Administrator ‚Äì User Management & Reports</h1>  <!-- Page title -->
            <p class="subtext" style="color: #666; font-size: 1rem;">
                Create and manage users, assign patients to specialists, and view a simple operational report.  <!-- Page description -->
            </p>
        </section>

        <!-- Admin Profile Section -->
        <section class="card" style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="adminProfileImage" src="" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none; border: 3px solid #004080;" />
                    <h2 style="color: #004080; font-size: 1.5rem; margin: 0;">üë§ My Profile</h2>
                </div>
                <button onclick="window.location.href='edit_profile_admin.html'" id="editAdminProfileBtn" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">‚úèÔ∏è Edit Profile</button>
            </div>

            <!-- Profile Display -->
            <div id="adminProfileDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div><strong>üë§ Full Name:</strong> <span id="adminFullName">-</span></div>
                <div><strong>üìß Email:</strong> <span id="adminEmail">-</span></div>
                <div><strong>üì± Phone:</strong> <span id="adminPhone">-</span></div>
                <div><strong>üéÇ Birthday:</strong> <span id="adminBirthday">-</span></div>
                <div><strong>üî¢ User ID:</strong> <span id="adminUserId">-</span></div>
                <div style="font-size: 0.85rem; color: #666; margin-top: -10px; margin-left: 24px;">System account identifier</div>
                <div><strong>üÜî License ID:</strong> <span id="adminLicenseId">Not applicable</span></div>
                <div style="font-size: 0.85rem; color: #666; margin-top: -10px; margin-left: 24px;">‚ÑπÔ∏è Province/State Professional License Number</div>
            </div>

            <!-- Edit Profile Form -->
            <div id="adminEditForm" style="display: none; margin-top: 20px;">
                <h3 style="color: #004080; margin-bottom: 15px;">Edit Your Profile</h3>
                <form id="adminProfileForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">First Name *</label>
                            <input type="text" id="adminEditFirstName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Last Name *</label>
                            <input type="text" id="adminEditLastName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email *</label>
                            <input type="email" id="adminEditEmail" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phone</label>
                            <input type="tel" id="adminEditPhone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Date of Birth</label>
                            <input type="date" id="adminEditDOB" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">License ID (optional)</label>
                            <input type="text" id="adminEditLicenseId" placeholder="Province/State License #" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            <small style="color: #666; font-size: 0.8rem;">Professional license number issued by province/state</small>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">New Password</label>
                            <input type="password" id="adminEditPassword" placeholder="Leave blank to keep current" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                        <div></div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="submit" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Changes</button>
                        <button type="button" onclick="cancelAdminProfile()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">‚ùå Cancel</button>
                    </div>
                </form>
                <div id="adminProfileMsg" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
            </div>
        </section>

        <section class="card">
            <h2 style="color: #004080; font-size: 1.5rem; margin-bottom: 20px;">Create User</h2>
            <form id="createUserForm" class="form-grid" autocomplete="off">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-field">
                        <label for="firstName" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">First name</label>
                        <input id="firstName" type="text" placeholder="e.g. Alice" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                    <div class="form-field">
                        <label for="lastName" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Last name</label>
                        <input id="lastName" type="text" placeholder="e.g. Lee" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                    <div class="form-field">
                        <label for="email" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Email</label>
                        <input id="email" type="email" placeholder="name@example.com" required autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-field">
                        <label for="password" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Password</label>
                        <input id="password" type="password" placeholder="Choose a secure password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                    <div class="form-field">
                        <label for="phone" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Phone</label>
                        <input id="phone" type="tel" placeholder="+1 555 100 001" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                    <div class="form-field">
                        <label for="dob" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Date of birth</label>
                        <input id="dob" type="date" placeholder="yyyy-mm-dd" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-field" id="healthCareNumberContainer" style="display: block;">
                        <label for="healthCareNumber" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Health Care Number</label>
                        <input id="healthCareNumber" placeholder="Required for Patients" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                    </div>
                    <div class="form-field" id="licenseIdContainer" style="display: none;">
                        <label for="licenseId" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">License ID</label>
                        <input id="licenseId" placeholder="Province/State Professional License" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                        <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 4px;">Required for Specialist/Staff/Admin - Professional license number issued by province/state</small>
                    </div>
                    <div class="form-field">
                        <label for="role" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Role</label>
                        <select id="role" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: white;">
                            <option value="patient">Patient</option>
                            <option value="specialist">Specialist</option>
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="form-field">
                        <label for="profileImage" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Upload Profile Photo (optional)</label>
                        <input id="profileImage" type="file" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                        <div class="muted" style="margin-top:6px; color: #666; font-size: 0.85rem;">Optional ‚Äî shown on patient cards and reports.</div>
                    </div>
                </div>

                <div class="form-actions" style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn" style="background: #007bff; color: white; padding: 10px 24px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: 500;">Create</button>
                </div>
            </form>
        </section>

        <section class="card" style="background: #f8f9fa; padding: 25px; border: 1px solid #dee2e6; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <h2 style="color: #004080; margin-bottom: 10px; font-size: 1.4rem;">üë• User Management</h2>
                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 15px;">View and manage all system users across different roles</p>
                    <p style="color: #555; font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        Access the complete user database to create, edit, and delete user accounts. View detailed profiles for patients, specialists, staff, and administrators. Search and filter users by role, manage account permissions, and update user information.
                    </p>
                </div>
                <a href="user_management.html" style="background: #007bff; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; white-space: nowrap; transition: background 0.2s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                    Open ‚Üí
                </a>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #004080;" id="totalUsersCount">-</div>
                    <div style="font-size: 0.85rem; color: #666;">Total Users</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #004080;" id="totalPatientsCount">-</div>
                    <div style="font-size: 0.85rem; color: #666;">Patients</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #004080;" id="totalSpecialistsCount">-</div>
                    <div style="font-size: 0.85rem; color: #666;">Specialists</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #004080;" id="totalStaffCount">-</div>
                    <div style="font-size: 0.85rem; color: #666;">Staff</div>
                </div>
            </div>
        </section>

        <section class="card" style="background: #f8f9fa; padding: 25px; border: 1px solid #dee2e6; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <h2 style="color: #004080; margin-bottom: 10px; font-size: 1.4rem;">Patient Assignments</h2>
                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 15px;">Assign patients to specialists and manage patient-specialist relationships</p>
                    <p style="color: #555; font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        Create and manage the connections between patients and their healthcare specialists. Assign patients to specialists for ongoing care, view all current assignments, reassign patients to different specialists, and track patient-specialist relationships across the system.
                    </p>
                </div>
                <a href="patient_assignments.html" style="background: #007bff; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; white-space: nowrap; transition: background 0.2s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                    Open ‚Üí
                </a>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #004080;" id="totalAssignmentsCount">-</div>
                    <div style="font-size: 0.85rem; color: #666;">Total Assignments</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #004080;" id="activeSpecialistsCount">-</div>
                    <div style="font-size: 0.85rem; color: #666;">Active Specialists</div>
                </div>
            </div>
        </section>

        <section class="card" style="background: #f8f9fa; padding: 25px; border: 1px solid #dee2e6; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <h2 style="color: #004080; margin-bottom: 10px; font-size: 1.4rem;">Monthly & Annual Reports</h2>
                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 15px;">Generate reports with patient statistics, blood sugar trends, and AI insights</p>
                    <p style="color: #555; font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        Generate comprehensive analytical reports for any time period. View detailed patient statistics, blood sugar trends, and patterns. Access AI-powered insights that identify food triggers, activity correlations, and time-based patterns. Export reports as PDF, CSV, or JSON for external analysis.
                    </p>
                </div>
                <a href="reports_management.html" style="background: #007bff; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; white-space: nowrap; transition: background 0.2s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                    Open ‚Üí
                </a>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; color: #004080;">üìä</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Monthly Reports</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; color: #004080;">üìà</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Annual Reports</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; color: #004080;">ü§ñ</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">AI Insights</div>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Simple Report</h2>
            <p class="hint">
                Based on users and readings from the last 7 days. Status is computed using thresholds
                (SystemDefault or overrides if present). Defaults: Normal ‚â§ <b>130</b>, Borderline ‚â§ <b>180</b>,
                Abnormal otherwise; AbnormalLow default <b>70</b>.
            </p>
            <div id="reportArea">
                <ul>
                    <li>Total users: <strong id="totalUsers">0</strong></li>
                    <li>By role ‚Äî Patients: <strong id="countPatients">0</strong>,
                        Specialists: <strong id="countSpecialists">0</strong>,
                        Staff: <strong id="countStaff">0</strong>,
                        Admins: <strong id="countAdmins">0</strong></li>
                    <li>Assignments ‚Äî Patients assigned: <strong id="assignedPatients">0</strong>,
                        Unassigned: <strong id="unassignedPatients">0</strong></li>
                    <li>Readings last 7 days ‚Äî Total: <strong id="r7Total">0</strong>,
                        <span style="color:#b91c1c">Abnormal</span>:
                        <strong id="r7Abnormal">0</strong> (<strong id="r7AbnormalPct">0%</strong>)
                    </li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" id="recalcBtn">Recalculate</button>
                <button type="button" id="exportBtn" class="secondary">Export JSON</button>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-bottom">
            <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // =========================================================================
        // ADMIN DASHBOARD - Single Script Block
        // =========================================================================

        // API Configuration
        const API_BASE = 'http://127.0.0.1:5000';

        // Global State
        let USERS_CACHE = [];
        let ASSIGNMENTS_CACHE = [];
        const ASSIGN_KEY = 'assignments';
        let currentAdminData = null;

        // Element References
        let createForm;
        let elTotalUsers, elCP, elCS, elCSt, elCA, elAssigned, elUnassigned, elR7Total, elR7Abn, elR7Pct;
        let roleSelect, licenseIdContainer;

        // ===== Utility Functions =====
        
        
        function loadAssignments() {
            try { return JSON.parse(localStorage.getItem(ASSIGN_KEY) || '[]'); }
            catch { return []; }
        }

        function saveAssignments(arr) {
            localStorage.setItem(ASSIGN_KEY, JSON.stringify(arr));
        }

        // ===== API Functions =====
        async function fetchAssignmentsFromAPI() {
            try {
                const token = localStorage.getItem('bsm_token') || '';
                const response = await fetch(`${API_BASE}/api/assignments`, {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('Failed to fetch assignments from API, using localStorage');
                    return loadAssignments();
                }
                
                const data = await response.json();
                console.log('Fetched assignments from database:', data);
                
                // Transform database assignments to match localStorage format
                ASSIGNMENTS_CACHE = (data.assignments || []).map(a => ({
                    id: `${a.specialist_id}-${a.patient_id}`,
                    patientId: String(a.patient_user_id),
                    specialistId: String(a.specialist_user_id),
                    createdAt: a.created_at
                }));
                
                // Sync to localStorage
                saveAssignments(ASSIGNMENTS_CACHE);
                
                return ASSIGNMENTS_CACHE;
            } catch (error) {
                console.error('Error fetching assignments:', error);
                return loadAssignments();
            }
        }
        
        async function fetchUsersFromAPI() {
            try {
                const token = localStorage.getItem('bsm_token') || '';
                const response = await fetch('http://127.0.0.1:5000/api/admin/users/all', {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                USERS_CACHE = data.users || [];
                console.log(`Loaded ${USERS_CACHE.length} users from database`);
                return USERS_CACHE;
            } catch (e) {
                console.error("Failed to fetch users from API:", e);
                // fallback to offline demo users
                USERS_CACHE = [
                    { user_id: 1, first_name: 'Alice', last_name: 'Lee', email: 'alice@example.com', phone: '+1 555 100 001', date_of_birth: '1985-04-12', role: 'patient' },
                    { user_id: 2, first_name: 'Bob', last_name: 'Ray', email: 'bob@example.com', phone: '+1 555 100 002', date_of_birth: '1978-09-03', role: 'patient' },
                    { user_id: 101, first_name: 'Dr. John', last_name: 'Smith', email: 'jsmith@demo', phone: '+1 555 200 010', date_of_birth: '1970-11-11', role: 'specialist' },
                    { user_id: 102, first_name: 'Dr. Alex', last_name: 'Jones', email: 'ajones@demo', phone: '+1 555 200 011', date_of_birth: '1972-03-22', role: 'specialist' },
                    { user_id: 3, first_name: 'Dr. Christina', last_name: 'Lee', email: 'clee@clinic', phone: '+1 555 200 003', date_of_birth: '1975-01-15', role: 'specialist' },
                    { user_id: 4, first_name: 'Staff', last_name: 'Member', email: 'staff@clinic', phone: '+1 555 300 004', date_of_birth: '1990-06-20', role: 'staff' },
                    { user_id: 5, first_name: 'Admin', last_name: 'User', email: 'admin@clinic', phone: '+1 555 400 005', date_of_birth: '1980-02-28', role: 'admin' }
                ];
                return USERS_CACHE;
            }
        }

        // ===== Render Functions =====
        async function updateUserStats() {
            let users = USERS_CACHE.length ? USERS_CACHE : await fetchUsersFromAPI();

            // Fetch patients from the database
            try {
                const token = localStorage.getItem('bsm_token') || '';
                const response = await fetch('http://127.0.0.1:5000/api/patients', {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const patients = (data.patients || []).map(p => ({
                        user_id: p.user_id,
                        patient_id: p.patient_id,
                        first_name: p.first_name,
                        last_name: p.last_name,
                        email: p.email,
                        phone: p.phone,
                        date_of_birth: p.date_of_birth,
                        role: 'patient'
                    }));
                    
                    // Cache patients to localStorage
                    localStorage.setItem('patients', JSON.stringify(patients));
                    
                    // Merge patients with users (remove duplicates by user_id)
                    const existingIds = new Set(users.map(u => u.user_id));
                    patients.forEach(p => {
                        if (!existingIds.has(p.user_id)) {
                            users.push(p);
                            existingIds.add(p.user_id);
                        }
                    });
                }
            } catch (e) {
                console.warn('Could not fetch patients from database', e);
            }

            // Update user count statistics
            const totalUsers = users.length;
            const patients = users.filter(u => u.role === 'patient');
            const specialists = users.filter(u => u.role === 'specialist');
            const staff = users.filter(u => u.role === 'staff');

            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('totalPatientsCount').textContent = patients.length;
            document.getElementById('totalSpecialistsCount').textContent = specialists.length;
            document.getElementById('totalStaffCount').textContent = staff.length;

            // Update assignment statistics
            updateAssignmentStats(specialists.length);

            console.log('Total users loaded:', users.length);
            console.log('Patients found:', patients.length);
            console.log('Specialists found:', specialists.length);

            // Store all patients for filtering
            window.ALL_PATIENTS = patients;
            
            // Initial render with current filter
            updatePatientDropdown();
            
            // helper escape to avoid HTML injection from stored data
            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g, function(c){
                    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];
                });
            }

            specialistSelect.innerHTML = specialists.map(s => `
                <option value="${escapeHtml(String(s.user_id))}">${escapeHtml((s.first_name || '') + ' ' + (s.last_name || '')).trim()} (${escapeHtml(s.email || '')})</option>
            `).join('');
        }

        function updatePatientDropdown() {
            if (!patientSelect) return;
            
            const patients = window.ALL_PATIENTS || [];
            
            console.log('Updating patient dropdown, patients count:', patients.length);
            
            if (patients.length === 0) {
                patientSelect.innerHTML = '<option value="">No patients found</option>';
                return;
            }
            
            // Use ASSIGNMENTS_CACHE to mark assigned patients
            const assigns = ASSIGNMENTS_CACHE || [];
            const assignedPatientIds = assigns.map(a => String(a.patientId));
            
            patientSelect.innerHTML = patients.map(p => {
                const label = `${p.first_name || ''} ${p.last_name || ''}`.trim() || (p.email || p.user_id);
                const isAssigned = assignedPatientIds.includes(String(p.user_id));
                const badge = isAssigned ? ' ‚úì' : '';
                return `<option value="${String(p.user_id)}">${label}${badge} (${p.email || ''})</option>`;
            }).join('');
        }

        function updateAssignmentStats(specialistCount) {
            const assigns = ASSIGNMENTS_CACHE || [];
            document.getElementById('totalAssignmentsCount').textContent = assigns.length;
            document.getElementById('activeSpecialistsCount').textContent = specialistCount;
        }

        async function renderAssignments() {
            const users = USERS_CACHE || [];
            
            // Fetch assignments from database
            let assigns = await fetchAssignmentsFromAPI();
            
            // Update assignment statistics only (no table on this page)
            const specialists = USERS_CACHE.filter(u => u.role === 'specialist');
            updateAssignmentStats(specialists.length);
            
            // Return assignments for use by other functions
            return assigns;
        }

        async function renderReport() {
            const users = USERS_CACHE;
            
            // Fetch latest assignments from database
            const assigns = await fetchAssignmentsFromAPI();

            const now = new Date();
            const year = now.getFullYear();
            const currentMonth = `${year}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            try {
                const reportData = await getAdminMonthlyReport(currentMonth, year);

                const allPatientStats = reportData.patient_statistics || [];

                elTotalUsers.textContent = users.length;
                elCP.textContent = users.filter(u => u.role === 'patient').length;
                elCS.textContent = users.filter(u => u.role === 'specialist').length;
                elCSt.textContent = users.filter(u => u.role === 'staff').length;
                elCA.textContent = users.filter(u => u.role === 'admin').length;

                const patients = users.filter(u => u.role === 'patient');
                const assignedSet = new Set(assigns.map(a => String(a.patientId)));
                const assignedCount = patients.filter(p => assignedSet.has(String(p.user_id))).length;
                
                console.log('Assignment calculation:', {
                    totalPatients: patients.length,
                    assignedPatientIds: Array.from(assignedSet),
                    assignedCount: assignedCount,
                    unassignedCount: patients.length - assignedCount
                });
                
                elAssigned.textContent = assignedCount;
                elUnassigned.textContent = Math.max(0, patients.length - assignedCount);

                

                // Calculate global totals from the list of patient statistics
                const totalReadings = allPatientStats.reduce((sum, p) => sum + (p.total_readings || 0), 0);
                const totalAbnormal = allPatientStats.reduce((sum, p) => sum + (p.abnormal_count || 0), 0);

                elR7Total.textContent = totalReadings;
                elR7Abn.textContent = totalAbnormal;
                elR7Pct.textContent = totalReadings > 0 
                    ? Math.round((totalAbnormal / totalReadings) * 100) + '%' 
                    : '0%';

            } catch (error) {
                console.error("Failed to load report from backend:", error);
                elR7Total.textContent = elR7Abn.textContent = '0';
                elR7Pct.textContent = '0%';
            }
        }

        // ===== Event Handlers =====
        async function handleCreateUser(e) {
            e.preventDefault();

            const role = document.getElementById('role').value;

            const payload = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value.trim(),
                role: role,
                phone: document.getElementById('phone').value.trim(),
                dateOfBirth: document.getElementById('dob').value,
            };

            if (role === 'patient') {
                const healthCareNumber = document.getElementById('healthCareNumber').value.trim();
                if (!healthCareNumber) {
                    alert('Health Care Number is required for patients');
                    return;
                }
                payload.healthCareNumber = healthCareNumber;
            } else if (role === 'specialist' || role === 'staff') {
                const licenseId = document.getElementById('licenseId').value.trim();
                if (!licenseId) {
                    alert(`License ID is required for role: ${role}`);
                    return;
                }
                payload.licenseId = licenseId;
            }

            // Handle profile image file upload (store as data URL for now)
            const profileImageInput = document.getElementById('profileImage');
            if (profileImageInput && profileImageInput.files && profileImageInput.files[0]) {
                const file = profileImageInput.files[0];
                const reader = new FileReader();
                reader.onload = async function(event) {
                    payload.profileImage = event.target.result;
                    await createUserRequest(payload);
                };
                reader.readAsDataURL(file);
            } else {
                await createUserRequest(payload);
            }
        }

        async function createUserRequest(payload) {
            try {
                const response = await apiRequest('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                alert(`User created successfully! ID: ${response.userId}`);

                createForm.reset();
                await fetchUsersFromAPI();
                await updateUserStats();
                await renderReport();
            } catch (error) {
                console.error("User creation failed:", error);
                alert('Error creating user: ' + error.message);
            }
        }

        async function handleAssignSubmit(e) {
            e.preventDefault();
            // Allow string or numeric IDs ‚Äî patient IDs may be non-numeric (local/demo keys)
            const patientId = (patientSelect && patientSelect.value) ? String(patientSelect.value) : null;
            const specialistId = (specialistSelect && specialistSelect.value) ? String(specialistSelect.value) : null;
            if (!patientId || !specialistId) return;

            try {
                console.log('Assigning patient:', patientId, 'to specialist:', specialistId);
                
                // Call the backend API to save assignment to database
                const token = localStorage.getItem('bsm_token') || '';
                const response = await fetch('http://127.0.0.1:5000/api/assignments/assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        patientId: patientId,
                        specialistId: specialistId
                    })
                });

                const result = await response.json();
                console.log('Assignment API response:', result);

                if (!response.ok) {
                    console.error('Assignment failed:', result);
                    throw new Error(result.error || 'Failed to assign patient');
                }

                console.log('Assignment successful in database');
                
                // Update localStorage after successful API call
                const assigns = loadAssignments();
                const rest = assigns.filter(a => String(a.patientId) !== String(patientId));
                rest.push({ id: Date.now().toString(), patientId, specialistId });
                saveAssignments(rest);
                
                renderAssignments();
                renderReport();
                alert('Patient assigned successfully! The specialist can now see this patient in their dashboard.');

            } catch (error) {
                console.error('Assignment error:', error);
                alert('Failed to assign patient: ' + error.message);
            }
        }

        async function handleRemoveAssignment(e) {
            const btn = e.target.closest('.remove-assign');
            if (!btn) return;
            
            const assignmentId = btn.dataset.id;
            const specialistId = btn.dataset.specialistId;
            const patientId = btn.dataset.patientId;
            
            if (!confirm(`Remove this patient assignment?`)) return;
            
            try {
                // Try to remove from database
                const token = localStorage.getItem('bsm_token') || '';
                const response = await fetch(`http://127.0.0.1:5000/api/assignments/${specialistId}/${patientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Assignment removed successfully!');
                } else {
                    console.warn('API removal failed, removing from localStorage only');
                }
            } catch (error) {
                console.warn('API call failed, removing from localStorage only:', error);
            }
            
            // Also remove from localStorage
            const left = loadAssignments().filter(a => String(a.id) !== String(assignmentId));
            saveAssignments(left);
            renderAssignments();
            renderReport();
        }

        // ===== Detailed Report Functions =====
        let currentDetailedReport = null;

        async function generateMonthlyReport() {
            const monthInput = document.getElementById('reportMonth').value;
            if (!monthInput) {
                alert('Please select a month');
                return;
            }

            const [year, month] = monthInput.split('-');
            
            try {
                const reportData = await getAdminMonthlyReport(monthInput, parseInt(year));
                currentDetailedReport = reportData;
                
                displayDetailedReport(reportData, 'Monthly', monthInput);
            } catch (error) {
                console.error('Error generating monthly report:', error);
                alert('Failed to generate monthly report: ' + error.message);
            }
        }

        async function generateAnnualReport() {
            const year = document.getElementById('reportYear').value;
            if (!year) {
                alert('Please enter a year');
                return;
            }

            try {
                // Aggregate data for the entire year by fetching each month
                let annualData = {
                    patient_statistics: [],
                    food_triggers: {},
                    activity_triggers: {}
                };

                const patientMap = new Map();

                for (let month = 1; month <= 12; month++) {
                    const monthStr = `${year}-${String(month).padStart(2, '0')}`;
                    try {
                        const monthData = await getAdminMonthlyReport(monthStr, parseInt(year));
                        
                        // Aggregate patient statistics
                        (monthData.patient_statistics || []).forEach(p => {
                            const patientId = p.user_id || p.patient_id;
                            const patientName = p.patient_name || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'Unknown';
                            
                            if (!patientMap.has(patientId)) {
                                patientMap.set(patientId, {
                                    patient_id: patientId,
                                    patient_name: patientName,
                                    total_readings: 0,
                                    normal_count: 0,
                                    borderline_count: 0,
                                    abnormal_count: 0,
                                    values: [],
                                    max_value: 0,
                                    min_value: Infinity
                                });
                            }
                            
                            const existing = patientMap.get(patientId);
                            existing.total_readings += parseInt(p.total_readings) || 0;
                            existing.normal_count += parseInt(p.normal_count) || 0;
                            existing.borderline_count += parseInt(p.borderline_count) || 0;
                            existing.abnormal_count += parseInt(p.abnormal_count) || 0;
                            
                            // Track average values for annual averaging
                            if (p.avg_value > 0) existing.values.push(parseFloat(p.avg_value));
                            // Track highest max_value across all months
                            if (p.max_value > 0 && p.max_value > existing.max_value) existing.max_value = parseFloat(p.max_value);
                            // Track lowest min_value across all months
                            if (p.min_value > 0 && p.min_value < existing.min_value) existing.min_value = parseFloat(p.min_value);
                        });

                        // Aggregate food triggers
                        Object.entries(monthData.food_triggers || {}).forEach(([food, data]) => {
                            const count = typeof data === 'number' ? data : (data.count || 0);
                            const patients = typeof data === 'object' ? (data.patients || '') : '';
                            
                            if (!annualData.food_triggers[food]) {
                                annualData.food_triggers[food] = { count: 0, patients: new Set() };
                            }
                            annualData.food_triggers[food].count += count;
                            if (patients) {
                                patients.split(', ').forEach(p => annualData.food_triggers[food].patients.add(p.trim()));
                            }
                        });

                        // Aggregate activity triggers
                        Object.entries(monthData.activity_triggers || {}).forEach(([activity, data]) => {
                            const count = typeof data === 'number' ? data : (data.count || 0);
                            const patients = typeof data === 'object' ? (data.patients || '') : '';
                            
                            if (!annualData.activity_triggers[activity]) {
                                annualData.activity_triggers[activity] = { count: 0, patients: new Set() };
                            }
                            annualData.activity_triggers[activity].count += count;
                            if (patients) {
                                patients.split(', ').forEach(p => annualData.activity_triggers[activity].patients.add(p.trim()));
                            }
                        });
                    } catch (e) {
                        console.warn(`Failed to fetch data for ${monthStr}:`, e);
                    }
                }

                // Calculate final statistics for each patient
                annualData.patient_statistics = Array.from(patientMap.values()).map(p => {
                    const allValues = p.values.filter(v => v > 0);
                    return {
                        ...p,
                        avg_value: allValues.length > 0 ? (allValues.reduce((a, b) => a + b, 0) / allValues.length) : 0,
                        max_value: p.max_value > 0 ? p.max_value : 0,
                        min_value: p.min_value < Infinity ? p.min_value : 0
                    };
                });

                // Convert trigger Sets to comma-separated strings
                Object.keys(annualData.food_triggers).forEach(food => {
                    const trigger = annualData.food_triggers[food];
                    annualData.food_triggers[food] = {
                        count: trigger.count,
                        patients: Array.from(trigger.patients).join(', ')
                    };
                });
                Object.keys(annualData.activity_triggers).forEach(activity => {
                    const trigger = annualData.activity_triggers[activity];
                    annualData.activity_triggers[activity] = {
                        count: trigger.count,
                        patients: Array.from(trigger.patients).join(', ')
                    };
                });

                currentDetailedReport = annualData;
                displayDetailedReport(annualData, 'Annual', year);
            } catch (error) {
                console.error('Error generating annual report:', error);
                alert('Failed to generate annual report: ' + error.message);
            }
        }

        function displayDetailedReport(data, reportType, period) {
            const reportArea = document.getElementById('detailedReportArea');
            reportArea.style.display = 'block';

            // Update header
            document.getElementById('reportTitle').textContent = `${reportType} Report`;
            document.getElementById('reportPeriod').textContent = `Period: ${period}`;

            const patientStats = data.patient_statistics || [];
            const totalPatients = patientStats.length;
            const patientsWithReadings = patientStats.filter(p => p.total_readings > 0).length;
            
            const totalReadings = patientStats.reduce((sum, p) => sum + (parseInt(p.total_readings) || 0), 0);
            const totalNormal = patientStats.reduce((sum, p) => sum + (parseInt(p.normal_count) || 0), 0);
            const totalBorderline = patientStats.reduce((sum, p) => sum + (parseInt(p.borderline_count) || 0), 0);
            const totalAbnormal = patientStats.reduce((sum, p) => sum + (parseInt(p.abnormal_count) || 0), 0);

            const allValues = patientStats.flatMap(p => 
                [p.avg_value, p.max_value, p.min_value].filter(v => v > 0)
            );
            const overallAvg = allValues.length > 0 
                ? (allValues.reduce((a, b) => a + b, 0) / allValues.length).toFixed(2)
                : '0.00';

            // Update overview stats
            document.getElementById('reportTotalPatients').textContent = totalPatients;
            document.getElementById('reportActivePatients').textContent = patientsWithReadings;
            document.getElementById('reportTotalReadings').textContent = totalReadings;
            document.getElementById('reportAvgReadings').textContent = 
                patientsWithReadings > 0 ? (totalReadings / patientsWithReadings).toFixed(2) : '0.00';

            // Update blood sugar trends
            document.getElementById('reportOverallAvg').textContent = overallAvg;
            document.getElementById('reportNormalCount').textContent = totalNormal;
            document.getElementById('reportNormalPct').textContent = 
                totalReadings > 0 ? ((totalNormal / totalReadings) * 100).toFixed(2) + '%' : '0.00%';
            document.getElementById('reportBorderlineCount').textContent = totalBorderline;
            document.getElementById('reportBorderlinePct').textContent = 
                totalReadings > 0 ? ((totalBorderline / totalReadings) * 100).toFixed(2) + '%' : '0.00%';
            document.getElementById('reportAbnormalCount').textContent = totalAbnormal;
            document.getElementById('reportAbnormalPct').textContent = 
                totalReadings > 0 ? ((totalAbnormal / totalReadings) * 100).toFixed(2) + '%' : '0.00%';

            // Calculate detailed trend analysis
            let highestOverall = { value: 0, patient: '-' };
            let lowestOverall = { value: Infinity, patient: '-' };
            let mostStable = { patient: '-', variance: Infinity };
            let mostAtRisk = { patient: '-', pct: 0 };

            patientStats.forEach(p => {
                if (p.total_readings > 0) {
                    // Highest value
                    if (p.max_value > highestOverall.value) {
                        highestOverall = { value: p.max_value, patient: p.patient_name || 'Unknown' };
                    }
                    
                    // Lowest value
                    if (p.min_value > 0 && p.min_value < lowestOverall.value) {
                        lowestOverall = { value: p.min_value, patient: p.patient_name || 'Unknown' };
                    }
                    
                    // Most stable (smallest range)
                    const range = p.max_value - p.min_value;
                    if (range < mostStable.variance && p.total_readings >= 3) {
                        mostStable = { patient: p.patient_name || 'Unknown', variance: range };
                    }
                    
                    // Most at risk (highest abnormal percentage)
                    const abnormalPct = (p.abnormal_count / p.total_readings) * 100;
                    if (abnormalPct > mostAtRisk.pct) {
                        mostAtRisk = { patient: p.patient_name || 'Unknown', pct: abnormalPct };
                    }
                }
            });

            // Update trend analysis
            document.getElementById('trendHighestValue').textContent = highestOverall.value.toFixed(2);
            document.getElementById('trendHighestPatient').textContent = highestOverall.patient;
            document.getElementById('trendLowestValue').textContent = lowestOverall.value !== Infinity ? lowestOverall.value.toFixed(2) : '0.00';
            document.getElementById('trendLowestPatient').textContent = lowestOverall.patient;
            document.getElementById('trendMostStable').textContent = mostStable.patient;
            document.getElementById('trendStableVariance').textContent = mostStable.variance !== Infinity ? mostStable.variance.toFixed(2) : '0.00';
            document.getElementById('trendMostAtRisk').textContent = mostAtRisk.patient;
            document.getElementById('trendRiskPct').textContent = mostAtRisk.pct.toFixed(2);

            // Update patient statistics table (top 10)
            const sortedPatients = [...patientStats]
                .filter(p => p.total_readings > 0)
                .sort((a, b) => b.total_readings - a.total_readings)
                .slice(0, 10);

            const tbody = document.querySelector('#patientStatsTable tbody');
            tbody.innerHTML = sortedPatients.map(p => {
                const abnormalPct = p.total_readings > 0 
                    ? ((p.abnormal_count / p.total_readings) * 100).toFixed(2)
                    : '0.00';
                const statusColor = parseFloat(abnormalPct) > 30 ? '#dc3545' : parseFloat(abnormalPct) > 15 ? '#ffc107' : '#28a745';
                
                // Calculate trend (comparing abnormal percentage)
                const trendIcon = parseFloat(abnormalPct) > 25 ? 'üìà' : parseFloat(abnormalPct) < 10 ? 'üìâ' : '‚û°Ô∏è';
                const trendText = parseFloat(abnormalPct) > 25 ? 'Worsening' : parseFloat(abnormalPct) < 10 ? 'Improving' : 'Stable';
                
                return `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px; font-size: 0.9rem; color: #212529;">${p.patient_name || 'Unknown'}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #212529;">${p.total_readings}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #212529;">${(p.avg_value || 0).toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #dc3545; font-weight: 600;">${(p.max_value || 0).toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #28a745; font-weight: 600;">${(p.min_value || 0).toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: ${statusColor}; font-weight: 600;">${abnormalPct}%</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem;">${trendIcon} ${trendText}</td>
                    </tr>
                `;
            }).join('');

            // Display abnormal readings details
            const abnormalDetailsArea = document.getElementById('abnormalDetailsArea');
            const patientsWithAbnormal = patientStats.filter(p => p.abnormal_count > 0).length;
            const avgAbnormalPerPatient = patientsWithAbnormal > 0 
                ? (totalAbnormal / patientsWithAbnormal).toFixed(2) 
                : '0.00';
            
            const criticalPatients = patientStats.filter(p => {
                const pct = p.total_readings > 0 ? (p.abnormal_count / p.total_readings) * 100 : 0;
                return pct > 30;
            });

            abnormalDetailsArea.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                        <h5 style="color: #856404; font-size: 1rem; margin-bottom: 5px;">Patients with Abnormal Readings</h5>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #856404; margin: 0;">${patientsWithAbnormal}</p>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 6px;">
                        <h5 style="color: #721c24; font-size: 1rem; margin-bottom: 5px;">Average Abnormal per Patient</h5>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #721c24; margin: 0;">${avgAbnormalPerPatient}</p>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 6px;">
                        <h5 style="color: #721c24; font-size: 1rem; margin-bottom: 5px;">Critical Patients (>30% Abnormal)</h5>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #721c24; margin: 0;">${criticalPatients.length}</p>
                    </div>
                </div>
                
                ${criticalPatients.length > 0 ? `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-top: 15px;">
                        <h5 style="color: #dc3545; font-size: 1rem; margin-bottom: 10px;">‚ö†Ô∏è Critical Patients Requiring Immediate Attention:</h5>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${criticalPatients.slice(0, 5).map(p => {
                                const pct = ((p.abnormal_count / p.total_readings) * 100).toFixed(2);
                                return `<li style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                    <strong>${p.patient_name || 'Unknown'}</strong> - 
                                    <span style="color: #dc3545; font-weight: 600;">${pct}% abnormal</span> 
                                    (${p.abnormal_count}/${p.total_readings} readings)
                                </li>`;
                            }).join('')}
                        </ul>
                    </div>
                ` : '<p style="color: #28a745; padding: 10px; background: #d4edda; border-radius: 6px; margin-top: 15px;">‚úì No critical patients detected in this period.</p>'}
            `;

            // Display food triggers
            const foodTriggers = Object.entries(data.food_triggers || {})
                .map(([food, data]) => {
                    // Handle both old format (number) and new format (object with count and patients)
                    const count = typeof data === 'number' ? data : (data.count || 0);
                    const patients = typeof data === 'object' ? (data.patients || '') : '';
                    return [food, count, patients];
                })
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const foodArea = document.getElementById('foodTriggersArea');
            if (foodTriggers.length > 0) {
                foodArea.innerHTML = `
                    <ol style="padding-left: 20px; margin: 0;">
                        ${foodTriggers.map(([food, count, patients]) => `
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; color: #212529;">
                                <strong>${food}</strong> - <span style="color: #dc3545; font-weight: 600;">${count}</span> abnormal reading${count > 1 ? 's' : ''}
                                ${patients ? `<div style="font-size: 0.85rem; color: #666; margin-top: 4px;">üë§ Patients: ${patients}</div>` : ''}
                            </li>
                        `).join('')}
                    </ol>
                `;
            } else {
                foodArea.innerHTML = '<p style="color: #999; padding: 10px 0;">No food trigger data available for this period.</p>';
            }

            // Display activity triggers
            const activityTriggers = Object.entries(data.activity_triggers || {})
                .map(([activity, data]) => {
                    // Handle both old format (number) and new format (object with count and patients)
                    const count = typeof data === 'number' ? data : (data.count || 0);
                    const patients = typeof data === 'object' ? (data.patients || '') : '';
                    return [activity, count, patients];
                })
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const activityArea = document.getElementById('activityTriggersArea');
            if (activityTriggers.length > 0) {
                activityArea.innerHTML = `
                    <ol style="padding-left: 20px; margin: 0;">
                        ${activityTriggers.map(([activity, count, patients]) => `
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; color: #212529;">
                                <strong>${activity}</strong> - <span style="color: #dc3545; font-weight: 600;">${count}</span> abnormal reading${count > 1 ? 's' : ''}
                                ${patients ? `<div style="font-size: 0.85rem; color: #666; margin-top: 4px;">üë§ Patients: ${patients}</div>` : ''}
                            </li>
                        `).join('')}
                    </ol>
                `;
            } else {
                activityArea.innerHTML = '<p style="color: #999; padding: 10px 0;">No activity trigger data available for this period.</p>';
            }

            // Scroll to report
            reportArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function clearReportInputs() {
            document.getElementById('reportMonth').value = '';
            document.getElementById('reportYear').value = '';
            document.getElementById('detailedReportArea').style.display = 'none';
            currentDetailedReport = null;
        }

        function exportDetailedReport() {
            if (!currentDetailedReport) {
                alert('Please generate a report first');
                return;
            }

            const dataStr = JSON.stringify(currentDetailedReport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin_report_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            if (!currentDetailedReport) {
                alert('Please generate a report first');
                return;
            }

            const patientStats = currentDetailedReport.patient_statistics || [];
            
            // Create CSV header
            let csv = 'Patient Name,Total Readings,Average (mg/dL),Highest (mg/dL),Lowest (mg/dL),Normal Count,Borderline Count,Abnormal Count,Abnormal %\n';
            
            // Add patient data
            patientStats.forEach(p => {
                const abnormalPct = p.total_readings > 0 
                    ? ((p.abnormal_count / p.total_readings) * 100).toFixed(2)
                    : '0.00';
                
                csv += `"${p.patient_name || 'Unknown'}",`;
                csv += `${p.total_readings},`;
                csv += `${(p.avg_value || 0).toFixed(2)},`;
                csv += `${(p.max_value || 0).toFixed(2)},`;
                csv += `${(p.min_value || 0).toFixed(2)},`;
                csv += `${p.normal_count || 0},`;
                csv += `${p.borderline_count || 0},`;
                csv += `${p.abnormal_count || 0},`;
                csv += `${abnormalPct}%\n`;
            });

            // Add food triggers section
            csv += '\n\nFood Triggers for Abnormal Readings\n';
            csv += 'Food Item,Abnormal Count,Patients\n';
            Object.entries(currentDetailedReport.food_triggers || {})
                .map(([food, data]) => {
                    const count = typeof data === 'number' ? data : (data.count || 0);
                    const patients = typeof data === 'object' ? (data.patients || '') : '';
                    return [food, count, patients];
                })
                .sort((a, b) => b[1] - a[1])
                .forEach(([food, count, patients]) => {
                    csv += `"${food}",${count},"${patients}"\n`;
                });

            // Add activity triggers section
            csv += '\n\nActivity Triggers for Abnormal Readings\n';
            csv += 'Activity,Abnormal Count,Patients\n';
            Object.entries(currentDetailedReport.activity_triggers || {})
                .map(([activity, data]) => {
                    const count = typeof data === 'number' ? data : (data.count || 0);
                    const patients = typeof data === 'object' ? (data.patients || '') : '';
                    return [activity, count, patients];
                })
                .sort((a, b) => b[1] - a[1])
                .forEach(([activity, count, patients]) => {
                    csv += `"${activity}",${count},"${patients}"\n`;
                });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportPDF() {
            if (!currentDetailedReport) {
                alert('Please generate a report first');
                return;
            }

            // Get report data
            const reportTitle = document.getElementById('reportTitle').textContent;
            const reportPeriod = document.getElementById('reportPeriod').textContent;
            const patientStats = currentDetailedReport.patient_statistics || [];
            
            // Create HTML content for PDF
            let pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${reportTitle}</title>
    <` + `style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #004080; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        h2 { color: #004080; margin-top: 30px; border-bottom: 2px solid #dee2e6; padding-bottom: 8px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #004080; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f8f9fa; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .stat-box { padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; border-radius: 6px; }
        .stat-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #004080; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #666; font-size: 0.9rem; }
        .critical { color: #dc3545; font-weight: bold; }
        .good { color: #28a745; font-weight: bold; }
        @media print { body { padding: 10px; } }
    <` + `/style>
<` + `/head>
<body>
    <h1>${reportTitle}</h1>
    <p style="color: #666; font-size: 1.1rem; margin-bottom: 30px;">${reportPeriod}</p>
    
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-label">Total Active Patients</div>
            <div class="stat-value">${document.getElementById('reportTotalPatients').textContent}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Patients with Readings</div>
            <div class="stat-value">${document.getElementById('reportActivePatients').textContent}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total Readings</div>
            <div class="stat-value">${document.getElementById('reportTotalReadings').textContent}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Overall Average</div>
            <div class="stat-value">${document.getElementById('reportOverallAvg').textContent} mg/dL</div>
        </div>
    </div>

    <h2>Blood Sugar Distribution</h2>
    <table>
        <tr>
            <th>Category</th>
            <th>Count</th>
            <th>Percentage</th>
        </tr>
        <tr>
            <td class="good">Normal</td>
            <td>${document.getElementById('reportNormalCount').textContent}</td>
            <td>${document.getElementById('reportNormalPct').textContent}</td>
        </tr>
        <tr>
            <td style="color: #ffc107; font-weight: bold;">Borderline</td>
            <td>${document.getElementById('reportBorderlineCount').textContent}</td>
            <td>${document.getElementById('reportBorderlinePct').textContent}</td>
        </tr>
        <tr>
            <td class="critical">Abnormal</td>
            <td>${document.getElementById('reportAbnormalCount').textContent}</td>
            <td>${document.getElementById('reportAbnormalPct').textContent}</td>
        </tr>
    </table>

    <h2>Patient Statistics</h2>
    <table>
        <tr>
            <th>Patient Name</th>
            <th>Readings</th>
            <th>Average</th>
            <th>Highest</th>
            <th>Lowest</th>
            <th>Abnormal %</th>
        </tr>`;

            patientStats.slice(0, 10).forEach(p => {
                const abnormalPct = p.total_readings > 0 
                    ? ((p.abnormal_count / p.total_readings) * 100).toFixed(2)
                    : '0.00';
                pdfContent += `
        <tr>
            <td>${p.patient_name || 'Unknown'}</td>
            <td>${p.total_readings}</td>
            <td>${(p.avg_value || 0).toFixed(2)} mg/dL</td>
            <td class="critical">${(p.max_value || 0).toFixed(2)} mg/dL</td>
            <td class="good">${(p.min_value || 0).toFixed(2)} mg/dL</td>
            <td>${abnormalPct}%</td>
        </tr>`;
            });

            pdfContent += `
    </table>

    <h2>Top Food Triggers for Abnormal Readings</h2>
    <table>
        <tr>
            <th>Food Item</th>
            <th>Abnormal Count</th>
            <th>Patients</th>
        </tr>`;

            Object.entries(currentDetailedReport.food_triggers || {})
                .map(([food, data]) => {
                    const count = typeof data === 'number' ? data : (data.count || 0);
                    const patients = typeof data === 'object' ? (data.patients || '') : '';
                    return [food, count, patients];
                })
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([food, count, patients]) => {
                    pdfContent += `
        <tr>
            <td>${food}</td>
            <td class="critical">${count}</td>
            <td>${patients || '-'}</td>
        </tr>`;
                });

            pdfContent += `
    </table>

    <h2>Top Activity Triggers for Abnormal Readings</h2>
    <table>
        <tr>
            <th>Activity</th>
            <th>Abnormal Count</th>
            <th>Patients</th>
        </tr>`;

            Object.entries(currentDetailedReport.activity_triggers || {})
                .map(([activity, data]) => {
                    const count = typeof data === 'number' ? data : (data.count || 0);
                    const patients = typeof data === 'object' ? (data.patients || '') : '';
                    return [activity, count, patients];
                })
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([activity, count, patients]) => {
                    pdfContent += `
        <tr>
            <td>${activity}</td>
            <td class="critical">${count}</td>
            <td>${patients || '-'}</td>
        </tr>`;
                });

            pdfContent += `
    <` + `/table>

    <div class="footer">
        <p>Blood Sugar Monitoring System - Administrative Report<` + `/p>
        <p>Generated on: ${new Date().toLocaleString()}<` + `/p>
    <` + `/div>
<` + `/body>
<` + `/html>`;

            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '', 'width=1200,height=800');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.focus();
            
            // Auto-print after a short delay
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function printDetailedReport() {
            window.print();
        }

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind Elements
            createForm = document.getElementById('createUserForm');

            elTotalUsers = document.getElementById('totalUsers');
            elCP = document.getElementById('countPatients');
            elCS = document.getElementById('countSpecialists');
            elCSt = document.getElementById('countStaff');
            elCA = document.getElementById('countAdmins');
            elAssigned = document.getElementById('assignedPatients');
            elUnassigned = document.getElementById('unassignedPatients');
            elR7Total = document.getElementById('r7Total');
            elR7Abn = document.getElementById('r7Abnormal');
            elR7Pct = document.getElementById('r7AbnormalPct');

            roleSelect = document.getElementById('role');
            licenseIdContainer = document.getElementById('licenseIdContainer');
            const healthCareNumberContainer = document.getElementById('healthCareNumberContainer');

            // Role-specific field visibility
            if (roleSelect && licenseIdContainer && healthCareNumberContainer) {
                roleSelect.addEventListener('change', (e) => {
                    const role = e.target.value;
                    const healthCareInput = document.getElementById('healthCareNumber');
                    const licenseIdInput = document.getElementById('licenseId');
                    
                    if (role === 'patient') {
                        // Show health care number, hide license ID
                        healthCareNumberContainer.style.display = 'block';
                        healthCareInput.setAttribute('required', 'required');
                        healthCareInput.disabled = false;
                        licenseIdContainer.style.display = 'none';
                        licenseIdInput.removeAttribute('required');
                        licenseIdInput.disabled = true;
                    } else if (role === 'specialist' || role === 'staff' || role === 'admin') {
                        // Hide health care number, show license ID for specialist, staff, and admin
                        healthCareNumberContainer.style.display = 'block';
                        healthCareInput.removeAttribute('required');
                        healthCareInput.disabled = true;
                        healthCareInput.style.background = '#f5f5f5';
                        licenseIdContainer.style.display = 'block';
                        licenseIdInput.setAttribute('required', 'required');
                        licenseIdInput.disabled = false;
                        licenseIdInput.style.background = 'white';
                    } else {
                        // Fallback - hide both
                        healthCareNumberContainer.style.display = 'none';
                        healthCareInput.removeAttribute('required');
                        healthCareInput.disabled = true;
                        licenseIdContainer.style.display = 'none';
                        licenseIdInput.removeAttribute('required');
                        licenseIdInput.disabled = true;
                    }
                });
                
                // Trigger on load for initial state (default is Patient)
                roleSelect.dispatchEvent(new Event('change'));
            }

            // ========== Admin Profile Functions ==========
            let currentAdminData = null;

            function toggleAdminProfile() {
                const display = document.getElementById('adminProfileDisplay');
                const form = document.getElementById('adminEditForm');
                const btn = document.getElementById('editAdminProfileBtn');

                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    display.style.display = 'none';
                    btn.textContent = 'üëÅÔ∏è View Profile';

                    // Pre-fill form
                    if (currentAdminData) {
                        document.getElementById('adminEditFirstName').value = currentAdminData.first_name || '';
                        document.getElementById('adminEditLastName').value = currentAdminData.last_name || '';
                        document.getElementById('adminEditEmail').value = currentAdminData.email || '';
                        document.getElementById('adminEditPhone').value = currentAdminData.phone || '';
                        document.getElementById('adminEditDOB').value = currentAdminData.date_of_birth || '';
                        document.getElementById('adminEditLicenseId').value = currentAdminData.license_id || '';
                    }
                } else {
                    form.style.display = 'none';
                    display.style.display = 'grid';
                    btn.textContent = '‚úèÔ∏è Edit Profile';
                }
            }

            function cancelAdminProfile() {
                document.getElementById('adminEditForm').style.display = 'none';
                document.getElementById('adminProfileDisplay').style.display = 'grid';
                document.getElementById('editAdminProfileBtn').textContent = '‚úèÔ∏è Edit Profile';
                document.getElementById('adminProfileMsg').textContent = '';
            }

            async function handleAdminProfileUpdate(e) {
                e.preventDefault();

                const adminUserId = localStorage.getItem('adminUserId') || localStorage.getItem('userId');
                if (!adminUserId) {
                    document.getElementById('adminProfileMsg').innerHTML = '‚ö†Ô∏è Admin user ID not found';
                    document.getElementById('adminProfileMsg').style.color = 'red';
                    return;
                }

                const updateData = {
                    firstName: document.getElementById('adminEditFirstName').value.trim(),
                    lastName: document.getElementById('adminEditLastName').value.trim(),
                    email: document.getElementById('adminEditEmail').value.trim(),
                    phone: document.getElementById('adminEditPhone').value.trim(),
                    dateOfBirth: document.getElementById('adminEditDOB').value,
                    licenseId: document.getElementById('adminEditLicenseId').value.trim()
                };

                const password = document.getElementById('adminEditPassword').value.trim();
                if (password) {
                    if (password.length < 6) {
                        document.getElementById('adminProfileMsg').innerHTML = '‚ö†Ô∏è Password must be at least 6 characters';
                        document.getElementById('adminProfileMsg').style.color = 'red';
                        return;
                    }
                    updateData.password = password;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/users/${adminUserId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById('adminProfileMsg').innerHTML = '‚úÖ Profile updated successfully!';
                        document.getElementById('adminProfileMsg').style.color = 'green';
                        
                        setTimeout(() => {
                            loadAdminProfile();
                            cancelAdminProfile();
                        }, 1500);
                    } else {
                        document.getElementById('adminProfileMsg').innerHTML = `‚ö†Ô∏è ${result.error || 'Failed to update profile'}`;
                        document.getElementById('adminProfileMsg').style.color = 'red';
                    }
                } catch (error) {
                    console.error('Error updating admin profile:', error);
                    document.getElementById('adminProfileMsg').innerHTML = '‚ö†Ô∏è Network error. Please try again.';
                    document.getElementById('adminProfileMsg').style.color = 'red';
                }
            }

            async function loadAdminProfile() {
                console.log('[DEBUG] loadAdminProfile called');
                const token = localStorage.getItem('bsm_token');
                console.log('[DEBUG] Token:', token ? 'exists' : 'missing');
                let userData = null;
                
                // Verify token matches admin role
                if (token && !token.includes('_admin')) {
                    console.error('Access denied: Not an admin user');
                    alert('Access denied: Admin credentials required');
                    window.location.href = 'admin.html';
                    return;
                }
                
                // Try to fetch from database using token first
                if (token) {
                    try {
                        console.log('[DEBUG] Fetching from /api/me...');
                        const response = await fetch(`${API_BASE}/api/me`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        console.log('[DEBUG] /api/me response status:', response.status);
                        if (response.ok) {
                            userData = await response.json();
                            console.log('[DEBUG] /api/me userData:', userData);
                            
                            // Verify user role is admin
                            if (userData.role !== 'admin') {
                                console.error('Access denied: User is not an admin');
                                alert('Access denied: Admin credentials required');
                                localStorage.clear();
                                window.location.href = 'admin.html';
                                return;
                            }
                        } else {
                            console.warn('[DEBUG] /api/me failed with status:', response.status);
                        }
                    } catch (error) {
                        console.warn('Failed to fetch from /api/me, falling back to localStorage', error);
                    }
                }
                
                // Fallback to localStorage if /api/me failed
                if (!userData) {
                    console.log('[DEBUG] Trying fallback with adminUserId...');
                    const adminUserId = localStorage.getItem('adminUserId');
                    console.log('[DEBUG] adminUserId:', adminUserId);
                    if (!adminUserId) {
                        console.warn('No admin user ID found');
                        alert('Please log in as admin');
                        window.location.href = 'admin.html';
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE}/api/users/${adminUserId}`);
                        userData = await response.json();
                        console.log('[DEBUG] /api/users/:id userData:', userData);
                        
                        // Verify user role is admin
                        if (userData.role !== 'admin') {
                            console.error('Access denied: User is not an admin');
                            alert('Access denied: Admin credentials required');
                            localStorage.clear();
                            window.location.href = 'admin.html';
                            return;
                        }
                    } catch (error) {
                        console.error('Failed to load admin profile:', error);
                        return;
                    }
                }

                console.log('[DEBUG] About to update UI with userData:', userData);
                try {
                    if (userData && userData.user_id) {
                        currentAdminData = userData;

                        const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Not provided';
                        console.log('[DEBUG] Full name:', fullName);
                        const adminFullNameEl = document.getElementById('adminFullName');
                        const adminEmailEl = document.getElementById('adminEmail');
                        const adminPhoneEl = document.getElementById('adminPhone');
                        const adminBirthdayEl = document.getElementById('adminBirthday');
                        const adminUserIdEl = document.getElementById('adminUserId');
                        const adminLicenseIdEl = document.getElementById('adminLicenseId');
                        
                        console.log('[DEBUG] Elements found:', {
                            fullName: !!adminFullNameEl,
                            email: !!adminEmailEl,
                            phone: !!adminPhoneEl,
                            birthday: !!adminBirthdayEl,
                            userId: !!adminUserIdEl,
                            licenseId: !!adminLicenseIdEl
                        });
                        
                        if (adminFullNameEl) {
                            adminFullNameEl.textContent = fullName;
                            console.log('[DEBUG] Set full name to:', fullName);
                        }
                        if (adminEmailEl) adminEmailEl.textContent = userData.email || 'Not provided';
                        if (adminPhoneEl) adminPhoneEl.textContent = userData.phone || 'Not provided';
                        if (adminBirthdayEl) adminBirthdayEl.textContent = userData.date_of_birth || 'Not set';
                        if (adminUserIdEl) adminUserIdEl.textContent = userData.user_id || 'N/A';
                        if (adminLicenseIdEl) adminLicenseIdEl.textContent = userData.license_id || 'Not applicable';
                        
                        console.log('[DEBUG] All fields updated successfully');
                        
                        // Display profile image if available
                        const imgElement = document.getElementById('adminProfileImage');
                        if (userData.profile_image && userData.profile_image.trim() !== '') {
                            imgElement.src = userData.profile_image;
                            imgElement.style.display = 'block';
                            imgElement.onerror = function() {
                                this.style.display = 'none';
                            };
                        } else {
                            imgElement.style.display = 'none';
                        }
                    } else {
                        console.error('[DEBUG] userData is invalid:', userData);
                        // No user data found, clear loading text
                        const adminFullNameEl = document.getElementById('adminFullName');
                        const adminEmailEl = document.getElementById('adminEmail');
                        const adminPhoneEl = document.getElementById('adminPhone');
                        const adminBirthdayEl = document.getElementById('adminBirthday');
                        const adminUserIdEl = document.getElementById('adminUserId');
                        const adminLicenseIdEl = document.getElementById('adminLicenseId');
                        
                        if (adminFullNameEl) adminFullNameEl.textContent = 'Not available';
                        if (adminEmailEl) adminEmailEl.textContent = 'Not available';
                        if (adminPhoneEl) adminPhoneEl.textContent = 'Not available';
                        if (adminBirthdayEl) adminBirthdayEl.textContent = 'Not available';
                        if (adminUserIdEl) adminUserIdEl.textContent = 'Not available';
                        if (adminLicenseIdEl) adminLicenseIdEl.textContent = 'Not applicable';
                        console.error('Failed to load admin profile:', userData ? userData.error : 'No user data');
                    }
                } catch (error) {
                    console.error('Error loading admin profile:', error);
                    console.error('[DEBUG] Error stack:', error.stack);
                    // Clear loading text on error
                    const adminFullNameEl = document.getElementById('adminFullName');
                    const adminEmailEl = document.getElementById('adminEmail');
                    const adminPhoneEl = document.getElementById('adminPhone');
                    const adminBirthdayEl = document.getElementById('adminBirthday');
                    const adminUserIdEl = document.getElementById('adminUserId');
                    const adminLicenseIdEl = document.getElementById('adminLicenseId');
                    
                    if (adminFullNameEl) adminFullNameEl.textContent = 'Error loading';
                    if (adminEmailEl) adminEmailEl.textContent = 'Error loading';
                    if (adminPhoneEl) adminPhoneEl.textContent = 'Error loading';
                    if (adminBirthdayEl) adminBirthdayEl.textContent = 'Error loading';
                    if (adminUserIdEl) adminUserIdEl.textContent = 'Error loading';
                    if (adminLicenseIdEl) adminLicenseIdEl.textContent = 'Not applicable';
                }
            }

            // Event Listeners
            if (createForm) createForm.addEventListener('submit', handleCreateUser);

            // Admin Profile Edit
            const adminProfileForm = document.getElementById('adminProfileForm');
            if (adminProfileForm) adminProfileForm.addEventListener('submit', handleAdminProfileUpdate);

            const recalcBtn = document.getElementById('recalcBtn');
            if (recalcBtn) recalcBtn.addEventListener('click', renderReport);

            // Detailed Report Event Listeners
            const generateMonthlyBtn = document.getElementById('generateMonthlyBtn');
            const generateAnnualBtn = document.getElementById('generateAnnualBtn');
            const clearReportBtn = document.getElementById('clearReportBtn');
            const exportDetailedReportBtn = document.getElementById('exportDetailedReportBtn');
            const exportPDFBtn = document.getElementById('exportPDFBtn');
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            const printReportBtn = document.getElementById('printReportBtn');

            if (generateMonthlyBtn) generateMonthlyBtn.addEventListener('click', generateMonthlyReport);
            if (generateAnnualBtn) generateAnnualBtn.addEventListener('click', generateAnnualReport);
            if (clearReportBtn) clearReportBtn.addEventListener('click', clearReportInputs);
            if (exportDetailedReportBtn) exportDetailedReportBtn.addEventListener('click', exportDetailedReport);
            if (exportPDFBtn) exportPDFBtn.addEventListener('click', exportPDF);
            if (exportCSVBtn) exportCSVBtn.addEventListener('click', exportCSV);
            if (printReportBtn) printReportBtn.addEventListener('click', printDetailedReport);

            // Add input change listeners to clear the other field
            const reportMonthInput = document.getElementById('reportMonth');
            const reportYearInput = document.getElementById('reportYear');
            
            if (reportMonthInput) {
                reportMonthInput.addEventListener('change', function() {
                    if (this.value) {
                        reportYearInput.value = '';
                    }
                });
            }
            
            if (reportYearInput) {
                reportYearInput.addEventListener('change', function() {
                    if (this.value) {
                        reportMonthInput.value = '';
                    }
                });
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    // Clear all admin session keys
                    localStorage.removeItem('bsm_token');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('adminId');
                    localStorage.removeItem('adminUserId');
                    localStorage.removeItem('loggedInAdmin');
                    localStorage.removeItem('adminName');
                    alert('You have been logged out.');
                    window.location.href = 'admin.html';
                });
            }

            // 30-minute inactivity timeout
            let inactivityTimer;
            const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    // Clear all admin session keys
                    localStorage.removeItem('bsm_token');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('adminId');
                    localStorage.removeItem('adminUserId');
                    localStorage.removeItem('loggedInAdmin');
                    localStorage.removeItem('adminName');
                    alert('Your session has expired due to inactivity.');
                    window.location.href = 'admin.html';
                }, INACTIVITY_TIMEOUT);
            }

            // Track user activity to reset timer
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });

            // Start the inactivity timer
            resetInactivityTimer();

            // Initial Security Check - Verify admin access
            const token = localStorage.getItem('bsm_token');
            const adminUserId = localStorage.getItem('adminUserId');
            
            if (!token || !token.includes('_admin')) {
                console.error('Access denied: Invalid admin token');
                alert('Access denied: Admin credentials required');
                localStorage.clear();
                window.location.href = 'admin.html';
                throw new Error('Unauthorized access');
            }
            
            // Initial Load
            (async function initializeDashboard() {
                try {
                    // Load admin profile first
                    await loadAdminProfile();
                    
                    // Clear any stray autocomplete or demo values in the form fields
                    try {
                        const emailEl = document.getElementById('email');
                        if (emailEl) {
                            emailEl.value = '';
                            emailEl.setAttribute('autocomplete', 'off');
                        }
                        const formEl = document.getElementById('createUserForm');
                        if (formEl) formEl.setAttribute('autocomplete', 'off');
                    } catch (e) { /* ignore */ }

                    await fetchUsersFromAPI();
                    await fetchAssignmentsFromAPI();
                    updateUserStats();
                    await renderAssignments();
                    await renderReport();
                } catch (error) {
                    console.error('Error initializing dashboard:', error);
                }
            })();

            // Show alert if a new patient was registered (from create_account)
            try {
                const notifyRaw = localStorage.getItem('admin_patient_notify');
                if (notifyRaw) {
                    const n = JSON.parse(notifyRaw);
                    if (n && n.name) {
                        if (confirm(`New patient registered: ${n.name} (${n.email}).\nOpen Patient Records?`)) {
                            // clear notify and open patient records
                            localStorage.removeItem('admin_patient_notify');
                            window.location.href = 'patient_records.html';
                        }
                    }
                }
            } catch (e) { console.warn('admin notify check failed', e); }
        });
    </script>
</body>

</html>