<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .welcome-header h1 {
      color: #004080;
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .welcome-header p {
      color: #666;
      font-size: 1rem;
      margin-bottom: 30px;
    }

    .summary-section h2 {
      color: #004080;
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .summary-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .summary-card h3 {
      color: #004080;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .summary-card .count {
      font-size: 2rem;
      font-weight: bold;
      color: #004080;
      margin-bottom: 10px;
    }

    .summary-card p {
      color: #666;
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .summary-card button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 500;
    }

    .summary-card button:hover {
      background: #dee2e6;
    }

    .pending-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .pending-section h2 {
      color: #004080;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .pending-section a {
      color: #004080;
      text-decoration: underline;
      font-weight: 500;
    }

    .pending-banner {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px 20px;
      margin-bottom: 15px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pending-banner button {
      background: transparent;
      border: none;
      color: #856404;
      font-size: 1.2rem;
      cursor: pointer;
      font-weight: bold;
    }

    .patient-list-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .patient-list-section h2 {
      color: #004080;
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .search-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-controls input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      flex: 1;
      min-width: 200px;
    }

    .search-controls button {
      background: #004080;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 500;
    }

    .search-controls button:hover {
      background: #0066cc;
    }

    .search-controls button.secondary {
      background: #6c757d;
    }

    .search-controls button.secondary:hover {
      background: #5a6268;
    }

    .patient-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .patient-table thead {
      background: #004080;
      color: white;
    }

    .patient-table th {
      padding: 14px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .patient-table td {
      padding: 14px 16px;
      font-size: 0.9rem;
      color: #212529;
      border-bottom: 1px solid #e9ecef;
    }

    .patient-table tbody tr:hover {
      background: #f8f9fa;
      cursor: pointer;
    }

    .logout-btn {
      margin-top: 30px;
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .logout-btn:hover {
      background: #c82333;
    }
  </style>
</head>

<body>
<header>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="patient.html">Patient</a></li>
      <li><a href="specialist.html">Specialist</a></li>
      <li><a href="clinic.html">Clinic</a></li>
      <li><a href="contact.html">Contact Us</a></li>
    </ul>
  </nav>
</header>

<main class="container">
  <div class="welcome-header">
    <h1 id="welcomeMsg">Welcome, Staff</h1>
    <p>Manage patients, update records, and assist with daily clinic operations.</p>
  </div>

  <!-- Staff Profile Section -->
  <div class="summary-section" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <img id="profileImageDisplay" src="" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none; border: 3px solid #007bff;" />
        <h2 style="margin: 0;">üë§ My Profile</h2>
      </div>
      <button onclick="window.location.href='edit_profile_staff.html'" id="editProfileBtn" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">‚úèÔ∏è Edit Profile</button>
    </div>

    <!-- Profile Display -->
    <div id="profileDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div><strong>üìß Email:</strong> <span id="profileEmail">Loading...</span></div>
      <div><strong>üì± Phone:</strong> <span id="profilePhone">Loading...</span></div>
      <div><strong>üéÇ Birthday:</strong> <span id="profileBirthday">Loading...</span></div>
      <div><strong>üÜî Working ID:</strong> <span id="profileWorkingId">Loading...</span></div>
    </div>

    <!-- Edit Profile Form -->
    <div id="editProfileForm" style="display: none; margin-top: 20px;">
      <h3 style="color: #004080; margin-bottom: 15px;">Edit Your Profile</h3>
      <form id="profileUpdateForm" style="display: flex; flex-direction: column; gap: 15px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">First Name *</label>
            <input type="text" id="editFirstName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Last Name *</label>
            <input type="text" id="editLastName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email *</label>
            <input type="email" id="editEmail" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phone</label>
            <input type="tel" id="editPhone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Date of Birth</label>
            <input type="date" id="editDateOfBirth" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Working ID</label>
            <input type="text" id="editWorkingId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">New Password</label>
            <input type="password" id="editPassword" placeholder="Leave blank to keep current" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <small style="color: #666;">Leave blank if you don't want to change password</small>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Profile Image</label>
            <input type="file" id="editProfileImage" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <small style="color: #666;">Upload a new profile picture (optional)</small>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button type="submit" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Changes</button>
          <button type="button" onclick="cancelEditProfile()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">‚ùå Cancel</button>
        </div>
      </form>
      <div id="profileUpdateMsg" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>
  </div>

  <!-- Today's Summary -->
  <div class="summary-section">
    <h2>Today's Summary</h2>
    <div class="summary-grid">
      <div class="summary-card">
        <h3>Total Patients</h3>
        <div class="count" id="totalPatients">5</div>
      </div>

      <div class="summary-card">
        <h3>Email Specialists</h3>
        <p>Quickly contact specialists about flagged patients or urgent updates.</p>
        <button onclick="window.location.href='staff_email_specialists.html'">Email Specialists</button>
      </div>

      <div class="summary-card">
        <h3>Email Patients</h3>
        <p>Send reminders, instructions, or follow-up messages to patients.</p>
        <button onclick="window.location.href='staff_email_patients.html'">Email Patients</button>
      </div>

      <div class="summary-card">
        <h3>Thresholds</h3>
        <p>Manage system and per-user thresholds for blood sugar alerts.</p>
        <button onclick="window.location.href='thresholds.html'">Open Thresholds</button>
      </div>
    </div>
  </div>

  <!-- Pending Outbox -->
  <div class="pending-section">
    <h2>Pending Outbox <span id="unreadBadge" style="display:none;background:#dc3545;color:white;padding:4px 10px;border-radius:12px;font-size:0.85rem;margin-left:10px;font-weight:600;"></span></h2>
    <a href="staff_view_messages.html" style="display:inline-block;margin-bottom:15px;padding:10px 20px;background:#667eea;color:white;text-decoration:none;border-radius:6px;font-weight:500;">üì¨ View All Contact Messages</a>
    
    <div id="pendingBanner" style="display: none;" class="pending-banner">
      <span id="pendingMessage">New contact message: lee ‚Äî hello</span>
      <button onclick="dismissPending()">Dismiss</button>
    </div>
    
    <p id="queuedCount">You have <strong>3</strong> queued email(s) waiting to be sent.</p>
  </div>

  <!-- Patient List -->
  <div class="patient-list-section">
    <h2>Patient List</h2>
    
    <div class="search-controls">
      <input type="text" id="searchName" placeholder="Search by Name">
      <input type="text" id="searchId" placeholder="Search by Patient ID">
      <button onclick="searchPatients()">Search</button>
      <button class="secondary" onclick="resetSearch()">Reset</button>
    </div>

    <table class="patient-table">
      <thead>
        <tr>
          <th>Patient Number</th>
          <th>Name</th>
          <th>Last Checked</th>
        </tr>
      </thead>
      <tbody id="patientTableBody">
        <tr onclick="viewPatient(1, 'Alice Lee')">
          <td>1</td>
          <td>Alice Lee</td>
          <td>-</td>
        </tr>
      </tbody>
    </table>
  </div>

  <button class="logout-btn" id="logoutBtn">Logout</button>
</main>

<footer>
  <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
</footer>

<script>
  // Display staff email from localStorage
  const welcomeMsg = document.getElementById('welcomeMsg');
  const loggedInStaff = localStorage.getItem('loggedInStaff');
  const staffName = localStorage.getItem('staffName') || 'Staff2';
  
  if (loggedInStaff) {
    welcomeMsg.textContent = `Welcome, ${staffName}`;
  } else {
    // redirect to login if not logged in
    window.location.href = 'staff.html';
  }

  // Load patient count
  function loadPatientCount() {
    try {
      const patients = JSON.parse(localStorage.getItem('patients') || '[]');
      const count = Array.isArray(patients) ? patients.length : 0;
      document.getElementById('totalPatients').textContent = count;
    } catch (e) {
      document.getElementById('totalPatients').textContent = '5';
    }
  }

  // Load pending messages
  function loadPendingMessages() {
    try {
      const pending = JSON.parse(localStorage.getItem('pending_emails') || '[]');
      const count = Array.isArray(pending) ? pending.length : 0;
      document.getElementById('queuedCount').innerHTML = `You have <strong>${count}</strong> queued email(s) waiting to be sent.`;
      
      // Check for unread contact messages
      const contacts = JSON.parse(localStorage.getItem('contact_messages') || '[]');
      const unreadCount = contacts.filter(m => !m.read).length;
      const badge = document.getElementById('unreadBadge');
      if (unreadCount > 0) {
        badge.textContent = `${unreadCount} New`;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
      
      // Check for contact page notify
      const notify = localStorage.getItem('pending_outbox_notify');
      if (notify) {
        const n = JSON.parse(notify);
        document.getElementById('pendingBanner').style.display = 'flex';
        document.getElementById('pendingMessage').textContent = `New contact message: ${n.summary}`;
      }
    } catch (e) {
      console.warn('Failed to load pending messages', e);
    }
  }

  function dismissPending() {
    localStorage.removeItem('pending_outbox_notify');
    document.getElementById('pendingBanner').style.display = 'none';
  }

  // Load patients into table
  async function loadPatients() {
    const tbody = document.getElementById('patientTableBody');
    
    try {
      // Try loading from database first
      const token = localStorage.getItem('bsm_token') || '';
      const response = await fetch('http://127.0.0.1:5000/api/patients', {
        headers: {
          'Accept': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        const patients = (data.patients || []).map(p => ({
          patientId: p.patient_id,
          userId: p.user_id,
          number: p.patient_id,
          name: `${p.first_name || ''} ${p.last_name || ''}`.trim(),
          lastChecked: p.last_date_time ? String(p.last_date_time).split('T')[0] : '-'
        }));
        
        // Cache to localStorage
        localStorage.setItem('patients', JSON.stringify(patients));
        renderPatients(patients);
        return;
      }
    } catch (e) {
      console.warn('Failed to load patients from database, falling back to localStorage', e);
    }
    
    // Fallback to localStorage
    try {
      let patients = JSON.parse(localStorage.getItem('patients') || '[]');
      if (!Array.isArray(patients) && typeof patients === 'object') {
        patients = Object.values(patients);
      }
      renderPatients(patients);
    } catch (e) {
      console.error('Failed to load patients', e);
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px; color: red;">Error loading patients</td></tr>';
    }
  }

  function renderPatients(patients) {
    const tbody = document.getElementById('patientTableBody');
    
    if (!patients || patients.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">No patients found</td></tr>';
      return;
    }

    tbody.innerHTML = patients.map(p => {
      const name = p.name || p.fullName || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'Unknown';
      const id = p.patientId || p.patient_id || p.number || p.id || '-';
      const lastChecked = p.lastChecked || p.last_date_time || '-';
      
      return `
        <tr onclick="viewPatient('${id}', '${name}')">
          <td>${id}</td>
          <td>${name}</td>
          <td>${lastChecked}</td>
        </tr>
      `;
    }).join('');
  }

  function viewPatient(id, name) {
    localStorage.setItem('viewingPatientNumber', id);
    localStorage.setItem('viewingPatientName', name);
    window.location.href = 'staff_view.html';
  }

  function searchPatients() {
    const nameVal = document.getElementById('searchName').value.toLowerCase();
    const idVal = document.getElementById('searchId').value.toLowerCase();
    
    try {
      let patients = JSON.parse(localStorage.getItem('patients') || '[]');
      if (!Array.isArray(patients) && typeof patients === 'object') {
        patients = Object.values(patients);
      }
      
      const filtered = patients.filter(p => {
        const name = (p.name || p.fullName || `${p.first_name || ''} ${p.last_name || ''}`.trim() || '').toLowerCase();
        const id = String(p.patientId || p.patient_id || p.number || p.id || '').toLowerCase();
        
        const matchName = !nameVal || name.includes(nameVal);
        const matchId = !idVal || id.includes(idVal);
        
        return matchName && matchId;
      });
      
      const tbody = document.getElementById('patientTableBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">No matching patients found</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(p => {
        const name = p.name || p.fullName || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'Unknown';
        const id = p.patientId || p.patient_id || p.number || p.id || '-';
        const lastChecked = p.lastChecked || p.last_date_time || '-';
        
        return `
          <tr onclick="viewPatient('${id}', '${name}')">
            <td>${id}</td>
            <td>${name}</td>
            <td>${lastChecked}</td>
          </tr>
        `;
      }).join('');
    } catch (e) {
      console.warn('Search failed', e);
    }
  }

  function resetSearch() {
    document.getElementById('searchName').value = '';
    document.getElementById('searchId').value = '';
    loadPatients();
  }

  // ========== Profile Edit Functions ==========
  let currentUserData = null;

  function toggleEditProfile() {
    const profileDisplay = document.getElementById('profileDisplay');
    const editForm = document.getElementById('editProfileForm');
    const btn = document.getElementById('editProfileBtn');

    if (editForm.style.display === 'none') {
      // Show edit form
      editForm.style.display = 'block';
      profileDisplay.style.display = 'none';
      btn.textContent = 'üëÅÔ∏è View Profile';

      // Pre-fill form with current data
      if (currentUserData) {
        document.getElementById('editFirstName').value = currentUserData.firstName || '';
        document.getElementById('editLastName').value = currentUserData.lastName || '';
        document.getElementById('editEmail').value = currentUserData.email || '';
        document.getElementById('editPhone').value = currentUserData.phone || '';
        document.getElementById('editDateOfBirth').value = currentUserData.dateOfBirth || '';
        document.getElementById('editWorkingId').value = currentUserData.workingId || '';
      }
    } else {
      // Show profile display
      editForm.style.display = 'none';
      profileDisplay.style.display = 'grid';
      btn.textContent = '‚úèÔ∏è Edit Profile';
    }
  }

  function cancelEditProfile() {
    document.getElementById('editProfileForm').style.display = 'none';
    document.getElementById('profileDisplay').style.display = 'grid';
    document.getElementById('editProfileBtn').textContent = '‚úèÔ∏è Edit Profile';
    document.getElementById('profileUpdateMsg').textContent = '';
  }

  // Handle profile update form submission
  document.getElementById('profileUpdateForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const userId = localStorage.getItem('staffUserId') || localStorage.getItem('userId');
    if (!userId) {
      document.getElementById('profileUpdateMsg').innerHTML = '‚ö†Ô∏è User ID not found';
      document.getElementById('profileUpdateMsg').style.color = 'red';
      return;
    }

    const updateData = {
      firstName: document.getElementById('editFirstName').value,
      lastName: document.getElementById('editLastName').value,
      email: document.getElementById('editEmail').value,
      phone: document.getElementById('editPhone').value,
      dateOfBirth: document.getElementById('editDateOfBirth').value,
      workingId: document.getElementById('editWorkingId').value
    };

    const password = document.getElementById('editPassword').value;
    if (password) {
      if (password.length < 6) {
        document.getElementById('profileUpdateMsg').innerHTML = '‚ö†Ô∏è Password must be at least 6 characters';
        document.getElementById('profileUpdateMsg').style.color = 'red';
        return;
      }
      updateData.password = password;
    }

    try {
      const response = await fetch(`http://127.0.0.1:5000/api/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData)
      });

      const result = await response.json();

      if (response.ok) {
        document.getElementById('profileUpdateMsg').innerHTML = '‚úÖ Profile updated successfully!';
        document.getElementById('profileUpdateMsg').style.color = 'green';
        
        // Reload profile data
        setTimeout(() => {
          loadStaffProfile();
          cancelEditProfile();
        }, 1500);
      } else {
        document.getElementById('profileUpdateMsg').innerHTML = `‚ö†Ô∏è ${result.error || 'Failed to update profile'}`;
        document.getElementById('profileUpdateMsg').style.color = 'red';
      }
    } catch (error) {
      console.error('Error updating profile:', error);
      document.getElementById('profileUpdateMsg').innerHTML = '‚ö†Ô∏è Network error. Please try again.';
      document.getElementById('profileUpdateMsg').style.color = 'red';
    }
  });

  // Load staff profile data
  async function loadStaffProfile() {
    const userId = localStorage.getItem('staffUserId') || localStorage.getItem('userId');
    
    if (!userId) {
      console.warn('No staff user ID found');
      return;
    }

    try {
      const response = await fetch(`http://127.0.0.1:5000/api/users/${userId}`);
      const userData = await response.json();

      if (response.ok && userData.user) {
        currentUserData = {
          firstName: userData.user.first_name,
          lastName: userData.user.last_name,
          email: userData.user.email,
          phone: userData.user.phone || 'Not provided',
          dateOfBirth: userData.user.date_of_birth || '',
          workingId: userData.user.working_id || 'N/A'
        };

        // Update profile display
        document.getElementById('profileEmail').textContent = currentUserData.email;
        document.getElementById('profilePhone').textContent = currentUserData.phone;
        document.getElementById('profileBirthday').textContent = currentUserData.dateOfBirth || 'Not set';
        document.getElementById('profileWorkingId').textContent = currentUserData.workingId;
        
        // Display profile image if available
        if (userData.user.profile_image) {
          const imgElement = document.getElementById('profileImageDisplay');
          imgElement.src = userData.user.profile_image;
          imgElement.style.display = 'block';
        }
      } else {
        console.error('Failed to load staff profile:', userData.error);
      }
    } catch (error) {
      console.error('Error loading staff profile:', error);
    }
  }

  // Logout functionality
  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('loggedInStaff');
    localStorage.removeItem('staffName');
    window.location.href = 'staff.html';
  });

  // Initialize
  loadPatientCount();
  loadPendingMessages();
  loadPatients();
  loadStaffProfile();

  // Refresh every 30 seconds
  setInterval(() => {
    loadPatientCount();
    loadPendingMessages();
  }, 30000);
</script>
</body>
</html>
