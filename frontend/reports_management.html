<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Management - Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .dashboard-header { margin-bottom: 30px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .form-field { margin-bottom: 15px; }
        .form-field label { display: block; margin-bottom: 6px; color: #004080; font-weight: 500; }
        .table-wrapper { overflow-x: auto; }
        .hint { margin-bottom: 20px; padding: 12px 16px; background: #f8f9fa; border-radius: 6px; color: #666; font-size: 0.9rem; line-height: 1.6; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="logo">ü©∏ Blood Sugar Monitoring</div>
        <nav>
            <a href="admin_dashboard.html">Dashboard</a>
            <a href="user_management.html">Users</a>
            <a href="patient_assignments.html">Assignments</a>
            <a href="reports_management.html" class="active">Reports</a>
        </nav>
        <div>
            <button id="logoutBtn" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Logout</button>
        </div>
    </header>

    <main class="container">
        <section class="dashboard-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="color: #004080; font-size: 2rem; margin: 0;">Monthly & Annual Reports</h1>
                <button onclick="window.location.href='admin_dashboard.html'" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(102,126,234,0.3);" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102,126,234,0.4)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(102,126,234,0.3)'">
                    ‚Üê Back to Dashboard
                </button>
            </div>
            <p class="subtext" style="color: #666; font-size: 1rem;">
                Generate comprehensive reports with patient statistics, blood sugar trends, and AI-powered insights.
            </p>
        </section>

        <section class="card">
            <h2 style="color: #004080; font-size: 1.5rem; margin-bottom: 20px;">Generate Reports</h2>
            <p class="hint">
                Generate comprehensive reports including patient statistics, blood sugar trends, and AI-powered insights on food/activity triggers for abnormal readings.
            </p>
            
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 20px; margin-bottom: 20px; align-items: end;">
                <div class="form-field">
                    <label for="reportMonth" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Select Month</label>
                    <input type="month" id="reportMonth" placeholder="YYYY-MM" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                </div>
                <div class="form-field">
                    <label for="reportYear" style="display: block; margin-bottom: 6px; color: #004080; font-weight: 500; font-size: 0.95rem;">Select Year</label>
                    <input type="number" id="reportYear" min="2020" max="2030" placeholder="e.g. 2025" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;" />
                </div>
                <div class="form-actions" style="display: flex; gap: 12px;">
                    <button type="button" id="generateMonthlyBtn" style="background: #007bff; color: white; padding: 10px 24px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: 500;">Monthly Report</button>
                    <button type="button" id="generateAnnualBtn" style="background: #28a745; color: white; padding: 10px 24px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: 500;">Annual Report</button>
                </div>
                <div>
                    <button type="button" id="clearReportBtn" style="background: #6c757d; color: white; padding: 10px 24px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: 500;">Clear</button>
                </div>
            </div>

            <div id="detailedReportArea" style="display: none;">
                <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px;">
                    <h3 id="reportTitle" style="color: #004080; font-size: 1.3rem; margin-bottom: 10px;">Report</h3>
                    <p id="reportPeriod" style="color: #666; font-size: 0.95rem;">Period: -</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <h4 style="color: #004080; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 8px;">üìä Patient Overview</h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">Total Active Patients: <strong id="reportTotalPatients">0</strong></li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">Patients with Readings: <strong id="reportActivePatients">0</strong></li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">Total Readings: <strong id="reportTotalReadings">0</strong></li>
                            <li style="padding: 8px 0;">Average Readings per Patient: <strong id="reportAvgReadings">0</strong></li>
                        </ul>
                    </div>

                    <div style="background: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <h4 style="color: #004080; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #28a745; padding-bottom: 8px;">üìà Blood Sugar Trends</h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">Overall Average: <strong id="reportOverallAvg">0</strong> mg/dL</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; color: #28a745;">Normal Readings: <strong id="reportNormalCount">0</strong> (<strong id="reportNormalPct">0%</strong>)</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; color: #ffc107;">Borderline: <strong id="reportBorderlineCount">0</strong> (<strong id="reportBorderlinePct">0%</strong>)</li>
                            <li style="padding: 8px 0; color: #dc3545;">Abnormal: <strong id="reportAbnormalCount">0</strong> (<strong id="reportAbnormalPct">0%</strong>)</li>
                        </ul>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px;">
                    <h4 style="color: #004080; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #17a2b8; padding-bottom: 8px;">üìä Detailed Trend Analysis</h4>
                    <div id="trendAnalysisArea" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <h5 style="color: #004080; font-size: 1rem; margin-bottom: 10px;">Highest Overall Reading</h5>
                            <p style="font-size: 1.8rem; font-weight: bold; color: #dc3545; margin: 0;"><span id="trendHighestValue">0.00</span> mg/dL</p>
                            <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">Patient: <span id="trendHighestPatient">-</span></p>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <h5 style="color: #004080; font-size: 1rem; margin-bottom: 10px;">Lowest Overall Reading</h5>
                            <p style="font-size: 1.8rem; font-weight: bold; color: #28a745; margin: 0;"><span id="trendLowestValue">0.00</span> mg/dL</p>
                            <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">Patient: <span id="trendLowestPatient">-</span></p>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <h5 style="color: #004080; font-size: 1rem; margin-bottom: 10px;">Most Stable Patient</h5>
                            <p style="font-size: 1.1rem; font-weight: bold; color: #28a745; margin: 0;"><span id="trendMostStable">-</span></p>
                            <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">Variance: <span id="trendStableVariance">0.00</span></p>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <h5 style="color: #004080; font-size: 1rem; margin-bottom: 10px;">Most At-Risk Patient</h5>
                            <p style="font-size: 1.1rem; font-weight: bold; color: #dc3545; margin: 0;"><span id="trendMostAtRisk">-</span></p>
                            <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">Abnormal: <span id="trendRiskPct">0.00</span>%</p>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px;">
                    <h4 style="color: #004080; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">üë• Patient Statistics (Top 10)</h4>
                    <div class="table-wrapper">
                        <table id="patientStatsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 0.9rem; color: #495057;">Patient Name</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #495057;">Readings</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #495057;">Average (mg/dL)</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #495057;">Highest</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #495057;">Lowest</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #495057;">Abnormal %</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #495057;">Trend</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px;">
                    <h4 style="color: #004080; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #dc3545; padding-bottom: 8px;">‚ö†Ô∏è Abnormal Readings Details</h4>
                    <div id="abnormalDetailsArea">
                        <p style="color: #666; padding: 10px 0;">Loading abnormal readings analysis...</p>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h4 style="color: #004080; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #ffc107; padding-bottom: 8px;">ü§ñ AI-Powered Insights: Food & Activity Triggers</h4>
                    <div id="aiInsightsArea">
                        <p style="color: #666; padding: 10px 0;">AI analysis will appear here after generating a report...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
    </footer>

    <script src="js/api.js"></script>
    <script>
        const API_BASE = 'http://127.0.0.1:5000';

        // Check admin authorization
        const token = localStorage.getItem('bsm_token');
        if (!token || !token.includes('_admin')) {
            alert('Access denied: Admin credentials required');
            window.location.href = 'admin.html';
        }

        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                localStorage.clear();
                alert('You have been logged out.');
                window.location.href = 'admin.html';
            });
        }

        // Report generation functions (copy from admin_dashboard.html)
        document.getElementById('generateMonthlyBtn')?.addEventListener('click', generateMonthlyReport);
        document.getElementById('generateAnnualBtn')?.addEventListener('click', generateAnnualReport);
        document.getElementById('clearReportBtn')?.addEventListener('click', clearReport);

        async function generateMonthlyReport() {
            const monthInput = document.getElementById('reportMonth').value;
            if (!monthInput) {
                alert('Please select a month');
                return;
            }

            const [year, month] = monthInput.split('-');
            await fetchAndDisplayReport('monthly', { year: parseInt(year), month: parseInt(month) });
        }

        async function generateAnnualReport() {
            const year = document.getElementById('reportYear').value;
            if (!year) {
                alert('Please select a year');
                return;
            }

            await fetchAndDisplayReport('annual', { year: parseInt(year) });
        }

        async function fetchAndDisplayReport(type, params) {
            try {
                const headers = { 'Authorization': `Bearer ${token}` };
                const url = type === 'monthly' 
                    ? `${API_BASE}/api/admin/reports/monthly?year=${params.year}&month=${params.month}`
                    : `${API_BASE}/api/admin/reports/annual?year=${params.year}`;

                const response = await fetch(url, { headers });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch report');
                }
                
                const data = await response.json();
                displayReport(data, type, params);
            } catch (error) {
                console.error('Error fetching report:', error);
                alert('Failed to generate report. Please try again.');
            }
        }

        function displayReport(data, type, params) {
            const reportArea = document.getElementById('detailedReportArea');
            reportArea.style.display = 'block';

            // Set title and period
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            if (type === 'monthly') {
                document.getElementById('reportTitle').textContent = `Monthly Report - ${monthNames[params.month - 1]} ${params.year}`;
                document.getElementById('reportPeriod').textContent = `Period: ${monthNames[params.month - 1]} ${params.year}`;
            } else {
                document.getElementById('reportTitle').textContent = `Annual Report - ${params.year}`;
                document.getElementById('reportPeriod').textContent = `Period: Year ${params.year}`;
            }

            // Patient Overview
            document.getElementById('reportTotalPatients').textContent = data.total_patients || 0;
            document.getElementById('reportActivePatients').textContent = data.active_patients || 0;
            document.getElementById('reportTotalReadings').textContent = data.total_readings || 0;
            document.getElementById('reportAvgReadings').textContent = (data.avg_readings_per_patient || 0).toFixed(1);

            // Blood Sugar Trends
            document.getElementById('reportOverallAvg').textContent = (data.overall_avg_glucose || 0).toFixed(1);
            document.getElementById('reportNormalCount').textContent = data.normal_count || 0;
            document.getElementById('reportNormalPct').textContent = (data.normal_percentage || 0).toFixed(1);
            document.getElementById('reportBorderlineCount').textContent = data.borderline_count || 0;
            document.getElementById('reportBorderlinePct').textContent = (data.borderline_percentage || 0).toFixed(1);
            document.getElementById('reportAbnormalCount').textContent = data.abnormal_count || 0;
            document.getElementById('reportAbnormalPct').textContent = (data.abnormal_percentage || 0).toFixed(1);

            // Trend Analysis
            if (data.highest_reading) {
                document.getElementById('trendHighestValue').textContent = data.highest_reading.glucose_level?.toFixed(2) || '0.00';
                document.getElementById('trendHighestPatient').textContent = data.highest_reading.patient_name || '-';
            }
            if (data.lowest_reading) {
                document.getElementById('trendLowestValue').textContent = data.lowest_reading.glucose_level?.toFixed(2) || '0.00';
                document.getElementById('trendLowestPatient').textContent = data.lowest_reading.patient_name || '-';
            }
            if (data.most_stable_patient) {
                document.getElementById('trendMostStable').textContent = data.most_stable_patient.patient_name || '-';
                document.getElementById('trendStableVariance').textContent = data.most_stable_patient.variance?.toFixed(2) || '0.00';
            }
            if (data.most_at_risk_patient) {
                document.getElementById('trendMostAtRisk').textContent = data.most_at_risk_patient.patient_name || '-';
                document.getElementById('trendRiskPct').textContent = data.most_at_risk_patient.abnormal_percentage?.toFixed(2) || '0.00';
            }

            // Patient Statistics Table
            renderPatientStatsTable(data.patient_stats || []);

            // Abnormal Details
            renderAbnormalDetails(data.abnormal_readings || []);

            // AI Insights
            renderAIInsights(data.ai_insights || {});
        }

        function renderPatientStatsTable(stats) {
            const tbody = document.querySelector('#patientStatsTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            
            if (stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No patient data available for this period.</td></tr>';
                return;
            }

            stats.slice(0, 10).forEach(patient => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                
                const trendIcon = patient.trend === 'improving' ? 'üìà' : 
                                 patient.trend === 'stable' ? '‚û°Ô∏è' : 'üìâ';
                
                row.innerHTML = `
                    <td style="padding: 12px; text-align: left;">${patient.patient_name || 'N/A'}</td>
                    <td style="padding: 12px; text-align: center;">${patient.reading_count || 0}</td>
                    <td style="padding: 12px; text-align: center;">${(patient.avg_glucose || 0).toFixed(1)}</td>
                    <td style="padding: 12px; text-align: center;">${(patient.max_glucose || 0).toFixed(1)}</td>
                    <td style="padding: 12px; text-align: center;">${(patient.min_glucose || 0).toFixed(1)}</td>
                    <td style="padding: 12px; text-align: center;">${(patient.abnormal_percentage || 0).toFixed(1)}%</td>
                    <td style="padding: 12px; text-align: center;">${trendIcon} ${patient.trend || 'stable'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAbnormalDetails(abnormalReadings) {
            const container = document.getElementById('abnormalDetailsArea');
            if (!container) return;

            if (abnormalReadings.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 10px 0;">No abnormal readings found for this period. Great news!</p>';
                return;
            }

            container.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">Found <strong>${abnormalReadings.length}</strong> abnormal readings in this period. Below are the details:</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${abnormalReadings.slice(0, 20).map(reading => `
                        <div style="background: #fff5f5; border-left: 3px solid #dc3545; padding: 12px 15px; margin-bottom: 10px; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #004080;">${reading.patient_name || 'Unknown'}</strong>
                                <span style="color: #dc3545; font-weight: bold; font-size: 1.1rem;">${reading.glucose_level?.toFixed(1) || '0'} mg/dL</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                ${reading.reading_date ? new Date(reading.reading_date).toLocaleDateString() : 'Date unknown'} ‚Ä¢ 
                                ${reading.meal_type || 'Unknown meal type'}
                            </div>
                            ${reading.food_consumed ? `<div style="margin-top: 5px; font-size: 0.85rem; color: #555;">Food: ${reading.food_consumed}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAIInsights(insights) {
            const container = document.getElementById('aiInsightsArea');
            if (!container) return;

            if (!insights || Object.keys(insights).length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 10px 0;">No AI insights available for this period.</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 15px;">';
            
            if (insights.common_food_triggers && insights.common_food_triggers.length > 0) {
                html += `
                    <div style="background: #fff8e1; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <h5 style="color: #004080; margin-bottom: 10px;">üçΩÔ∏è Common Food Triggers</h5>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${insights.common_food_triggers.map(food => `<li style="color: #666; margin-bottom: 5px;">${food}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (insights.activity_patterns && insights.activity_patterns.length > 0) {
                html += `
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                        <h5 style="color: #004080; margin-bottom: 10px;">üèÉ Activity Patterns</h5>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${insights.activity_patterns.map(activity => `<li style="color: #666; margin-bottom: 5px;">${activity}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function clearReport() {
            document.getElementById('detailedReportArea').style.display = 'none';
            document.getElementById('reportMonth').value = '';
            document.getElementById('reportYear').value = '';
        }

        // Set default date values
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            
            document.getElementById('reportMonth').value = `${currentYear}-${currentMonth}`;
            document.getElementById('reportYear').value = currentYear;
        });
    </script>
</body>
</html>
