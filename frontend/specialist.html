<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Specialist Portal</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .section-box {
      background-color: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .login-section {
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
      margin-bottom: 20px;
    }

    .login-section h2 {
      font-size: 2rem;
      color: #004080;
      margin-bottom: 20px;
    }

    .login-section label {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
      display: inline-block;
    }

    .login-section input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .login-section input[type="submit"] {
      background-color: #004080;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .login-section input[type="submit"]:hover {
      background-color: #003366;
    }

    .note {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #333;
    }

    .specialists-section h1 {
      font-size: 2rem;
      color: #004080;
      margin-bottom: 10px;
      text-align: center;
    }

    .specialists-section p {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .specialists {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
      padding: 20px 0;
    }

    .specialist-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 250px;
      text-align: center;
      padding: 20px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .specialist-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .specialist-card img {
      border-radius: 50%;
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin-bottom: 15px;
    }

    .specialist-card h3 {
      margin: 10px 0 5px 0;
      color: #004080;
    }

    .specialist-card p {
      font-size: 0.9rem;
      color: #333;
      margin-bottom: 5px;
    }

    .reviews {
      text-align: center;
      padding: 50px 20px;
      background-color: #f5f9fc;
      margin-top: 40px;
      border-radius: 10px;
    }

    .reviews h2 {
      font-size: 2rem;
      margin-bottom: 30px;
      color: #004080;
    }

    .review-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .review-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .review-card p {
      font-size: 0.95rem;
      color: #333;
    }

    .review-author {
      font-weight: bold;
      margin-top: 10px;
      color: #004080;
    }
  </style>
</head>

<body>
  <!-- HEADER / NAV -->
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="patient.html">Patient</a></li>
        <li><a href="specialist.html" class="active">Specialist</a></li>
        <li><a href="clinic.html">Clinic</a></li>
        <li><a href="contact.html">Contact Us</a></li>
      </ul>
    </nav>
  </header>

  <!-- SERVER MODE BANNER (hidden by default) -->
  <div id="serverModeBanner" style="display:none;padding:10px;text-align:center;font-weight:700;
       background:#fff3cd;color:#856404;border:1px solid #ffeeba;">
    Running in DEMO mode (backend DEMO_AUTH=1) — some features are simulated.
  </div>

  <!-- MAIN -->
  <main class="container">
    <!-- SPECIALIST LOGIN -->
    <section class="section-box login-section">
      <h2>Specialist Login</h2>

      <form id="specialistLoginForm" method="post" action="javascript:void(0);">
        <label for="specLoginId">Username or Email</label>
        <input
          type="text"
          id="specLoginId"
          name="specLoginId"
          placeholder="e.g., jsmith or jsmith@clinic.com"
          required
        >

        <label for="specLoginPassword">Password</label>
        <input
          type="password"
          id="specLoginPassword"
          name="specLoginPassword"
          placeholder="Enter your password"
          required
        >

        <input type="submit" value="Sign In">
      </form>

      <div id="specLoginMsg" style="color:red; margin-top:10px;"></div>
      <div id="apiDiagnostics" style="margin-top:10px;font-size:0.9rem;color:#333"></div>

      <p class="note">
        Demo specialists:<br>
        <strong>jsmith / smith123</strong> ·
        <strong>ajones / jones123</strong> ·
        <strong>clee / lee123</strong>
      </p>
    </section>

    <!-- SPECIALIST INFO / CARDS -->
    <section class="section-box specialists-section">
      <h1>Meet Our Specialists</h1>
      <p>Our team of expert doctors provides personalized guidance to help you manage your diabetes effectively.</p>

      <div class="specialists">
        <div class="specialist-card">
          <img src="pics/smith.jpg" alt="Dr. John Smith">
          <h3>Dr. John Smith</h3>
          <p>Endocrinologist</p>
          <p>10+ years experience helping patients manage diabetes with personalized care plans.</p>
        </div>

        <div class="specialist-card">
          <img src="pics/jones.jpg" alt="Dr. Alex Jones">
          <h3>Dr. Alex Jones</h3>
          <p>Diabetes Specialist</p>
          <p>Expert in lifestyle modification, glucose monitoring, and diet planning.</p>
        </div>

        <div class="specialist-card">
          <img src="pics/lee.jpg" alt="Dr. Christina Lee">
          <h3>Dr. Christina Lee</h3>
          <p>Nutritionist &amp; Endocrinologist</p>
          <p>Helps patients balance diet, exercise, and medication for optimal glucose control.</p>
        </div>
      </div>
    </section>

    <!-- REVIEWS -->
    <section class="section-box reviews">
      <h2>What Patients Say About Our Specialists</h2>
      <div class="review-cards">
        <div class="review-card">
          <p>"Dr. Smith guided me through every step of my diabetes management. I feel more confident and in control."</p>
          <p class="review-author">— Emily R.</p>
        </div>
        <div class="review-card">
          <p>"Dr. Jones' advice on diet and lifestyle has made a huge difference in my daily routine."</p>
          <p class="review-author">— David M.</p>
        </div>
        <div class="review-card">
          <p>"Dr. Lee is approachable and provides detailed explanations for every question I have."</p>
          <p class="review-author">— Sophia L.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-bottom">
      <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
    </div>
  </footer>
<script>
// Config
// Use the same hostname the page was served from so CORS origin matches (dev convenience).
const API_BASE = `${window.location.protocol}//${window.location.hostname}:5000/api`;

// Specialist login handler — intercept form POST and call backend API
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('specialistLoginForm');
  const msg = document.getElementById('specLoginMsg');

  if (form) {
    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();
      msg.style.color = 'red';
      msg.textContent = '';

      const username = document.getElementById('specLoginId').value.trim();
      const password = document.getElementById('specLoginPassword').value;

      if (!username || !password) {
        msg.textContent = 'Username (or working_id/email) and password are required';
        return;
      }

      const payload = {
        // server accepts `username` or `email` and also `working_id`
        username: username,
        password: password
      };

      try {
        // Quick diagnostics: check backend health first to give a clearer error message
        try {
          const healthRes = await fetch(`${API_BASE.replace('/api','')}/health`, { method: 'GET' });
          if (!healthRes.ok) {
            msg.textContent = `API health check failed (status ${healthRes.status}) — check backend logs`;
            return;
          }
        } catch (healthErr) {
          console.warn('Backend health check failed', healthErr);
          msg.textContent = 'Cannot reach backend API. Are you running the backend? Check console/network for CORS or connectivity issues.';
          return;
        }

        // Use shared API wrapper if available (sets auth header automatically)
        // Otherwise use a fallback API base if diagnostics identified one.
        let data;
        let apiBaseToUse = API_BASE;
        if (window.BSM_API_FALLBACK) apiBaseToUse = window.BSM_API_FALLBACK;

        if (window.bsm_api && typeof window.bsm_api.specialistLogin === 'function') {
          try {
            data = await window.bsm_api.specialistLogin(username, password, { apiBase: apiBaseToUse });
          } catch (e) {
            msg.textContent = e.message || 'Login failed';
            return;
          }
        } else {
          // Fallback to direct fetch if api wrapper not loaded
          const res = await fetch(`${apiBaseToUse}/specialist/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            let body;
            try { body = await res.json(); } catch(e) { body = { message: res.statusText }; }
            msg.textContent = body.message || body.error || `Login failed (status ${res.status})`;
            return;
          }

          data = await res.json();
        }
        msg.style.color = 'green';
        msg.textContent = 'Login successful — redirecting...';

        // Store token and specialist info in localStorage for demo session handling
        if (data.token) {
          try {
            localStorage.setItem('bsm_token', data.token);
            localStorage.setItem('bsm_specialist', JSON.stringify(data.specialist || {}));
          } catch (e) {
            console.warn('Could not persist token to localStorage', e);
          }
        }

        // On success, redirect to specialist dashboard (if exists) or reload
        const spec = data.specialist || {};
        setTimeout(() => {
          if (spec.user_id) {
            // include token in query param for demo environments (optional)
            const url = new URL('specialist_dashboard.html', window.location.origin);
            url.searchParams.set('user_id', spec.user_id);
            if (data.token) url.searchParams.set('token', data.token);
            window.location.href = url.toString();
          } else {
            window.location.reload();
          }
        }, 700);

      } catch (err) {
        console.error('Specialist login error', err);
        msg.textContent = 'Login failed — network or server error: ' + (err.message || err);
      }
    });
  }
});

// Auto-login support for demo/testing: use `?autologin=jsmith` to auto-submit demo creds.
// Demo mapping (kept on client only for convenience in demo environment)
const DEMO_CREDS = {
  'jsmith': { username: 'jsmith', password: 'smith123' },
  'ajones': { username: 'ajones', password: 'jones123' },
  'clee': { username: 'clee', password: 'lee123' }
};

function tryAutoLogin() {
  try {
    const params = new URLSearchParams(window.location.search);
    const key = params.get('autologin');
    if (!key) return;
    const cred = DEMO_CREDS[key];
    if (!cred) return;

    // Fill form for visibility
    document.getElementById('specLoginId').value = cred.username;
    document.getElementById('specLoginPassword').value = cred.password;

    // Submit programmatically
    document.getElementById('specialistLoginForm').dispatchEvent(new Event('submit', { cancelable: true }));
  } catch (e) {
    console.error('Auto-login failed', e);
  }
}

// Attempt auto-login after DOMContent loaded
document.addEventListener('DOMContentLoaded', tryAutoLogin);

// Simple diagnostics UI to show backend health and headers
async function runApiDiagnostics() {
  const diag = document.getElementById('apiDiagnostics');
  diag.textContent = 'Checking API...';
  try {
    // Primary health endpoint (same host as page, port 5000)
    const healthUrl = `${API_BASE.replace('/api','')}/health`;
    let healthRes;
    try {
      healthRes = await fetch(healthUrl, { method: 'GET' });
    } catch (firstErr) {
      // If first attempt fails, we'll try a few fallbacks and provide
      // a helpful diagnostic message for common issues (CORS, mixed
      // content (HTTPS->HTTP), or unreachable host).
      const pageProto = window.location.protocol;
      const suggestions = [];

      // Mixed content: page served over HTTPS but backend URL is HTTP
      if (pageProto === 'https:' && healthUrl.startsWith('http:')) {
        diag.innerHTML = `<strong style="color:orange">Health check failed:</strong> The page is served over <strong>HTTPS</strong> while the backend is <strong>HTTP</strong>. Browsers block mixed content.\n` +
          `<div style="margin-top:6px">Try opening the page using <code>http://</code> (not https), or configure an HTTPS proxy for the backend.</div>`;
        return;
      }

      // Try explicit localhost/127.0.0.1 fallbacks (useful when hostname resolution differs)
      const fallbacks = [
        'http://127.0.0.1:5000/health',
        'http://localhost:5000/health'
      ];

      let fallbackOk = false;
      let fallbackHtml = '';
      let fallbackUrl = null;
      for (const f of fallbacks) {
        try {
          const r = await fetch(f, { method: 'GET' });
          if (r.ok) {
            const b = await r.text();
            fallbackHtml += `<div><strong>Fallback ${f}:</strong> ${r.status} ${r.statusText} <pre>${b}</pre></div>`;
            fallbackOk = true;
            fallbackUrl = f.replace(/\/health\/?$/, '');
            break;
          } else {
            fallbackHtml += `<div><strong>Fallback ${f}:</strong> ${r.status} ${r.statusText}</div>`;
          }
        } catch (e) {
          fallbackHtml += `<div><strong>Fallback ${f}:</strong> failed to fetch (${e.message})</div>`;
        }
      }

      let message = `<strong style="color:red">Health check failed: Failed to fetch</strong>`;
      message += `<div style="margin-top:8px">Common causes: backend not running, network/port not reachable, or browser blocking mixed content (HTTPS page → HTTP backend).</div>`;
      message += `<div style="margin-top:8px">Fallback checks:</div>${fallbackHtml}`;
      // If a fallback succeeded, expose it globally so other API calls
      // can use the reachable host (useful when page hostname differs
      // from localhost in remote/dev containers).
      if (fallbackOk && fallbackUrl) {
        window.BSM_API_FALLBACK = `${fallbackUrl}/api`;
        message += `<div style="margin-top:8px;color:green">Using fallback API base: <code>${window.BSM_API_FALLBACK}</code></div>`;
      }

      diag.innerHTML = message;
      return;
    }

    const headers = {};
    for (const [k, v] of healthRes.headers) headers[k] = v;
    const body = await healthRes.text();
    let html = `<strong>Health:</strong> ${healthRes.status} ${healthRes.statusText}<br>`;
    html += `<strong>Headers:</strong> <pre>${JSON.stringify(headers, null, 2)}</pre>`;
    html += `<strong>Body:</strong> <pre>${body}</pre>`;

    // Fetch server runtime mode (demo / DB availability) if available
    try {
      const modeRes = await fetch(`${API_BASE}/server/mode`, { method: 'GET' });
      if (modeRes.ok) {
        const mode = await modeRes.json();
        html += `<div style="margin-top:8px;"><strong>Server Mode:</strong> `;
        html += `<span style="font-weight:600;">` + (mode.demo_mode ? 'DEMO (DEMO_AUTH=1)' : 'NORMAL (DB preferred)') + `</span>`;
        html += ` &middot; <strong>DB available:</strong> <span id="dbAvailableIndicator" style="font-weight:600;color:${mode.db_available ? 'green' : 'red'}">${mode.db_available}</span></div>`;

        // Update visible banner for demo mode
        const banner = document.getElementById('serverModeBanner');
        if (banner) {
          if (mode.demo_mode) {
            banner.style.display = 'block';
          } else {
            banner.style.display = 'none';
          }
        }

      } else {
        html += `<div style="margin-top:8px;color:orange;"><strong>Server Mode:</strong> unavailable (status ${modeRes.status})</div>`;
      }
    } catch (e) {
      html += `<div style="margin-top:8px;color:red;"><strong>Server Mode:</strong> request failed (${e.message || e})</div>`;
    }

    diag.innerHTML = html;
  } catch (e) {
    diag.innerHTML = `<strong>Health check failed:</strong> ${e.message || e}`;
  }
}

// Poll server mode periodically so the UI updates when backend mode changes
setInterval(() => {
  try {
    // reuse diagnostics call to refresh banner and DB indicator; don't await
    runApiDiagnostics();
  } catch (e) {
    console.warn('Periodic diagnostics failed', e);
  }
}, 30000); // every 30s

// Run diagnostics on load so users can see CORS/connection info immediately
document.addEventListener('DOMContentLoaded', runApiDiagnostics);

// Fetch and render readings for a user (userId = 1)
async function loadUserReadings(userId = 1, days = 30) {
  try {
    const res = await fetch(`${API_BASE}/readings/${userId}?days=${days}`);
    if (!res.ok) {
      const err = await res.json().catch(()=>({message:res.statusText}));
      throw new Error(err.error || err.message || 'Failed to fetch readings');
    }
    const payload = await res.json();
    const readings = payload.readings || [];

    // Example: render into a container `.readings-list` (create this element in HTML)
    let container = document.querySelector('.readings-list');
    if (!container) {
      container = document.createElement('div');
      container.className = 'readings-list';
      document.querySelector('main.container').appendChild(container);
    }
    container.innerHTML = '';

    if (readings.length === 0) {
      container.textContent = 'No readings found.';
      return;
    }

    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';

    readings.forEach(r => {
      const li = document.createElement('li');
      li.style.padding = '12px 8px';
      li.style.borderBottom = '1px solid #eee';

      const dt = new Date(r.date_time);
      const dtStr = isNaN(dt) ? r.date_time : dt.toLocaleString();

      li.innerHTML = `
        <strong>${r.value} ${r.unit || 'mg/dL'}</strong>
        <div style="font-size:0.9rem;color:#666">${dtStr} · status: ${r.status || 'normal'}</div>
        <div style="font-size:0.9rem;color:#333;margin-top:6px">${r.food_intake || r.event || ''}</div>
      `;
      ul.appendChild(li);
    });

    container.appendChild(ul);

  } catch (err) {
    console.error('loadUserReadings error', err);
  }
}

// call on page load
document.addEventListener('DOMContentLoaded', function () {
  loadUserReadings(1, 30);
});
</script>


</body>
</html>
