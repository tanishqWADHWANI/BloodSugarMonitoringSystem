<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Details - Online Blood Sugar Monitor</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .logout-btn {
      background:#cc0000;
      border:none;
      border-radius:5px;
      padding:8px 12px;
      cursor:pointer;
      color:white;
    }
    .logout-btn:hover { background:#ff3333; }

    .container { max-width:1100px; margin:20px auto; padding:0 15px; }
    h1,h2,h3,h4,p { margin-bottom:10px; }

    .section-card {
      background:white;
      border-radius:8px;
      box-shadow:0 3px 8px rgba(0,0,0,0.1);
      padding:20px;
      margin-bottom:25px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
    }
    th, td {
      border:1px solid #ccc;
      padding:8px;
      text-align:left;
    }
    th {
      background:#004080;
      color:white;
    }

    .info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px,1fr));
      gap:10px;
    }
    .info-item {
      background:#f9f9f9;
      border:1px solid #ddd;
      border-radius:6px;
      padding:10px;
    }

    #comment-text {
      width:100%;
      padding:10px;
      border-radius:5px;
      border:1px solid #ccc;
      resize:vertical;
      min-height:80px;
    }
    #save-comment {
      margin-top:10px;
      padding:8px 15px;
      background:#004080;
      color:white;
      border:none;
      border-radius:5px;
      cursor:pointer;
    }
    #save-comment:hover { background:#0066cc; }
    #comment-list {
      list-style:none;
      padding:0;
      margin-top:10px;
    }
    #comment-list li {
      background:#f2f4f8;
      border-left:4px solid #004080;
      margin-bottom:8px;
      padding:8px;
      border-radius:4px;
    }

    footer {
      background:#004080;
      color:white;
      text-align:center;
      padding:10px;
      margin-top:40px;
    }
    .back-btn {
      background:#999;
      color:white;
      padding:8px 12px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      margin-bottom:15px;
    }
    .back-btn:hover { background:#777; }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="specialist_dashboard.html" class="active">Dashboard</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li style="margin-left:auto;">
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <button class="back-btn" onclick="window.location.href='specialist_dashboard.html'">
      &larr; Back to Dashboard
    </button>

    <h1>Patient: <span id="patientName"></span></h1>
    <p>Patient ID: <span id="patientNumber"></span></p>

    <!-- PERSONAL INFO -->
    <section class="section-card">
      <h2>Personal Information</h2>
      <div class="info-grid" id="personal-info">
        <!-- filled by JS -->
      </div>
    </section>

    <!-- HEALTH DATA -->
    <section class="section-card">
      <h2>Health Data History</h2>
      <table id="health-data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Blood Pressure</th>
            <th>Heart Rate</th>
            <th>Medications</th>
            <th>Food Time</th>
            <th>Food Taken</th>
            <th>Activity / Notes</th>
          </tr>
        </thead>
        <tbody>
          <!-- filled by JS -->
        </tbody>
      </table>
      <p id="health-msg" style="margin-top:10px; color:#666;"></p>
    </section>

    <!-- COMMENTS -->
    <section class="section-card">
      <h2>Specialist Comments</h2>
      <textarea id="comment-text" placeholder="Add a comment about this patient's readings..."></textarea>
      <button id="save-comment">Save Comment</button>

      <h3 style="margin-top:20px;">Previous Comments</h3>
      <ul id="comment-list"></ul>
      <p id="comment-msg" style="margin-top:10px; color:#666;"></p>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
  </footer>

<script>
  const API_BASE = 'http://127.0.0.1:5000';

  // ============================
  // CONTEXT FROM DASHBOARD
  // ============================
  const specialistId = localStorage.getItem('specialistId') || '3';
  const patientNumber = localStorage.getItem('viewingPatientNumber');
  const patientName = localStorage.getItem('viewingPatientName');
  const patientUserId = localStorage.getItem('viewingPatientUserId'); // users.user_id
  const patientId = localStorage.getItem('viewingPatientId');        // patients.patient_id

  if (!patientNumber || !patientName || !patientUserId || !patientId) {
    alert('No patient selected. Redirecting to dashboard...');
    window.location.href = 'specialist_dashboard.html';
  }

  const patientNumberSpan = document.getElementById('patientNumber');
  const patientNameSpan = document.getElementById('patientName');
  if (patientNumberSpan) patientNumberSpan.textContent = patientNumber;
  if (patientNameSpan) patientNameSpan.textContent = patientName;

  // ============================
  // LOAD READINGS
  // ============================
  const readingsBody = document.querySelector('#readings-table tbody');

  function renderReadings(readings) {
    if (!readingsBody) return;

    readingsBody.innerHTML = '';
    if (!readings || readings.length === 0) {
      readingsBody.innerHTML =
        '<tr><td colspan="5">No readings found for this patient.</td></tr>';
      return;
    }

    readings.forEach(r => {
      const tr = document.createElement('tr');

      const dt = r.date_time || r.dateTime || '';
      const datePart = dt ? String(dt).split('T')[0] : '';
      const timePart = dt && String(dt).includes('T')
        ? String(dt).split('T')[1].substring(0, 5)
        : '';

      tr.innerHTML = `
        <td>${datePart}</td>
        <td>${timePart}</td>
        <td>${r.value} ${r.unit || ''}</td>
        <td>${r.status || 'normal'}</td>
        <td>${r.food_intake || ''}</td>
      `;
      readingsBody.appendChild(tr);
    });
  }

  async function loadReadings() {
    if (!readingsBody) return;

    try {
      const res = await fetch(
        `${API_BASE}/api/readings/${patientUserId}?days=30`
      );
      if (!res.ok) {
        throw new Error(`Server responded ${res.status}`);
      }
      const data = await res.json();
      renderReadings(data.readings || []);
    } catch (err) {
      console.error('Error loading readings:', err);
      readingsBody.innerHTML =
        '<tr><td colspan="5">Error loading readings from server.</td></tr>';
    }
  }

  // ============================
  // LOAD COMMENTS (FEEDBACK)
  // ============================
  const commentList = document.getElementById('comment-list');

  function renderComments(feedback) {
    if (!commentList) return;

    commentList.innerHTML = '';
    if (!feedback || feedback.length === 0) {
      commentList.innerHTML = '<li>No comments yet.</li>';
      return;
    }

    feedback.forEach(fb => {
      const li = document.createElement('li');
      const author = fb.specialist_name || 'Specialist';
      const text = fb.feedback_text || '';
      const created =
        fb.createdAt || fb.created_at || fb.created_at || '';

      li.innerHTML = `
        <strong>${author}:</strong> ${text}
        <br><small>${created}</small>
      `;
      commentList.appendChild(li);
    });
  }

  async function loadComments() {
    if (!commentList) return;

    try {
      const res = await fetch(
        `${API_BASE}/api/patient/${patientId}/feedback`
      );
      if (!res.ok) {
        throw new Error(`Server responded ${res.status}`);
      }
      const data = await res.json();
      renderComments(data.feedback || []);
    } catch (err) {
      console.error('Error loading comments:', err);
      commentList.innerHTML = '<li>Error loading comments from server.</li>';
    }
  }

  // ============================
  // SAVE NEW COMMENT
  // ============================
  const commentText = document.getElementById('comment-text');
  const saveCommentBtn = document.getElementById('save-comment');

  if (saveCommentBtn) {
    saveCommentBtn.addEventListener('click', async () => {
      const text = (commentText?.value || '').trim();
      if (!text) {
        alert('Please enter a comment before saving.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/specialist/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            specialistId: parseInt(specialistId, 10),
            // Backend expects data.patientId to be user_id, and it maps to patient
            patientId: parseInt(patientUserId, 10),
            feedbackText: text,
            readingId: null
          })
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Failed to save feedback');
        }

        alert('Feedback saved successfully.');
        if (commentText) commentText.value = '';
        loadComments();
      } catch (err) {
        console.error('Error saving feedback:', err);
        alert(err.message || 'Error saving feedback.');
      }
    });
  }

  // ============================
  // INITIAL LOAD
  // ============================
  loadReadings();
  loadComments();

  // ============================
  // LOGOUT
  // ============================
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('specialistUsername');
      localStorage.removeItem('specialistFullName');
      localStorage.removeItem('specialistSpecialty');
      localStorage.removeItem('specialistId');
      window.location.href = 'specialist.html';
    });
  }
</script>

</body>
</html>
