<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/dasshboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/demo_users.js"></script>
</head>

<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                
                <li><a href="clinic.html">Clinic</a></li>
                <li><button id="logoutBtn" class="logout-btn">Logout</button></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section class="dashboard-header">
            <h1>Administrator – User Management & Reports</h1>
            <p class="subtext">
                Create and manage users, assign patients to specialists, and view a simple operational report.
            </p>
        </section>

        <section class="card">
            <h2>Create User</h2>
            <form id="createUserForm" class="form-grid" autocomplete="off">
                <div class="form-row">
                    <div class="form-field">
                        <label for="firstName">First name</label>
                        <input id="firstName" type="text" placeholder="e.g. Alice" required />
                    </div>
                    <div class="form-field">
                        <label for="lastName">Last name</label>
                        <input id="lastName" type="text" placeholder="e.g. Lee" required />
                    </div>
                    <div class="form-field">
                        <label for="email">Email</label>
                        <input id="email" type="email" placeholder="name@example.com" required autocomplete="off" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label for="password">Password</label>
                        <input id="password" type="password" placeholder="Choose a secure password" required />
                    </div>
                    <div class="form-field">
                        <label for="phone">Phone</label>
                        <input id="phone" type="tel" placeholder="+1 555 100 001" required />
                    </div>
                    <div class="form-field">
                        <label for="dob">Date of birth</label>
                        <input id="dob" type="date" placeholder="yyyy-mm-dd" required />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field" id="workingIdContainer" style="display: none;">
                        <label for="workingId">Working ID</label>
                        <input id="workingId" placeholder="Required for Specialist/Staff" />
                    </div>
                    <div class="form-field">
                        <label for="role">Role</label>
                        <select id="role" required>
                            <option value="patient">Patient</option>
                            <option value="specialist">Specialist</option>
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field" style="flex-basis:100%">
                        <label for="imageUrl">Profile Image URL (optional)</label>
                        <input id="imageUrl" type="url" placeholder="https://example.com/photo.jpg" />
                        <div class="muted" style="margin-top:6px">Optional — shown on patient cards and reports.</div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn">Create</button>
                    <button type="button" id="seedDemoBtn" class="secondary btn">Seed Demo Users</button>
                </div>
            </form>
        </section>

        <section class="card">
            <h2>Thresholds</h2>
            <p>Manage system and per-user thresholds for blood sugar alerts.</p>
            <div class="form-actions"><a class="btn" href="thresholds.html">Open Thresholds</a></div>
        </section>

        <section class="card">
            <h2>Users</h2>
            <div class="table-wrapper">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>DOB</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="card">
            <h2>Assign Patient to Specialist</h2>
            <form id="assignForm" class="form-grid">
                <div class="form-row">
                    <div class="form-field">
                        <label for="patientSelect">Patient</label>
                        <select id="patientSelect"></select>
                    </div>
                    <div class="form-field">
                        <label for="specialistSelect">Specialist</label>
                        <select id="specialistSelect"></select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">Assign</button>
                </div>
            </form>

            <h3 style="margin-top:12px">Current Assignments</h3>
            <div class="table-wrapper">
                <table id="assignTable">
                    <thead>
                        <tr>
                            <th>Assignment ID</th>
                            <th>Patient</th>
                            <th>Specialist</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="card">
            <h2>Simple Report</h2>
            <p class="hint">
                Based on users and readings from the last 7 days. Status is computed using thresholds
                (SystemDefault or overrides if present). Defaults: Normal ≤ <b>130</b>, Borderline ≤ <b>180</b>,
                Abnormal otherwise; AbnormalLow default <b>70</b>.
            </p>
            <div id="reportArea">
                <ul>
                    <li>Total users: <strong id="totalUsers">0</strong></li>
                    <li>By role — Patients: <strong id="countPatients">0</strong>,
                        Specialists: <strong id="countSpecialists">0</strong>,
                        Staff: <strong id="countStaff">0</strong>,
                        Admins: <strong id="countAdmins">0</strong></li>
                    <li>Assignments — Patients assigned: <strong id="assignedPatients">0</strong>,
                        Unassigned: <strong id="unassignedPatients">0</strong></li>
                    <li>Readings last 7 days — Total: <strong id="r7Total">0</strong>,
                        <span style="color:#b91c1c">Abnormal</span>:
                        <strong id="r7Abnormal">0</strong> (<strong id="r7AbnormalPct">0%</strong>)
                    </li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" id="recalcBtn">Recalculate</button>
                <button type="button" id="exportBtn" class="secondary">Export JSON</button>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-bottom">
            <p>&copy; 2025 Online Blood Sugar Monitoring Clinic. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // =========================================================================
        // ADMIN DASHBOARD - Single Script Block
        // =========================================================================

        // Global State
        let USERS_CACHE = [];
        const ASSIGN_KEY = 'assignments';

        // Element References
        let createForm, usersTableBody, assignForm, patientSelect, specialistSelect, assignTableBody;
        let elTotalUsers, elCP, elCS, elCSt, elCA, elAssigned, elUnassigned, elR7Total, elR7Abn, elR7Pct;
        let roleSelect, workingIdContainer;

        // ===== Utility Functions =====
        
        
        function loadAssignments() {
            try { return JSON.parse(localStorage.getItem(ASSIGN_KEY) || '[]'); }
            catch { return []; }
        }

        function saveAssignments(arr) {
            localStorage.setItem(ASSIGN_KEY, JSON.stringify(arr));
        }

        // ===== API Functions =====
        async function fetchUsersFromAPI() {
            try {
                const response = await getAllUsers();
                USERS_CACHE = response.users || [];
                if (!USERS_CACHE || USERS_CACHE.length === 0) {
                    // fallback to demo users if API returns empty
                    USERS_CACHE = [
                        { user_id: 1, first_name: 'Alice', last_name: 'Lee', email: 'alice@example.com', phone: '+1 555 100 001', date_of_birth: '1985-04-12', role: 'patient' },
                        { user_id: 2, first_name: 'Bob', last_name: 'Ray', email: 'bob@example.com', phone: '+1 555 100 002', date_of_birth: '1978-09-03', role: 'patient' },
                        { user_id: 3, first_name: 'Dr. Christina', last_name: 'Lee', email: 'clee@clinic', phone: '+1 555 200 003', date_of_birth: '1975-01-15', role: 'specialist' },
                        { user_id: 4, first_name: 'Staff', last_name: 'Member', email: 'staff@clinic', phone: '+1 555 300 004', date_of_birth: '1990-06-20', role: 'staff' },
                        { user_id: 5, first_name: 'Admin', last_name: 'User', email: 'admin@clinic', phone: '+1 555 400 005', date_of_birth: '1980-02-28', role: 'admin' }
                    ];
                }
                return USERS_CACHE;
            } catch (e) {
                console.error("Failed to fetch users from API:", e);
                // fallback to offline demo users
                USERS_CACHE = [
                    { user_id: 1, first_name: 'Alice', last_name: 'Lee', email: 'alice@example.com', phone: '+1 555 100 001', date_of_birth: '1985-04-12', role: 'patient' },
                    { user_id: 2, first_name: 'Bob', last_name: 'Ray', email: 'bob@example.com', phone: '+1 555 100 002', date_of_birth: '1978-09-03', role: 'patient' },
                    { user_id: 101, first_name: 'Dr. John', last_name: 'Smith', email: 'jsmith@demo', phone: '+1 555 200 010', date_of_birth: '1970-11-11', role: 'specialist' },
                    { user_id: 102, first_name: 'Dr. Alex', last_name: 'Jones', email: 'ajones@demo', phone: '+1 555 200 011', date_of_birth: '1972-03-22', role: 'specialist' },
                    { user_id: 3, first_name: 'Dr. Christina', last_name: 'Lee', email: 'clee@clinic', phone: '+1 555 200 003', date_of_birth: '1975-01-15', role: 'specialist' },
                    { user_id: 4, first_name: 'Staff', last_name: 'Member', email: 'staff@clinic', phone: '+1 555 300 004', date_of_birth: '1990-06-20', role: 'staff' },
                    { user_id: 5, first_name: 'Admin', last_name: 'User', email: 'admin@clinic', phone: '+1 555 400 005', date_of_birth: '1980-02-28', role: 'admin' }
                ];
                return USERS_CACHE;
            }
        }

        // ===== Render Functions =====
        async function renderUsers() {
            let users = USERS_CACHE.length ? USERS_CACHE : await fetchUsersFromAPI();

            // Merge patients from localStorage.patients (support both array and map formats)
            try {
                const raw = localStorage.getItem('patients');
                if (raw) {
                    let localPatients = JSON.parse(raw);
                    // If stored as an object map keyed by email, convert to array
                    if (localPatients && !Array.isArray(localPatients) && typeof localPatients === 'object') {
                        localPatients = Object.values(localPatients || {});
                    }
                    if (Array.isArray(localPatients) && localPatients.length > 0) {
                        // Convert local patient entries into the user shape expected by admin dashboard
                        const converted = localPatients.map((p, idx) => ({
                            user_id: p.user_id || p.id || (p.email ? ('local_' + (p.email)) : ('local_' + idx)),
                            first_name: p.name ? String(p.name).split(' ')[0] : (p.fullName || p.first_name || ''),
                            last_name: p.name ? String(p.name).split(' ').slice(1).join(' ') : (p.lastName || p.last_name || ''),
                            email: p.email || (p.phone ? ('patient+' + (p.number || p.id || idx) + '@local') : ('patient' + idx + '@local')),
                            phone: p.phone || p.contact || p.phone_number || p.phone || '',
                            date_of_birth: p.dob || p.date_of_birth || '',
                            role: 'patient'
                        }));

                            // Merge without duplicates (by email, name or id)
                            users = Array.isArray(users) ? users.slice() : [];
                            const existingEmails = new Set(users.map(u => (u.email || '').toLowerCase()));
                            const existingNames = new Set(users.map(u => (((u.first_name || '') + ' ' + (u.last_name || '')).trim() || '').toLowerCase()));
                            const existingIds = new Set(users.map(u => String(u.user_id || u.id || '').toLowerCase()));
                            converted.forEach(c => {
                                const cEmail = (c.email||'').toLowerCase();
                                const cName = (((c.first_name||'') + ' ' + (c.last_name||'')).trim() || '').toLowerCase();
                                const cId = String(c.user_id || '').toLowerCase();
                                if (existingEmails.has(cEmail) || (cName && existingNames.has(cName)) || (cId && existingIds.has(cId))) {
                                    // skip duplicate
                                    return;
                                }
                                users.push(c);
                                existingEmails.add(cEmail);
                                if (cName) existingNames.add(cName);
                                if (cId) existingIds.add(cId);
                            });
                    }
                }
            } catch (e) {
                console.warn('Could not merge local patients into users list', e);
            }

            // helper escape to avoid HTML injection from stored data
            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g, function(c){
                    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];
                });
            }

            usersTableBody.innerHTML = users.map(u => {
                const name = `${u.first_name || ''} ${u.last_name || ''}`.trim();
                const email = u.email || '';
                const phone = u.phone || '';
                const dob = u.date_of_birth || '';
                const role = (u.role || '').toLowerCase();
                // render each field into its own column so columns align with the header
                return `
                <tr>
                    <td style="white-space:nowrap;font-weight:600">${escapeHtml(String(u.user_id))}</td>
                    <td style="padding:8px 12px">${escapeHtml(name || '—')}</td>
                    <td style="padding:8px 12px;color:#666;font-size:0.95rem">${escapeHtml(email)}</td>
                    <td style="white-space:nowrap;padding:8px 12px">${escapeHtml(phone || 'N/A')}</td>
                    <td style="white-space:nowrap;padding:8px 12px">${escapeHtml(dob)}</td>
                    <td style="padding:8px 12px">${escapeHtml(role)}</td>
                    <td style="white-space:nowrap;color:green;font-weight:600;padding:8px 12px">Active</td>
                    <td style="white-space:nowrap;padding:8px 12px">
                        <button type="button" class="btn-sm btn-delete" data-id="${escapeHtml(String(u.user_id))}">Delete</button>
                    </td>
                </tr>`;
            }).join('');

            const patients = users.filter(u => u.role === 'patient');
            const specialists = users.filter(u => u.role === 'specialist');

            patientSelect.innerHTML = patients.map(p => {
                const label = `${p.first_name || ''} ${p.last_name || ''}`.trim() || (p.email || p.user_id);
                return `<option value="${escapeHtml(String(p.user_id))}">${escapeHtml(label)} ${p.number ? ('(' + escapeHtml(p.number) + ')') : ''} ${p.email ? ('<' + escapeHtml(p.email) + '>') : ''}</option>`;
            }).join('');
            specialistSelect.innerHTML = specialists.map(s => `
                <option value="${escapeHtml(String(s.user_id))}">${escapeHtml((s.first_name || '') + ' ' + (s.last_name || '')).trim()} (${escapeHtml(s.email || '')})</option>
            `).join('');
        }

        function renderAssignments() {
            const users = USERS_CACHE || [];
            let assigns = loadAssignments() || [];

            // Sync assignments from patient records in localStorage (e.g., patient.assigned_specialist or specialist_id)
            try {
                const raw = localStorage.getItem('patients');
                if (raw) {
                    let localPatients = JSON.parse(raw);
                    if (localPatients && !Array.isArray(localPatients) && typeof localPatients === 'object') localPatients = Object.values(localPatients || {});
                    if (Array.isArray(localPatients)) {
                        localPatients.forEach(p => {
                            // possible specialist references in patient record
                            const specRef = (p.assigned_specialist && (p.assigned_specialist.id || p.assigned_specialist.user_id)) || p.specialist_id || p.specialistId || p.specialist || null;
                            if (!specRef) return;

                            // Resolve patient id to a consistent id to store in assignments
                            const patientIdVal = p.user_id || p.userId || p.patientId || p.patient_id || p.id || p.number || null;
                            if (!patientIdVal) return;

                            // Try to resolve specialist id to a numeric user_id if possible (search USERS_CACHE)
                            const specUser = users.find(u => String(u.user_id) === String(specRef) || String(u.id) === String(specRef) || (u.email && String(u.email).toLowerCase() === String(specRef).toLowerCase()) || ((u.first_name||'') + ' ' + (u.last_name||'')).toLowerCase().includes(String(specRef).toLowerCase()));
                            const specIdVal = specUser ? (specUser.user_id || specUser.id) : specRef;

                            // If an assignment for this patient already exists, update specialistId if different
                            const existing = assigns.find(a => String(a.patientId) === String(patientIdVal));
                            if (existing) {
                                if (String(existing.specialistId) !== String(specIdVal)) {
                                    existing.specialistId = specIdVal;
                                }
                            } else {
                                assigns.push({ id: Date.now().toString() + Math.floor(Math.random()*1000), patientId: patientIdVal, specialistId: specIdVal });
                            }
                        });
                        // persist any changes
                        saveAssignments(assigns);
                    }
                }
            } catch (e) { /* ignore sync errors */ }

            // helper escape to avoid HTML injection
            function escapeHtml(s) {
                return String(s || '').replace(/[&<>'"]/g, function(c){
                    return {'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','\"':'&quot;'}[c];
                });
            }

            // Helper: try to resolve a user (patient/specialist) by several sources and return HTML
            function resolveUserLabel(idOrVal, roleHint) {
                if (idOrVal === null || idOrVal === undefined) return '—';
                // 1) match by user_id in USERS_CACHE
                const byId = users.find(u => String(u.user_id) === String(idOrVal) || String(u.id) === String(idOrVal));
                if (byId) return `<div style="font-weight:600">${escapeHtml(((byId.first_name || '') + ' ' + (byId.last_name || '')).trim() || byId.email || '')}</div><div style="font-size:0.85rem;color:#666">${escapeHtml(byId.email || '')}</div>`;

                // 2) if patients cached in localStorage (array or map), try to find by patientId / number / id / email
                try {
                    const raw = localStorage.getItem('patients');
                    if (raw) {
                        let localPatients = JSON.parse(raw);
                        if (localPatients && !Array.isArray(localPatients) && typeof localPatients === 'object') localPatients = Object.values(localPatients || {});
                        if (Array.isArray(localPatients)) {
                            const p = localPatients.find(x => String(x.patientId) === String(idOrVal) || String(x.id) === String(idOrVal) || String(x.number) === String(idOrVal) || String(x.email) === String(idOrVal) || String((x.name||'')).toLowerCase().includes(String(idOrVal).toLowerCase()));
                            if (p) return `<div style="font-weight:600">${escapeHtml(p.name || p.fullName || p.first_name || '')}</div><div style="font-size:0.85rem;color:#666">${escapeHtml(p.email || p.number || p.id || '')}</div>`;
                        }
                    }
                } catch (e) { /* ignore */ }

                // 3) try to resolve from specialists cache in localStorage
                try {
                    const rawSpecs = JSON.parse(localStorage.getItem('specialists') || '[]');
                    if (Array.isArray(rawSpecs)) {
                        const s = rawSpecs.find(s => String(s.id) === String(idOrVal) || String(s.user_id) === String(idOrVal) || String(s.username) === String(idOrVal) || String(s.email) === String(idOrVal));
                        if (s) return `<div style="font-weight:600">${escapeHtml(s.full_name || s.name || s.username || '')}</div><div style="font-size:0.85rem;color:#666">${escapeHtml(s.email || '')}</div>`;
                    }
                } catch (e) { /* ignore */ }

                // final fallback: raw value
                return escapeHtml(String(idOrVal));
            }

            assignTableBody.innerHTML = assigns.map(a => `
                <tr>
                    <td style="white-space:nowrap;padding:8px 12px">${escapeHtml(String(a.id))}</td>
                    <td style="padding:8px 12px">${resolveUserLabel(a.patientId, 'patient')}</td>
                    <td style="padding:8px 12px">${resolveUserLabel(a.specialistId, 'specialist')}</td>
                    <td style="white-space:nowrap;padding:8px 12px"><button type="button" class="remove-assign" data-id="${escapeHtml(String(a.id))}">Remove</button></td>
                </tr>
            `).join('');
        }

        async function renderReport() {
            const users = USERS_CACHE;
            const assigns = loadAssignments();

            const now = new Date();
            const year = now.getFullYear();
            const currentMonth = `${year}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            try {
                const reportData = await getAdminMonthlyReport(currentMonth, year);

                const allPatientStats = reportData.patient_statistics || [];

                elTotalUsers.textContent = users.length;
                elCP.textContent = users.filter(u => u.role === 'patient').length;
                elCS.textContent = users.filter(u => u.role === 'specialist').length;
                elCSt.textContent = users.filter(u => u.role === 'staff').length;
                elCA.textContent = users.filter(u => u.role === 'admin').length;

                const patients = users.filter(u => u.role === 'patient');
                const assignedSet = new Set(assigns.map(a => a.patientId));
                const assignedCount = patients.filter(p => assignedSet.has(p.user_id)).length;
                elAssigned.textContent = assignedCount;
                elUnassigned.textContent = Math.max(0, patients.length - assignedCount);

                

                // Calculate global totals from the list of patient statistics
                const totalReadings = allPatientStats.reduce((sum, p) => sum + (p.total_readings || 0), 0);
                const totalAbnormal = allPatientStats.reduce((sum, p) => sum + (p.abnormal_count || 0), 0);

                elR7Total.textContent = totalReadings;
                elR7Abn.textContent = totalAbnormal;
                elR7Pct.textContent = totalReadings > 0 
                    ? Math.round((totalAbnormal / totalReadings) * 100) + '%' 
                    : '0%';

            } catch (error) {
                console.error("Failed to load report from backend:", error);
                elR7Total.textContent = elR7Abn.textContent = '0';
                elR7Pct.textContent = '0%';
            }
        }

        // ===== Event Handlers =====
        async function handleCreateUser(e) {
            e.preventDefault();

            const role = document.getElementById('role').value;

            const payload = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value.trim(),
                role: role,
                phone: document.getElementById('phone').value.trim(),
                dateOfBirth: document.getElementById('dob').value,
            };

            if (role === 'specialist' || role === 'staff') {
                const workingId = document.getElementById('workingId').value.trim();
                if (!workingId) {
                    alert(`Working ID is required for role: ${role}`);
                    return;
                }
                payload.workingId = workingId;
            }

            try {
                const response = await apiRequest('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                alert(`User created successfully! ID: ${response.userId}`);

                createForm.reset();
                await fetchUsersFromAPI();
                await renderUsers();
                await renderReport();
            } catch (error) {
                console.error("User creation failed:", error);
                alert('Error creating user: ' + error.message);
            }
        }

        function handleAssignSubmit(e) {
            e.preventDefault();
            // Allow string or numeric IDs — patient IDs may be non-numeric (local/demo keys)
            const patientId = (patientSelect && patientSelect.value) ? String(patientSelect.value) : null;
            const specialistId = (specialistSelect && specialistSelect.value) ? String(specialistSelect.value) : null;
            if (!patientId || !specialistId) return;

            const assigns = loadAssignments();
            // remove previous assignment for the same patient (compare as strings)
            const rest = assigns.filter(a => String(a.patientId) !== String(patientId));
            rest.push({ id: Date.now().toString(), patientId, specialistId });
            saveAssignments(rest);
            renderAssignments();
            renderReport();
            alert('Assigned (Local).');
        }

        function handleRemoveAssignment(e) {
            const btn = e.target.closest('.remove-assign');
            if (!btn) return;
            const id = Number(btn.dataset.id);
            const left = loadAssignments().filter(a => a.id !== id);
            saveAssignments(left);
            renderAssignments();
            renderReport();
        }

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind Elements
            createForm = document.getElementById('createUserForm');
            usersTableBody = document.querySelector('#usersTable tbody');
            assignForm = document.getElementById('assignForm');
            patientSelect = document.getElementById('patientSelect');
            specialistSelect = document.getElementById('specialistSelect');
            assignTableBody = document.querySelector('#assignTable tbody');

            elTotalUsers = document.getElementById('totalUsers');
            elCP = document.getElementById('countPatients');
            elCS = document.getElementById('countSpecialists');
            elCSt = document.getElementById('countStaff');
            elCA = document.getElementById('countAdmins');
            elAssigned = document.getElementById('assignedPatients');
            elUnassigned = document.getElementById('unassignedPatients');
            elR7Total = document.getElementById('r7Total');
            elR7Abn = document.getElementById('r7Abnormal');
            elR7Pct = document.getElementById('r7AbnormalPct');

            roleSelect = document.getElementById('role');
            workingIdContainer = document.getElementById('workingIdContainer');

            // Working ID Visibility Logic
            if (roleSelect && workingIdContainer) {
                roleSelect.addEventListener('change', (e) => {
                    const role = e.target.value;
                    if (role === 'specialist' || role === 'staff') {
                        workingIdContainer.style.display = 'block';
                        document.getElementById('workingId').setAttribute('required', 'required');
                    } else {
                        workingIdContainer.style.display = 'none';
                        document.getElementById('workingId').removeAttribute('required');
                    }
                });
            }

            // Event Listeners
            if (createForm) createForm.addEventListener('submit', handleCreateUser);
            if (assignForm) assignForm.addEventListener('submit', handleAssignSubmit);
            if (assignTableBody) assignTableBody.addEventListener('click', handleRemoveAssignment);

            const recalcBtn = document.getElementById('recalcBtn');
            if (recalcBtn) recalcBtn.addEventListener('click', renderReport);

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('loggedInAdmin');
                    window.location.href = 'index.html';
                });
            }

            // Initial Load
                // Clear any stray autocomplete or demo values in the form fields
                try {
                    const emailEl = document.getElementById('email');
                    if (emailEl) {
                        emailEl.value = '';
                        emailEl.setAttribute('autocomplete', 'off');
                    }
                    const formEl = document.getElementById('createUserForm');
                    if (formEl) formEl.setAttribute('autocomplete', 'off');
                } catch (e) { /* ignore */ }

                await fetchUsersFromAPI();
                renderUsers();
                renderAssignments();
                renderReport();

                // Seed Demo button: re-run demo seeder and refresh UI
                try {
                    const seedBtn = document.getElementById('seedDemoBtn');
                    if (seedBtn) seedBtn.addEventListener('click', async () => {
                        try {
                            // Re-run demo seeder if available
                            if (window.demo_users_seed) {
                                try { window.demo_users_seed(); } catch(e){}
                            } else {
                                // fallback: run the file by creating a script tag (safe in preview)
                                const s = document.createElement('script');
                                s.src = 'js/demo_users.js';
                                document.head.appendChild(s);
                            }
                        } catch (e) { console.warn('Seed demo failed', e); }
                        await fetchUsersFromAPI(); renderUsers(); renderAssignments(); renderReport();
                    });
                } catch (e) { /* ignore */ }

            // Show alert if a new patient was registered (from create_account)
            try {
                const notifyRaw = localStorage.getItem('admin_patient_notify');
                if (notifyRaw) {
                    const n = JSON.parse(notifyRaw);
                    if (n && n.name) {
                        if (confirm(`New patient registered: ${n.name} (${n.email}).\nOpen Patient Records?`)) {
                            // clear notify and open patient records
                            localStorage.removeItem('admin_patient_notify');
                            window.location.href = 'patient_records.html';
                        }
                    }
                }
            } catch (e) { console.warn('admin notify check failed', e); }
        });
    </script>
</body>

</html>